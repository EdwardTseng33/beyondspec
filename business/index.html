<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ç§»å‹•åŸå ¡æŒ‡æ®éƒ¨ â€” CRM Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>
<script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body style="margin:0;background:#0f172a">
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useCallback, useMemo, useRef } = React;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ° ç§»å‹•åŸå ¡æ¥­å‹™æŒ‡æ® Dashboard v1.08
// Beyond Spec è¦æ ¼å¤–å·¥ä½œå®¤ â€” æ¥­å‹™ç®¡ç†ç³»çµ±
//
// åŠŸèƒ½æ¨¡çµ„ï¼š
// ğŸ“Š æ¥­å‹™æ¼æ–— â€” æ¡ˆä»¶éšæ®µç®¡ç† + æ‹–æ‹‰ç§»å‹• + è©³æƒ…ç·¨è¼¯
// ğŸ“‹ ä»»å‹™çœ‹æ¿ â€” å¾…è¾¦/é€²è¡Œä¸­/å·²å®Œæˆ + æœå°‹ç¯©é¸
// ğŸ¯ BD é–‹ç™¼ â€” æ½›åœ¨å®¢æˆ¶è¿½è¹¤ + æ¸ é“ç®¡ç†
// ğŸ“ˆ æ•¸æ“šåˆ†æ â€” æœˆ/å­£/å¹´ç›®æ¨™é”æˆåº¦ + å¯è‡ªè¨‚ç›®æ¨™
// ğŸ“ æ–‡ä»¶è³‡æº â€” ç¯„æœ¬åº« + è‡ªè¨‚æ–‡ä»¶ç®¡ç†ï¼ˆGoogle Drive / Dropboxï¼‰
// ğŸ‘¥ è§’è‰²ç®¡ç† â€” åŸå ¡äº”ä½å¤¥ä¼´ + è‡ªè¨‚è§’è‰²
// ğŸ° æ™ºæ…§æ™¨å ± â€” æ¯æ—¥æ‘˜è¦ + åœæ»¯æ¡ˆä»¶è­¦ç¤º
// ğŸ’¡ æ¡ˆä»¶åŠ©æ‰‹ â€” å»ºè­°ä»»å‹™ + Email æ¨¡æ¿ + å¥åº·åº¦æŒ‡æ¨™
// â˜ï¸ é›²ç«¯åŒæ­¥ â€” Google Sheets å¾Œç«¯ + å¤šå¸³è™Ÿéš”é›¢
// ğŸ” Google Sign-In â€” OAuth 2.0 ç™»å…¥
// âŒ¨ï¸ æŒ‡ä»¤é¢æ¿ â€” Cmd+K å¿«é€Ÿæ“ä½œ
// ğŸ“œ æ´»å‹•ç´€éŒ„ â€” æ“ä½œæ­·å²è¿½è¹¤
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Data Layer â€” localStorage + Google Sheets API (Route C)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const API_URL = "https://script.google.com/macros/s/AKfycbyzmgzpzVtlIQeKnDhBQocVRDpxGxlSZvBGLgTy4aEl8yL5A6lwV2-qfO2n8IM96GU4/exec";
const GOOGLE_CLIENT_ID = "870408555328-8vg2runp456id06aeen8vcplfbhl8c60.apps.googleusercontent.com";

// localStorage helper â€” user-scoped for multi-tenant isolation
const ls = {
  _uid: () => { try { const u = JSON.parse(localStorage.getItem("castle_user")); return u?.email ? u.email.replace(/[^a-zA-Z0-9]/g, "_") : "guest"; } catch { return "guest"; } },
  get: (key, fallback) => { try { const v = localStorage.getItem(`castle_${ls._uid()}_${key}`); return v ? JSON.parse(v) : fallback; } catch { return fallback; } },
  set: (key, val) => { try { localStorage.setItem(`castle_${ls._uid()}_${key}`, JSON.stringify(val)); } catch {} },
  getUser: () => { try { const v = localStorage.getItem("castle_user"); return v ? JSON.parse(v) : null; } catch { return null; } },
  setUser: (u) => { try { localStorage.setItem("castle_user", JSON.stringify(u)); } catch {} },
};

// API caller (fire-and-forget for writes, await for reads)
const api = {
  get: async (action, userId) => {
    if (!API_URL) return null;
    try {
      const res = await fetch(`${API_URL}?action=${action}&userId=${encodeURIComponent(userId)}`);
      const json = await res.json();
      return json.ok ? json.data : null;
    } catch { return null; }
  },
  post: async (action, userId, data) => {
    if (!API_URL) return null;
    try {
      const res = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ action, userId, data }),
      });
      const json = await res.json();
      return json.ok ? json.data : null;
    } catch { return null; }
  },
};

// Persist hook â€” saves to localStorage on every change, syncs to API
const usePersisted = (key, initial) => {
  const [val, setVal] = useState(() => ls.get(key, initial));
  useEffect(() => { ls.set(key, val); }, [val]);
  return [val, setVal];
};

// â”€â”€ Responsive Hook â”€â”€
const useWindowSize = () => {
  const [w, setW] = useState(typeof window !== "undefined" ? window.innerWidth : 1200);
  useEffect(() => {
    const h = () => setW(window.innerWidth);
    window.addEventListener("resize", h);
    return () => window.removeEventListener("resize", h);
  }, []);
  return { w, mobile: w < 640, tablet: w < 1024, desktop: w >= 1024 };
};

// â”€â”€ Colors â”€â”€
const C = {
  bg: "#08080c", surface: "#111118", card: "#16161f", cardHover: "#1c1c28",
  border: "rgba(255,255,255,.08)", borderHover: "rgba(255,255,255,.18)",
  ink: "#e8e8f0", inkSoft: "rgba(255,255,255,.65)", inkMuted: "rgba(255,255,255,.38)",
  accent: "#6C8EFF", accentSoft: "rgba(108,142,255,.12)",
  gold: "#F5A623", goldSoft: "rgba(245,166,35,.12)",
  emerald: "#34D399", emeraldSoft: "rgba(52,211,153,.12)",
  rose: "#F472B6", roseSoft: "rgba(244,114,182,.12)",
  violet: "#A78BFA", violetSoft: "rgba(167,139,250,.12)",
  cyan: "#22D3EE", cyanSoft: "rgba(34,211,238,.12)",
  orange: "#FB923C", orangeSoft: "rgba(251,146,60,.12)",
  glow: (c) => `0 0 20px ${c}30, 0 4px 16px rgba(0,0,0,.3)`,
};

// â”€â”€ Constants â”€â”€
const STAGES = [
  { id: "inquiry", label: "æ´½è©¢ä¸­", color: C.cyan, icon: "ğŸ“¥" },
  { id: "exploring", label: "æ¢ç´¢æœƒè­°", color: C.accent, icon: "ğŸ—“" },
  { id: "proposal", label: "ææ¡ˆä¸­", color: C.gold, icon: "ğŸ“‹" },
  { id: "negotiation", label: "è­°åƒ¹ä¸­", color: C.orange, icon: "ğŸ¤" },
  { id: "won", label: "å·²ç°½ç´„", color: C.emerald, icon: "ğŸ‰" },
  { id: "lost", label: "æœªæˆæ¡ˆ", color: C.rose, icon: "â€”" },
];

const TASK_STATUS = [
  { id: "todo", label: "å¾…è¾¦", color: C.cyan, icon: "ğŸ“‹" },
  { id: "doing", label: "é€²è¡Œä¸­", color: C.gold, icon: "ğŸ”¥" },
  { id: "done", label: "å·²å®Œæˆ", color: C.emerald, icon: "âœ…" },
];

const PRIORITY = [
  { id: "high", label: "é«˜", color: C.rose, icon: "ğŸ”´" },
  { id: "mid", label: "ä¸­", color: C.gold, icon: "ğŸŸ¡" },
  { id: "low", label: "ä½", color: C.inkMuted, icon: "âšª" },
];

const DEFAULT_ROLES = [
  { id: "howl", name: "éœçˆ¾", title: "CPO", emoji: "ğŸ§™", color: C.accent },
  { id: "calcifer", name: "å¡è¥¿æ³•", title: "CTO", emoji: "ğŸ”¥", color: C.orange },
  { id: "markl", name: "é¦¬é­¯å…‹", title: "COO", emoji: "ğŸŒ¿", color: C.emerald },
  { id: "sophie", name: "è˜‡è²", title: "CMO", emoji: "ğŸŒ¸", color: C.rose },
  { id: "turnip", name: "è•ªèé ­", title: "CDO", emoji: "ğŸ¥•", color: C.violet },
];

const TIERS = ["Tier 1", "Tier 2", "Tier 3"];

const BD_STATUS = [
  { id: "identified", label: "å·²é–å®š", color: C.inkSoft, icon: "ğŸ”" },
  { id: "warming", label: "æš–èº«ä¸­", color: C.cyan, icon: "ğŸ‘‹" },
  { id: "connected", label: "å·²é€£æ¥", color: C.accent, icon: "ğŸ”—" },
  { id: "chatting", label: "å°è©±ä¸­", color: C.gold, icon: "ğŸ’¬" },
  { id: "call_booked", label: "å·²ç´„è¨ª", color: C.emerald, icon: "ğŸ“" },
  { id: "converted", label: "å·²è½‰å…¥æ¼æ–—", color: C.violet, icon: "ğŸ¯" },
  { id: "dormant", label: "æš«ç·©", color: C.rose, icon: "ğŸ’¤" },
];
const BD_CHANNELS = ["LinkedIn", "AppWorks", "AAMA", "TTA", "Startup Island", "COSCUP / g0v", "æ´»å‹•èªè­˜", "æœ‹å‹æ¨è–¦", "å…¶ä»–"];

// â”€â”€ Lost Reason Options â”€â”€
const LOST_REASONS = [
  { id: "budget", label: "é ç®—ä¸è¶³", icon: "ğŸ’¸" },
  { id: "scope_mismatch", label: "è¦æ ¼/éœ€æ±‚ä¸ç¬¦", icon: "ğŸ“" },
  { id: "competitor", label: "è¢«ç«¶å“æ¶èµ°", icon: "âš”ï¸" },
  { id: "internal_delay", label: "å®¢æˆ¶å…§éƒ¨æ±ºç­–å»¶é²", icon: "â³" },
  { id: "project_cancelled", label: "å°ˆæ¡ˆå–æ¶ˆ / ä¸åšäº†", icon: "ğŸš«" },
  { id: "timing", label: "æ™‚æ©Ÿä¸å° / æš«ç·©", icon: "ğŸ“…" },
  { id: "no_response", label: "ç„¡å›æ‡‰ / å¤±è¯", icon: "ğŸ‘»" },
  { id: "other", label: "å…¶ä»–", icon: "ğŸ“" },
];

// â”€â”€ Document Categories â”€â”€
const DOC_CATEGORIES = ["å…¨éƒ¨", "åˆç´„", "ææ¡ˆ", "å ±å‘Š", "è²¡å‹™", "è¡ŒéŠ·", "å…¶ä»–"];

// â”€â”€ Default docs (shown for new users, all have real URLs and are deletable) â”€â”€
const DEFAULT_DOCS = [
  { id: "sample_1", name: "Beyond Spec æœå‹™ä»‹ç´¹", category: "ææ¡ˆ", icon: "ğŸ°", format: "PDF", url: "https://beyondspec.tw", desc: "å…¬å¸å®˜ç¶²ï¼Œå¯åˆ†äº«çµ¦æ½›åœ¨å®¢æˆ¶äº†è§£æœå‹™å…§å®¹", custom: true },
];

// â”€â”€ Demo Data â”€â”€
const INIT_DEALS = [
  { id: 1, name: "FitTrack å¥èº« App", company: "FitLife Inc.", contact: "é™³å°æ˜", email: "ming@fitlife.tw", stage: "exploring", value: 250000, tier: "Tier 2", notes: "æœ‰èˆˆè¶£åš 0â†’1 Sprintï¼Œä¸‹é€±ä¸‰æ¢ç´¢æœƒè­°", created: "2026-02-20", signedDate: null, role: "howl", archived: false, lostReason: null, parentDealId: null, stageHistory: [{ stage: "inquiry", at: "2026-02-20" }, { stage: "exploring", at: "2026-02-23" }] },
  { id: 2, name: "å¯µç‰©ç¤¾ç¾¤å¹³å°", company: "PawPaw å¯µå¯µ", contact: "æ—å°èŠ±", email: "flower@pawpaw.tw", stage: "proposal", value: 120000, tier: "Tier 3", notes: "å·²é€ææ¡ˆï¼Œç­‰å¾…å›è¦†", created: "2026-02-15", signedDate: null, role: "sophie", archived: false, lostReason: null, parentDealId: null, stageHistory: [{ stage: "inquiry", at: "2026-02-15" }, { stage: "exploring", at: "2026-02-18" }, { stage: "proposal", at: "2026-02-22" }] },
  { id: 3, name: "é¤é£² POS ç³»çµ±å„ªåŒ–", company: "é£Ÿå…‰ç§‘æŠ€", contact: "ç‹å¤§æ˜", email: "wang@foodtime.tw", stage: "inquiry", value: 30000, tier: "Tier 1", notes: "å¾è¡¨å–®é€²ä¾†ï¼Œéœ€è¦ç”¢å“å¥æª¢", created: "2026-02-27", signedDate: null, role: "markl", archived: false, lostReason: null, parentDealId: null, stageHistory: [{ stage: "inquiry", at: "2026-02-27" }] },
  { id: 4, name: "ç·šä¸Šæ•™è‚²å¹³å° MVP", company: "å­¸å ‚ç§‘æŠ€", contact: "å¼µå°ç¾", email: "mei@xuetang.tw", stage: "negotiation", value: 250000, tier: "Tier 2", notes: "åƒ¹æ ¼å·²è«‡åˆ° 22 è¬ï¼Œæ¥è¿‘ç°½ç´„", created: "2026-02-10", signedDate: null, role: "howl", archived: false, lostReason: null, parentDealId: null, stageHistory: [{ stage: "inquiry", at: "2026-02-10" }, { stage: "exploring", at: "2026-02-13" }, { stage: "proposal", at: "2026-02-18" }, { stage: "negotiation", at: "2026-02-24" }] },
  { id: 5, name: "B2B SaaS Landing Page", company: "é›²ç«¯æ–¹æ¡ˆ", contact: "æå¤§å“¥", email: "li@cloudsol.tw", stage: "won", value: 30000, tier: "Tier 1", notes: "å·²å®Œæˆå¥æª¢å ±å‘Šï¼Œå®¢æˆ¶æ»¿æ„", created: "2026-01-28", signedDate: "2026-02-15", role: "turnip", archived: false, lostReason: null, parentDealId: null, stageHistory: [{ stage: "inquiry", at: "2026-01-28" }, { stage: "exploring", at: "2026-01-31" }, { stage: "proposal", at: "2026-02-05" }, { stage: "negotiation", at: "2026-02-10" }, { stage: "won", at: "2026-02-15" }] },
];

const INIT_TASKS = [
  { id: 1, text: "å®Œæˆ FitTrack æ¢ç´¢æœƒè­°ç°¡å ±", role: "howl", dealId: 1, due: "2026-03-05", status: "doing", priority: "high", archived: false },
  { id: 2, text: "PawPaw ææ¡ˆå ±åƒ¹å–®ä¿®æ”¹", role: "sophie", dealId: 2, due: "2026-03-03", status: "todo", priority: "high", archived: false },
  { id: 3, text: "é£Ÿå…‰ç§‘æŠ€ç”¢å“å¥æª¢åˆæ­¥åˆ†æ", role: "turnip", dealId: 3, due: "2026-03-04", status: "todo", priority: "mid", archived: false },
  { id: 4, text: "å­¸å ‚ç§‘æŠ€åˆç´„è‰ç¨¿", role: "markl", dealId: 4, due: "2026-03-02", status: "doing", priority: "high", archived: false },
  { id: 5, text: "é›²ç«¯æ–¹æ¡ˆå¥æª¢å ±å‘Š QA", role: "markl", dealId: 5, due: "2026-02-28", status: "done", priority: "low", archived: false },
  { id: 6, text: "FitTrack æŠ€è¡“å¯è¡Œæ€§è©•ä¼°", role: "calcifer", dealId: 1, due: "2026-03-06", status: "todo", priority: "mid", archived: false },
  { id: 7, text: "LinkedIn æœ¬é€±è²¼æ–‡ï¼ˆæ¡ˆä¾‹åˆ†äº«ï¼‰", role: "sophie", dealId: null, due: "2026-03-01", status: "todo", priority: "low", archived: false },
];

const INIT_LEADS = [
  { id: 1, name: "é™³æŸç¿°", title: "Co-founder & CEO", company: "æ—…éŠæ–°å‰µ TripBuddy", channel: "LinkedIn", status: "warming", notes: "å·²æŒ‰è®š 3 ç¯‡è²¼æ–‡ï¼Œæº–å‚™ç™¼é€£æ¥", lastTouch: "2026-02-27", role: "sophie", archived: false },
  { id: 2, name: "æ—é›…å©·", title: "Product Manager", company: "é‡‘èç§‘æŠ€ FinFlow", channel: "AppWorks", status: "connected", notes: "AppWorks Demo Day èªè­˜ï¼Œå°ç”¢å“è¦æ ¼æœ‰èˆˆè¶£", lastTouch: "2026-02-25", role: "howl", archived: false },
  { id: 3, name: "å¼µå‡±æ–‡", title: "CTO", company: "å¥åº·ç§‘æŠ€ MedPlus", channel: "LinkedIn", status: "chatting", notes: "å·²åˆ†äº« PRD æ–‡ç« ï¼Œå›è¦†æœ‰èˆˆè¶£äº†è§£æ›´å¤š", lastTouch: "2026-02-26", role: "calcifer", archived: false },
  { id: 4, name: "ç‹æ€æ¶µ", title: "å‰µè¾¦äºº", company: "æ•™è‚²å¹³å° LearnWell", channel: "AAMA", status: "call_booked", notes: "3/5 ä¸‹åˆ 3 é» Discovery Call", lastTouch: "2026-02-28", role: "howl", archived: false },
  { id: 5, name: "åŠ‰å»ºå®", title: "ç‡Ÿé‹é•·", company: "ç‰©æµç§‘æŠ€ PackGo", channel: "æ´»å‹•èªè­˜", status: "identified", notes: "MOPCON è¬›è€…ï¼Œåšç‰©æµæ•¸ä½è½‰å‹", lastTouch: "2026-02-20", role: "markl", archived: false },
];

// â”€â”€ Helpers â”€â”€
const fmt = (n) => "NT$ " + n.toLocaleString();
const stageOf = (id) => STAGES.find((s) => s.id === id);
const today = () => new Date().toISOString().split("T")[0];
const timeAgo = (dateStr) => {
  const diff = Date.now() - new Date(dateStr).getTime();
  const mins = Math.floor(diff / 60000);
  if (mins < 1) return "å‰›å‰›";
  if (mins < 60) return `${mins} åˆ†é˜å‰`;
  const hours = Math.floor(mins / 60);
  if (hours < 24) return `${hours} å°æ™‚å‰`;
  const days = Math.floor(hours / 24);
  return `${days} å¤©å‰`;
};

// â”€â”€ CSV Export Utility â”€â”€
const exportCSV = (filename, headers, rows) => {
  const bom = "\uFEFF"; // UTF-8 BOM for Excel
  const csv = bom + [headers.join(","), ...rows.map((r) => r.map((v) => `"${String(v ?? "").replace(/"/g, '""')}"`).join(","))].join("\n");
  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename; a.click();
  URL.revokeObjectURL(url);
};

// â”€â”€ Smart Business Logic â”€â”€
const STAGE_TASKS = {
  inquiry: [
    { text: "å›è¦†å®¢æˆ¶åˆæ­¥è©¢å•", priority: "high" },
    { text: "æº–å‚™å…¬å¸ä»‹ç´¹ & éå¾€æ¡ˆä¾‹", priority: "mid" },
    { text: "ç¢ºèªå®¢æˆ¶éœ€æ±‚ç¯„åœ", priority: "high" },
  ],
  exploring: [
    { text: "æº–å‚™æ¢ç´¢æœƒè­°ç°¡å ±", priority: "high" },
    { text: "ç ”ç©¶å®¢æˆ¶ç”¢æ¥­ & ç«¶å“", priority: "mid" },
    { text: "è£½ä½œåˆæ­¥å¯è¡Œæ€§è©•ä¼°", priority: "mid" },
  ],
  proposal: [
    { text: "æ’°å¯«æ­£å¼ææ¡ˆæ–‡ä»¶", priority: "high" },
    { text: "æº–å‚™å ±åƒ¹å–®", priority: "high" },
    { text: "å…§éƒ¨ææ¡ˆå¯©æŸ¥", priority: "mid" },
  ],
  negotiation: [
    { text: "æº–å‚™åˆç´„è‰ç¨¿", priority: "high" },
    { text: "ç¢ºèªä»˜æ¬¾æ¢ä»¶ & æ™‚ç¨‹", priority: "high" },
    { text: "å®‰æ’åˆç´„ç°½ç½²æµç¨‹", priority: "mid" },
  ],
};

const EMAIL_TEMPLATES = {
  inquiry: (deal) => `${deal.contact} æ‚¨å¥½ï¼Œ\n\næ„Ÿè¬æ‚¨å° Beyond Spec çš„é—œæ³¨ï¼æˆ‘æ˜¯æ„›å¾·è¯ï¼Œå¾ˆé«˜èˆˆæ”¶åˆ°æ‚¨é—œæ–¼ã€Œ${deal.name}ã€çš„è©¢å•ã€‚\n\nç‚ºäº†æ›´å¥½åœ°äº†è§£æ‚¨çš„éœ€æ±‚ï¼Œæƒ³è«‹æ•™å¹¾å€‹å•é¡Œï¼š\n1. ç›®å‰ç”¢å“/å°ˆæ¡ˆçš„ç™¼å±•éšæ®µï¼Ÿ\n2. æœ€è¿«åˆ‡æƒ³è§£æ±ºçš„å•é¡Œæ˜¯ä»€éº¼ï¼Ÿ\n3. é æœŸçš„æ™‚ç¨‹å’Œé ç®—ç¯„åœï¼Ÿ\n\næœŸå¾…èˆ‡æ‚¨é€²ä¸€æ­¥äº¤æµï¼\n\nBest regards,\næ„›å¾·è¯ | Beyond Spec è¦æ ¼å¤–å·¥ä½œå®¤`,
  exploring: (deal) => `${deal.contact} æ‚¨å¥½ï¼Œ\n\næ„Ÿè¬ä¸Šæ¬¡çš„äº¤æµï¼é‡å°ã€Œ${deal.name}ã€å°ˆæ¡ˆï¼Œæˆ‘å€‘å·²åˆæ­¥äº†è§£æ‚¨çš„éœ€æ±‚ã€‚\n\næƒ³è·Ÿæ‚¨ç´„ä¸€æ¬¡æ¢ç´¢æœƒè­°ï¼ˆç´„ 60 åˆ†é˜ï¼‰ï¼Œè®“æˆ‘å€‘æ›´æ·±å…¥è¨è«–ï¼š\nâ€¢ ç¾æœ‰ç”¢å“æ¶æ§‹èˆ‡ç—›é»\nâ€¢ å¯èƒ½çš„è§£æ±ºæ–¹æ¡ˆæ–¹å‘\nâ€¢ åˆä½œæ¨¡å¼èˆ‡æ™‚ç¨‹è¦åŠƒ\n\næ‚¨é€™é€±æœ‰ç©ºçš„æ™‚æ®µå—ï¼Ÿ\n\nBest regards,\næ„›å¾·è¯ | Beyond Spec`,
  proposal: (deal) => `${deal.contact} æ‚¨å¥½ï¼Œ\n\né™„ä¸Šã€Œ${deal.name}ã€å°ˆæ¡ˆçš„æ­£å¼ææ¡ˆã€‚\n\næœ¬æ¬¡ææ¡ˆåŒ…å«ï¼š\nâ€¢ éœ€æ±‚åˆ†æèˆ‡å»ºè­°æ–¹æ¡ˆ\nâ€¢ åŸ·è¡Œæ™‚ç¨‹èˆ‡é‡Œç¨‹ç¢‘\nâ€¢ æŠ•è³‡é‡‘é¡ï¼š${fmt(deal.value)}\n\nå¦‚æœ‰ä»»ä½•å•é¡Œï¼Œæ­¡è¿éš¨æ™‚è¨è«–ã€‚æœŸå¾…æ‚¨çš„å›è¦†ï¼\n\nBest regards,\næ„›å¾·è¯ | Beyond Spec`,
  negotiation: (deal) => `${deal.contact} æ‚¨å¥½ï¼Œ\n\nå¾ˆé«˜èˆˆã€Œ${deal.name}ã€å°ˆæ¡ˆé€²å…¥æœ€å¾Œéšæ®µï¼\n\né™„ä¸Šåˆç´„è‰ç¨¿ä¾›æ‚¨å¯©é–±ï¼Œä¸»è¦æ¢æ¬¾åŒ…æ‹¬ï¼š\nâ€¢ æœå‹™ç¯„åœèˆ‡äº¤ä»˜ç‰©\nâ€¢ æ™‚ç¨‹ï¼š[è«‹å¡«å…¥]\nâ€¢ é‡‘é¡ï¼š${fmt(deal.value)}\nâ€¢ ä»˜æ¬¾æ–¹å¼ï¼š[è«‹å¡«å…¥]\n\nå¦‚æœ‰éœ€è¦èª¿æ•´çš„åœ°æ–¹ï¼Œè«‹éš¨æ™‚å‘ŠçŸ¥ã€‚\n\nBest regards,\næ„›å¾·è¯ | Beyond Spec`,
  won: (deal) => `${deal.contact} æ‚¨å¥½ï¼Œ\n\næ„Ÿè¬é¸æ“‡ Beyond Specï¼ğŸ‰\n\nã€Œ${deal.name}ã€å°ˆæ¡ˆæ­£å¼å•Ÿå‹•ï¼Œæ¥ä¸‹ä¾†çš„æ­¥é©Ÿï¼š\n1. å°ˆæ¡ˆ Kick-off æœƒè­°ï¼ˆæœ¬é€±å®‰æ’ï¼‰\n2. ç¢ºèªè©³ç´°éœ€æ±‚æ–‡ä»¶\n3. ç¬¬ä¸€å€‹é‡Œç¨‹ç¢‘äº¤ä»˜\n\næœŸå¾…åˆä½œæ„‰å¿«ï¼\n\nBest regards,\næ„›å¾·è¯ | Beyond Spec`,
};

// Deal health: days since last activity
const dealHealth = (deal) => {
  if (deal.archived || deal.stage === "won" || deal.stage === "lost") return null;
  const created = new Date(deal.created);
  const now = new Date();
  const days = Math.floor((now - created) / 86400000);
  const thresholds = { inquiry: 7, exploring: 14, proposal: 10, negotiation: 7 };
  const limit = thresholds[deal.stage] || 14;
  if (days >= limit * 2) return { level: "danger", label: `åœæ»¯ ${days} å¤©`, color: "#EF4444" };
  if (days >= limit) return { level: "warn", label: `${days} å¤©æœªæ¨é€²`, color: "#F59E0B" };
  return { level: "ok", label: `${days} å¤©`, color: null };
};

// â”€â”€ Transition helper â”€â”€
const T = "all .2s cubic-bezier(.4,0,.2,1)";
const T_SPRING = "all .35s cubic-bezier(.34,1.56,.64,1)";

// â”€â”€ Animated Number Hook â”€â”€
const useAnimatedNumber = (target, duration = 600) => {
  const [display, setDisplay] = useState(target);
  const prev = useRef(target);
  useEffect(() => {
    const from = prev.current;
    const diff = target - from;
    if (diff === 0) return;
    const start = performance.now();
    const tick = (now) => {
      const t = Math.min(1, (now - start) / duration);
      const ease = 1 - Math.pow(1 - t, 3); // easeOutCubic
      setDisplay(Math.round(from + diff * ease));
      if (t < 1) requestAnimationFrame(tick);
    };
    requestAnimationFrame(tick);
    prev.current = target;
  }, [target, duration]);
  return display;
};

// â”€â”€ Staggered Entrance Hook â”€â”€
const useStagger = (count, baseDelay = 40) => {
  const [visible, setVisible] = useState(false);
  useEffect(() => { const t = setTimeout(() => setVisible(true), 10); return () => clearTimeout(t); }, []);
  return (index) => ({
    opacity: visible ? 1 : 0,
    transform: visible ? "translateY(0)" : "translateY(12px)",
    transition: `opacity .4s cubic-bezier(.4,0,.2,1) ${index * baseDelay}ms, transform .4s cubic-bezier(.4,0,.2,1) ${index * baseDelay}ms`,
  });
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Reusable UI Components
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const Badge = ({ color, bg, children, small }) => (
  <span style={{ display: "inline-block", padding: small ? "3px 9px" : "4px 12px", borderRadius: 8, fontSize: small ? 11 : 13, fontWeight: 600, color, background: bg, whiteSpace: "nowrap", letterSpacing: ".02em" }}>{children}</span>
);

const RolePill = ({ roleId, roles }) => {
  const r = roles.find((x) => x.id === roleId);
  if (!r) return null;
  return <span style={{ display: "inline-flex", alignItems: "center", gap: 5, padding: "3px 10px", borderRadius: 8, fontSize: 13, fontWeight: 600, background: `${r.color}18`, color: r.color, whiteSpace: "nowrap" }}>{r.emoji} {r.name}</span>;
};

const PriorityDot = ({ priority }) => {
  const p = PRIORITY.find((x) => x.id === priority);
  if (!p) return null;
  return <span title={`å„ªå…ˆç´šï¼š${p.label}`} style={{ fontSize: 10 }}>{p.icon}</span>;
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ¨ Design System â€” Button Component
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Variants: primary (filled) / secondary (outline) / ghost (text only) / danger
// Sizes: sm / md (default) / lg
// Usage: <Btn>Primary</Btn>  <Btn variant="secondary">Cancel</Btn>  <Btn size="sm">Small</Btn>
//        <Btn outline>...</Btn> is legacy alias for variant="secondary"

const Btn = ({ children, onClick, color = C.accent, outline, variant, small, size, full, icon, style: sx }) => {
  const [hov, setHov] = useState(false);
  // Resolve variant: legacy `outline` prop â†’ "secondary"
  const v = variant || (outline ? "secondary" : "primary");
  // Resolve size: legacy `small` prop â†’ "sm"
  const s = size || (small ? "sm" : "md");

  const sizeMap = {
    sm:  { padding: "6px 14px", fontSize: 13, iconSize: 13, borderRadius: 8, gap: 5 },
    md:  { padding: "9px 20px", fontSize: 14, iconSize: 14, borderRadius: 10, gap: 6 },
    lg:  { padding: "11px 26px", fontSize: 15, iconSize: 15, borderRadius: 12, gap: 7 },
  };

  const variantStyles = {
    primary: {
      border: "none",
      background: hov ? color : `${color}dd`,
      color: "#fff",
      boxShadow: hov ? `0 4px 14px ${color}40` : `0 2px 8px ${color}20`,
    },
    secondary: {
      border: `1.5px solid ${hov ? color : `${color}50`}`,
      background: hov ? `${color}12` : "transparent",
      color: hov ? color : `${color}cc`,
      boxShadow: "none",
    },
    ghost: {
      border: "1.5px solid transparent",
      background: hov ? "rgba(255,255,255,.06)" : "transparent",
      color: hov ? C.ink : C.inkMuted,
      boxShadow: "none",
    },
    danger: {
      border: "none",
      background: hov ? C.rose : `${C.rose}dd`,
      color: "#fff",
      boxShadow: hov ? `0 4px 14px ${C.rose}40` : `0 2px 8px ${C.rose}20`,
    },
  };

  const sz = sizeMap[s];
  const vs = variantStyles[v] || variantStyles.primary;

  return (
    <button onClick={onClick} className="castle-btn-pop"
      onMouseEnter={() => setHov(true)} onMouseLeave={() => setHov(false)}
      style={{
        padding: sz.padding, borderRadius: sz.borderRadius,
        border: vs.border, background: vs.background, color: vs.color,
        fontSize: sz.fontSize, fontWeight: 600, cursor: "pointer", fontFamily: "inherit",
        transition: T, width: full ? "100%" : "auto",
        boxShadow: vs.boxShadow, display: "inline-flex", alignItems: "center", justifyContent: "center", gap: sz.gap,
        letterSpacing: ".02em",
        ...sx
      }}>{children}</button>
  );
};

const Field = ({ label, children }) => (
  <div style={{ marginBottom: 16 }}>
    <label style={{ display: "block", fontSize: 13, color: C.inkMuted, marginBottom: 6, letterSpacing: ".04em", fontWeight: 500 }}>{label}</label>
    {children}
  </div>
);

const inputStyle = { width: "100%", padding: "10px 14px", borderRadius: 10, border: `1px solid ${C.border}`, background: C.surface, color: C.ink, fontSize: 16, fontFamily: "inherit", boxSizing: "border-box", outline: "none", transition: T };
const selectStyle = { ...inputStyle, cursor: "pointer" };

// â”€â”€ Undo Toast â”€â”€
const UndoToast = ({ message, onUndo, onDismiss }) => {
  useEffect(() => { const t = setTimeout(onDismiss, 4000); return () => clearTimeout(t); }, []);
  return (
    <div style={{ position: "fixed", bottom: 28, left: "50%", transform: "translateX(-50%)", background: C.card, border: `1px solid ${C.borderHover}`, borderRadius: 14, padding: "14px 24px", display: "flex", alignItems: "center", gap: 16, zIndex: 2000, boxShadow: "0 12px 40px rgba(0,0,0,.6)", backdropFilter: "blur(12px)", animation: "fadeSlideIn .3s ease" }}>
      <span style={{ fontSize: 14, color: C.ink }}>{message}</span>
      {onUndo && <button onClick={onUndo} style={{ background: `${C.accent}20`, border: "none", color: C.accent, fontSize: 13, fontWeight: 700, borderRadius: 8, padding: "5px 14px", cursor: "pointer", fontFamily: "inherit", transition: T }}>å¾©åŸ</button>}
    </div>
  );
};

// â”€â”€ Confirm Modal â”€â”€
const ConfirmModal = ({ title, message, onConfirm, onCancel, danger }) => {
  const { mobile } = useWindowSize();
  return (
    <div style={{ position: "fixed", inset: 0, background: "rgba(0,0,0,.7)", backdropFilter: "blur(6px)", display: "flex", alignItems: mobile ? "flex-end" : "center", justifyContent: "center", zIndex: 1100 }} onClick={onCancel}>
      <div onClick={(e) => e.stopPropagation()} style={{ background: C.card, border: `1px solid ${C.borderHover}`, borderRadius: mobile ? "20px 20px 0 0" : 18, padding: mobile ? "28px 24px" : 32, width: mobile ? "100%" : 420 }}>
        <h3 style={{ margin: "0 0 10px", fontSize: 18, fontWeight: 800, color: C.ink }}>{title}</h3>
        <p style={{ margin: "0 0 24px", fontSize: 14, color: C.inkSoft, lineHeight: 1.7 }}>{message}</p>
        <div style={{ display: "flex", gap: 12, justifyContent: "flex-end" }}>
          <Btn variant="ghost" onClick={onCancel}>å–æ¶ˆ</Btn>
          <Btn color={danger ? C.rose : C.accent} onClick={onConfirm}>{danger ? "ç¢ºå®šåˆªé™¤" : "ç¢ºå®š"}</Btn>
        </div>
      </div>
    </div>
  );
};

// â”€â”€ Lost Reason Modal (forced on stageâ†’lost) â”€â”€
const LostReasonModal = ({ dealName, onConfirm, onCancel }) => {
  const { mobile } = useWindowSize();
  const [reason, setReason] = useState(null);
  const [customNote, setCustomNote] = useState("");
  return (
    <div style={{ position: "fixed", inset: 0, background: "rgba(0,0,0,.75)", backdropFilter: "blur(8px)", display: "flex", alignItems: mobile ? "flex-end" : "center", justifyContent: "center", zIndex: 1150 }} onClick={onCancel}>
      <div onClick={(e) => e.stopPropagation()} style={{ background: C.card, border: `1px solid ${C.borderHover}`, borderRadius: mobile ? "20px 20px 0 0" : 18, padding: mobile ? "28px 24px" : 32, width: mobile ? "100%" : 480, animation: "scaleIn .25s cubic-bezier(.4,0,.2,1)" }}>
        <div style={{ display: "flex", alignItems: "center", gap: 10, marginBottom: 8 }}>
          <span style={{ fontSize: 24 }}>ğŸ“Š</span>
          <h3 style={{ margin: 0, fontSize: 18, fontWeight: 800, color: C.ink }}>è¨˜éŒ„æµå¤±åŸå› </h3>
        </div>
        <p style={{ margin: "0 0 20px", fontSize: 14, color: C.inkSoft, lineHeight: 1.7 }}>
          ã€Œ{dealName}ã€å³å°‡æ¨™è¨˜ç‚ºæœªæˆæ¡ˆã€‚é¸æ“‡æµå¤±åŸå› å¹«åŠ©æœªä¾†æ”¹å–„è½‰åŒ–ç‡ã€‚
        </p>
        <div style={{ display: "grid", gridTemplateColumns: mobile ? "1fr" : "1fr 1fr", gap: 8, marginBottom: 16 }}>
          {LOST_REASONS.map((lr) => (
            <button key={lr.id} onClick={() => setReason(lr.id)}
              style={{
                padding: "12px 14px", borderRadius: 12, cursor: "pointer", fontFamily: "inherit", textAlign: "left",
                border: reason === lr.id ? `2px solid ${C.rose}` : `1px solid ${C.border}`,
                background: reason === lr.id ? `${C.rose}15` : C.surface,
                color: reason === lr.id ? C.rose : C.inkSoft,
                transition: T, display: "flex", alignItems: "center", gap: 8, fontSize: 13, fontWeight: 600
              }}>
              <span style={{ fontSize: 16 }}>{lr.icon}</span> {lr.label}
            </button>
          ))}
        </div>
        {reason === "other" && (
          <div style={{ marginBottom: 16 }}>
            <input value={customNote} onChange={(e) => setCustomNote(e.target.value)} placeholder="è«‹æè¿°åŸå› ..."
              style={{ ...inputStyle, borderColor: C.rose + "40" }} autoFocus />
          </div>
        )}
        <div style={{ display: "flex", gap: 12, justifyContent: "flex-end" }}>
          <Btn variant="ghost" onClick={onCancel}>å–æ¶ˆ</Btn>
          <Btn color={C.rose} onClick={() => { if (reason) onConfirm(reason, customNote); }}>
            {reason ? "ç¢ºèªæ¨™è¨˜æœªæˆæ¡ˆ" : "è«‹é¸æ“‡åŸå› "}
          </Btn>
        </div>
      </div>
    </div>
  );
};

// â”€â”€ Modal Overlay â”€â”€
const Modal = ({ title, onClose, children, wide }) => {
  const { mobile } = useWindowSize();
  return (
    <div style={{ position: "fixed", inset: 0, background: "rgba(0,0,0,.7)", backdropFilter: "blur(6px)", display: "flex", alignItems: mobile ? "flex-end" : "center", justifyContent: "center", zIndex: 1000 }} onClick={onClose}>
      <div onClick={(e) => e.stopPropagation()} style={{ background: C.card, border: `1px solid ${C.borderHover}`, borderRadius: mobile ? "20px 20px 0 0" : 18, padding: mobile ? "28px 24px" : 32, width: mobile ? "100%" : (wide ? 600 : 520), maxHeight: mobile ? "92vh" : "85vh", overflowY: "auto" }}>
        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 24 }}>
          <h3 style={{ margin: 0, fontSize: mobile ? 18 : 20, fontWeight: 800, color: C.ink }}>{title}</h3>
          <button onClick={onClose} style={{ background: "rgba(255,255,255,.06)", border: "none", color: C.inkMuted, cursor: "pointer", fontSize: 14, padding: "6px 10px", borderRadius: 8, transition: T, fontFamily: "inherit" }}>âœ•</button>
        </div>
        {children}
      </div>
    </div>
  );
};

// â”€â”€ Search Bar â”€â”€
const SearchBar = ({ value, onChange, placeholder }) => {
  const { mobile } = useWindowSize();
  const [focus, setFocus] = useState(false);
  return (
    <div style={{ position: "relative", flex: 1, maxWidth: mobile ? "100%" : 320 }}>
      <span style={{ position: "absolute", left: 12, top: "50%", transform: "translateY(-50%)", fontSize: 15, color: C.inkMuted }}>ğŸ”</span>
      <input value={value} onChange={(e) => onChange(e.target.value)} placeholder={placeholder || "æœå°‹..."}
        onFocus={() => setFocus(true)} onBlur={() => setFocus(false)}
        style={{ ...inputStyle, paddingLeft: 36, fontSize: 14, background: C.surface, borderColor: focus ? C.accent : C.border, boxShadow: focus ? `0 0 0 3px ${C.accent}15` : "none" }} />
    </div>
  );
};

// â”€â”€ Quick Filter Pills â”€â”€
const FilterPills = ({ options, active, onSelect }) => (
  <div style={{ display: "flex", gap: 6, overflowX: "auto", WebkitOverflowScrolling: "touch", paddingBottom: 2 }}>
    {options.map((o) => (
      <button key={o.id} onClick={() => onSelect(o.id)}
        style={{ padding: "5px 14px", borderRadius: 20, border: active === o.id ? `1.5px solid ${o.color || C.accent}` : `1px solid ${C.border}`, background: active === o.id ? `${o.color || C.accent}15` : "transparent", color: active === o.id ? (o.color || C.accent) : C.inkMuted, fontSize: 13, fontWeight: 600, cursor: "pointer", fontFamily: "inherit", whiteSpace: "nowrap", flexShrink: 0, transition: T }}>
        {o.label}
      </button>
    ))}
  </div>
);

// â”€â”€ Hoverable Card wrapper â”€â”€
const HoverCard = ({ children, onClick, selected, accentColor, style: sx, expanded }) => {
  const [hov, setHov] = useState(false);
  return (
    <div onClick={onClick}
      onMouseEnter={() => setHov(true)} onMouseLeave={() => setHov(false)}
      style={{
        background: hov ? C.cardHover : C.card,
        border: `1px solid ${selected ? (accentColor || C.ink) : (hov ? C.borderHover : C.border)}`,
        borderLeft: accentColor ? `3px solid ${accentColor}` : undefined,
        borderRadius: 12, padding: 16, cursor: onClick ? "pointer" : "default",
        transition: T,
        transform: hov && onClick && !expanded ? "translateY(-2px)" : "none",
        boxShadow: hov && onClick ? "0 8px 24px rgba(0,0,0,.25)" : "none",
        ...sx
      }}>
      {children}
    </div>
  );
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Detail Drawer â€” Slide-over panel (v5.2)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DetailDrawer = ({ open, onClose, title, icon, accentColor, children, actions, width }) => {
  const { mobile } = useWindowSize();
  const drawerW = mobile ? "100%" : (width || 480);

  useEffect(() => {
    if (!open) return;
    const h = (e) => { if (e.key === "Escape") onClose(); };
    window.addEventListener("keydown", h);
    return () => window.removeEventListener("keydown", h);
  }, [open]);

  if (!open) return null;

  return (
    <div style={{ position: "fixed", inset: 0, zIndex: 9000, display: "flex", justifyContent: "flex-end" }}>
      {/* Backdrop */}
      <div onClick={onClose} style={{
        position: "absolute", inset: 0, background: "rgba(0,0,0,.35)", backdropFilter: "blur(2px)",
        animation: "drawerFadeIn .2s ease"
      }} />
      {/* Panel */}
      <div style={{
        position: "relative", width: drawerW, maxWidth: "100%", height: "100%",
        background: C.card, borderLeft: mobile ? "none" : `1.5px solid ${C.borderHover}`,
        display: "flex", flexDirection: "column",
        boxShadow: `-24px 0 80px rgba(0,0,0,.5), -2px 0 20px ${accentColor || C.accent}15`,
        animation: "drawerSlideIn .28s cubic-bezier(.16,1,.3,1)"
      }}>
        {/* Header */}
        <div style={{
          padding: mobile ? "18px 20px" : "22px 28px", borderBottom: `1px solid ${C.border}`,
          display: "flex", justifyContent: "space-between", alignItems: "flex-start",
          background: accentColor ? `linear-gradient(135deg, ${accentColor}08, transparent)` : undefined
        }}>
          <div style={{ flex: 1, minWidth: 0 }}>
            <div style={{ display: "flex", alignItems: "center", gap: 10, marginBottom: 4 }}>
              {icon && <span style={{ fontSize: 20 }}>{icon}</span>}
              <div style={{ fontSize: 18, fontWeight: 800, color: C.ink, lineHeight: 1.3 }}>{title}</div>
            </div>
            {accentColor && <div style={{ width: 40, height: 3, borderRadius: 2, background: accentColor, marginTop: 8 }} />}
          </div>
          <button onClick={onClose} style={{
            width: 36, height: 36, borderRadius: 10, border: `1px solid ${C.border}`,
            background: C.surface, color: C.inkMuted, fontSize: 16, cursor: "pointer",
            display: "flex", alignItems: "center", justifyContent: "center",
            transition: T, fontFamily: "inherit", flexShrink: 0, marginLeft: 12
          }}
            onMouseEnter={(e) => { e.target.style.background = C.cardHover; e.target.style.color = C.ink; }}
            onMouseLeave={(e) => { e.target.style.background = C.surface; e.target.style.color = C.inkMuted; }}
          >âœ•</button>
        </div>
        {/* Content */}
        <div style={{
          flex: 1, overflowY: "auto", padding: mobile ? "20px 20px" : "24px 28px"
        }}>
          {children}
        </div>
        {/* Footer actions */}
        {actions && (
          <div style={{
            padding: mobile ? "16px 20px" : "18px 28px",
            borderTop: `1px solid ${C.border}`, background: `${C.surface}80`,
            display: "flex", gap: 10, flexWrap: "wrap"
          }}>
            {actions}
          </div>
        )}
      </div>
    </div>
  );
};

// Detail section helper
const DrawerSection = ({ label, children, style: sx }) => (
  <div style={{ marginBottom: 20, ...sx }}>
    <div style={{ fontSize: 11, fontWeight: 600, color: C.inkMuted, letterSpacing: ".08em", textTransform: "uppercase", marginBottom: 8 }}>{label}</div>
    {children}
  </div>
);
const DrawerField = ({ label, value, mono, color, children }) => (
  <div style={{ marginBottom: 12 }}>
    <div style={{ fontSize: 11, color: C.inkMuted, marginBottom: 3, fontWeight: 500 }}>{label}</div>
    {children || <div style={{ fontSize: 14, color: color || C.ink, fontWeight: 500, fontFamily: mono ? "'JetBrains Mono',monospace" : "inherit" }}>{value || "â€”"}</div>}
  </div>
);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Forms
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const DealForm = ({ deal, roles, allDeals, onSave, onCancel }) => {
  const { mobile } = useWindowSize();
  const [f, setF] = useState(deal || { name: "", company: "", contact: "", email: "", stage: "inquiry", value: 30000, tier: "Tier 1", notes: "", role: roles[0]?.id || "howl", created: today(), signedDate: null, archived: false, lostReason: null, parentDealId: null, stageHistory: [{ stage: "inquiry", at: today() }] });
  const set = (k, v) => setF({ ...f, [k]: v });
  const wonDeals = (allDeals || []).filter(d => d.stage === "won" && !d.archived && d.id !== f.id);
  return (
    <div>
      <div style={{ display: "grid", gridTemplateColumns: mobile ? "1fr" : "1fr 1fr", gap: "0 18px" }}>
        <Field label="æ¡ˆä»¶åç¨± *"><input style={inputStyle} value={f.name} onChange={(e) => set("name", e.target.value)} placeholder="ä¾‹ï¼šFitTrack å¥èº« App" /></Field>
        <Field label="å…¬å¸ / åœ˜éšŠ *"><input style={inputStyle} value={f.company} onChange={(e) => set("company", e.target.value)} placeholder="ä¾‹ï¼šFitLife Inc." /></Field>
        <Field label="è¯ç¹«äºº"><input style={inputStyle} value={f.contact} onChange={(e) => set("contact", e.target.value)} /></Field>
        <Field label="Email"><input style={inputStyle} value={f.email} onChange={(e) => set("email", e.target.value)} /></Field>
        <Field label="éšæ®µ"><select style={selectStyle} value={f.stage} onChange={(e) => set("stage", e.target.value)}>{STAGES.map((s) => <option key={s.id} value={s.id}>{s.icon} {s.label}</option>)}</select></Field>
        <Field label="é‡‘é¡ (NT$)"><input style={inputStyle} type="number" step="10000" value={f.value} onChange={(e) => set("value", Number(e.target.value))} /></Field>
        <Field label="æ–¹æ¡ˆ"><select style={selectStyle} value={f.tier} onChange={(e) => set("tier", e.target.value)}>{TIERS.map((t) => <option key={t} value={t}>{t}</option>)}</select></Field>
        <Field label="è² è²¬è§’è‰²"><select style={selectStyle} value={f.role} onChange={(e) => set("role", e.target.value)}>{roles.map((r) => <option key={r.id} value={r.id}>{r.emoji} {r.name} ({r.title})</option>)}</select></Field>
      </div>
      {wonDeals.length > 0 && (
        <Field label="ğŸ”„ å»¶ä¼¸è‡ªï¼ˆäºŒæœŸ/è¿½åŠ æ¡ˆä»¶ï¼‰">
          <select style={selectStyle} value={f.parentDealId || ""} onChange={(e) => set("parentDealId", e.target.value ? Number(e.target.value) : null)}>
            <option value="">â€” å…¨æ–°æ¡ˆä»¶ â€”</option>
            {wonDeals.map((d) => <option key={d.id} value={d.id}>â†© {d.name} ({d.company})</option>)}
          </select>
        </Field>
      )}
      <Field label="å‚™è¨»"><textarea style={{ ...inputStyle, minHeight: 80, resize: "vertical" }} value={f.notes} onChange={(e) => set("notes", e.target.value)} /></Field>
      <div style={{ display: "flex", gap: 12, justifyContent: "flex-end", marginTop: 10 }}>
        <Btn variant="ghost" onClick={onCancel}>å–æ¶ˆ</Btn>
        <Btn color={C.emerald} onClick={() => { if (f.name && f.company) onSave(f); }}>{deal ? "å„²å­˜" : "æ–°å¢"}</Btn>
      </div>
    </div>
  );
};

const TaskForm = ({ task, deals, roles, onSave, onCancel }) => {
  const { mobile } = useWindowSize();
  const [f, setF] = useState(task || { text: "", role: roles[0]?.id || "howl", dealId: null, due: today(), status: "todo", priority: "mid", archived: false });
  const set = (k, v) => setF({ ...f, [k]: v });
  return (
    <div>
      <Field label="ä»»å‹™å…§å®¹ *"><input style={inputStyle} value={f.text} onChange={(e) => set("text", e.target.value)} placeholder="ä¾‹ï¼šå®Œæˆæ¢ç´¢æœƒè­°ç°¡å ±" /></Field>
      <div style={{ display: "grid", gridTemplateColumns: mobile ? "1fr" : "1fr 1fr", gap: "0 18px" }}>
        <Field label="è² è²¬è§’è‰²"><select style={selectStyle} value={f.role} onChange={(e) => set("role", e.target.value)}>{roles.map((r) => <option key={r.id} value={r.id}>{r.emoji} {r.name}</option>)}</select></Field>
        <Field label="æˆªæ­¢æ—¥æœŸ"><input style={inputStyle} type="date" value={f.due} onChange={(e) => set("due", e.target.value)} /></Field>
        <Field label="ç‹€æ…‹"><select style={selectStyle} value={f.status} onChange={(e) => set("status", e.target.value)}>{TASK_STATUS.map((s) => <option key={s.id} value={s.id}>{s.icon} {s.label}</option>)}</select></Field>
        <Field label="å„ªå…ˆç´š"><select style={selectStyle} value={f.priority} onChange={(e) => set("priority", e.target.value)}>{PRIORITY.map((p) => <option key={p.id} value={p.id}>{p.icon} {p.label}</option>)}</select></Field>
      </div>
      <Field label="é—œè¯æ¡ˆä»¶">
        <select style={selectStyle} value={f.dealId || ""} onChange={(e) => set("dealId", e.target.value ? Number(e.target.value) : null)}>
          <option value="">â€” ä¸é—œè¯ â€”</option>
          {deals.map((d) => <option key={d.id} value={d.id}>{d.name}</option>)}
        </select>
      </Field>
      <div style={{ display: "flex", gap: 12, justifyContent: "flex-end", marginTop: 10 }}>
        <Btn variant="ghost" onClick={onCancel}>å–æ¶ˆ</Btn>
        <Btn color={C.emerald} onClick={() => { if (f.text) onSave(f); }}>{task ? "å„²å­˜" : "æ–°å¢"}</Btn>
      </div>
    </div>
  );
};

const LeadForm = ({ lead, roles, onSave, onCancel }) => {
  const { mobile } = useWindowSize();
  const [f, setF] = useState(lead || { name: "", title: "", company: "", channel: "LinkedIn", status: "identified", notes: "", lastTouch: today(), role: roles[0]?.id || "sophie", archived: false });
  const set = (k, v) => setF({ ...f, [k]: v });
  return (
    <div>
      <div style={{ display: "grid", gridTemplateColumns: mobile ? "1fr" : "1fr 1fr", gap: "0 18px" }}>
        <Field label="å§“å *"><input style={inputStyle} value={f.name} onChange={(e) => set("name", e.target.value)} /></Field>
        <Field label="è·ç¨±"><input style={inputStyle} value={f.title} onChange={(e) => set("title", e.target.value)} /></Field>
        <Field label="å…¬å¸ *"><input style={inputStyle} value={f.company} onChange={(e) => set("company", e.target.value)} /></Field>
        <Field label="ç®¡é“"><select style={selectStyle} value={f.channel} onChange={(e) => set("channel", e.target.value)}>{BD_CHANNELS.map((c) => <option key={c} value={c}>{c}</option>)}</select></Field>
        <Field label="ç‹€æ…‹"><select style={selectStyle} value={f.status} onChange={(e) => set("status", e.target.value)}>{BD_STATUS.map((s) => <option key={s.id} value={s.id}>{s.icon} {s.label}</option>)}</select></Field>
        <Field label="è² è²¬è§’è‰²"><select style={selectStyle} value={f.role} onChange={(e) => set("role", e.target.value)}>{roles.map((r) => <option key={r.id} value={r.id}>{r.emoji} {r.name}</option>)}</select></Field>
      </div>
      <Field label="å‚™è¨»"><textarea style={{ ...inputStyle, minHeight: 80, resize: "vertical" }} value={f.notes} onChange={(e) => set("notes", e.target.value)} /></Field>
      <div style={{ display: "flex", gap: 12, justifyContent: "flex-end", marginTop: 10 }}>
        <Btn variant="ghost" onClick={onCancel}>å–æ¶ˆ</Btn>
        <Btn color={C.emerald} onClick={() => { if (f.name && f.company) onSave(f); }}>{lead ? "å„²å­˜" : "æ–°å¢"}</Btn>
      </div>
    </div>
  );
};

// â”€â”€ Role Form â”€â”€
const EMOJI_OPTIONS = ["ğŸ§™","ğŸ”¥","ğŸŒ¿","ğŸŒ¸","ğŸ¥•","âš¡","ğŸ¯","ğŸ¦Š","ğŸ»","ğŸ¨","ğŸ“","ğŸ›¡ï¸","ğŸ’","ğŸŒŠ","ğŸ”ï¸","ğŸ¦…"];
const COLOR_OPTIONS = [C.accent, C.orange, C.emerald, C.rose, C.violet, C.cyan, C.gold, "#FF6B6B", "#4ECDC4", "#45B7D1"];

const RoleForm = ({ role, onSave, onCancel }) => {
  const { mobile } = useWindowSize();
  const [f, setF] = useState(role || { name: "", title: "", emoji: "âš¡", color: C.cyan });
  const set = (k, v) => setF({ ...f, [k]: v });
  return (
    <div>
      <div style={{ display: "grid", gridTemplateColumns: mobile ? "1fr" : "1fr 1fr", gap: "0 18px" }}>
        <Field label="è§’è‰²åç¨± *"><input style={inputStyle} value={f.name} onChange={(e) => set("name", e.target.value)} placeholder="ä¾‹ï¼šåŠ©ç†" /></Field>
        <Field label="è·ç¨±"><input style={inputStyle} value={f.title} onChange={(e) => set("title", e.target.value)} placeholder="ä¾‹ï¼šPM" /></Field>
      </div>
      <Field label="åœ–ç¤º">
        <div style={{ display: "flex", gap: 8, flexWrap: "wrap" }}>
          {EMOJI_OPTIONS.map((e) => (
            <button key={e} onClick={() => set("emoji", e)}
              style={{ width: 40, height: 40, borderRadius: 10, border: f.emoji === e ? `2px solid ${C.accent}` : `1px solid ${C.border}`, background: f.emoji === e ? C.accentSoft : "transparent", fontSize: 20, cursor: "pointer", display: "flex", alignItems: "center", justifyContent: "center", transition: T }}>{e}</button>
          ))}
        </div>
      </Field>
      <Field label="é¡è‰²">
        <div style={{ display: "flex", gap: 8, flexWrap: "wrap" }}>
          {COLOR_OPTIONS.map((c) => (
            <button key={c} onClick={() => set("color", c)}
              style={{ width: 36, height: 36, borderRadius: 10, border: f.color === c ? "2px solid white" : "2px solid transparent", background: c, cursor: "pointer", transition: T }} />
          ))}
        </div>
      </Field>
      <div style={{ marginTop: 18, padding: 16, background: C.surface, borderRadius: 12 }}>
        <div style={{ fontSize: 13, color: C.inkMuted, marginBottom: 8 }}>é è¦½</div>
        <span style={{ display: "inline-flex", alignItems: "center", gap: 8, padding: "6px 14px", borderRadius: 10, background: `${f.color}18`, color: f.color, fontSize: 15, fontWeight: 600 }}>{f.emoji} {f.name || "æœªå‘½å"} <span style={{ fontSize: 12, opacity: .6 }}>({f.title || "ç„¡è·ç¨±"})</span></span>
      </div>
      <div style={{ display: "flex", gap: 12, justifyContent: "flex-end", marginTop: 18 }}>
        <Btn variant="ghost" onClick={onCancel}>å–æ¶ˆ</Btn>
        <Btn color={C.emerald} onClick={() => { if (f.name) onSave(f); }}>{role ? "å„²å­˜" : "æ–°å¢è§’è‰²"}</Btn>
      </div>
    </div>
  );
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// View Components
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€ Stats Row (North Star Metrics) â”€â”€
// â”€â”€ Morning Brief Banner â”€â”€
const MorningBrief = ({ deals, tasks, leads, onDismiss }) => {
  const { mobile } = useWindowSize();
  const todayKey = `brief_${today()}`;
  const [dismissed, setDismissed] = useState(() => ls.get(todayKey, false));
  const dismiss = () => { setDismissed(true); ls.set(todayKey, true); };
  if (dismissed) return null;

  const active = deals.filter(d => !d.archived && !["won","lost"].includes(d.stage));
  const overdueTasks = tasks.filter(t => !t.archived && t.status !== "done" && t.due < today());
  const stale = active.filter(d => { const h = dealHealth(d); return h && h.level !== "ok"; });
  const hotDeals = active.filter(d => d.stage === "negotiation");
  const todayTasks = tasks.filter(t => !t.archived && t.status !== "done" && t.due === today());

  // Generate smart brief
  const lines = [];
  if (overdueTasks.length > 0) lines.push({ icon: "ğŸ”´", text: `${overdueTasks.length} å€‹é€¾æœŸä»»å‹™éœ€è¦è™•ç†`, color: C.rose });
  if (todayTasks.length > 0) lines.push({ icon: "ğŸ“‹", text: `ä»Šå¤©æœ‰ ${todayTasks.length} å€‹ä»»å‹™åˆ°æœŸ`, color: C.gold });
  if (hotDeals.length > 0) lines.push({ icon: "ğŸ”¥", text: `${hotDeals.length} å€‹æ¡ˆä»¶åœ¨è­°åƒ¹éšæ®µï¼Œæ¥è¿‘ç°½ç´„ï¼`, color: C.emerald });
  if (stale.length > 0) lines.push({ icon: "âš ï¸", text: `${stale.length} å€‹æ¡ˆä»¶åœæ»¯éä¹…ï¼Œå»ºè­°ä¸»å‹•è·Ÿé€²`, color: C.orange });
  if (lines.length === 0) lines.push({ icon: "âœ¨", text: "ä¸€åˆ‡é †åˆ©ï¼ä»Šå¤©ç¹¼çºŒä¿æŒå¥½ç¯€å¥ã€‚", color: C.accent });

  const hour = new Date().getHours();
  const greeting = hour < 12 ? "æ—©å®‰" : hour < 18 ? "åˆå®‰" : "æ™šå®‰";

  return (
    <div className="castle-brief" style={{ background: `linear-gradient(135deg, ${C.card} 0%, ${C.surface} 100%)`, border: `1px solid ${C.borderHover}`, borderRadius: 16, padding: mobile ? 18 : 24, marginBottom: mobile ? 16 : 24, position: "relative", overflow: "hidden" }}>
      {/* Subtle shimmer accent */}
      <div style={{ position: "absolute", top: 0, left: 0, right: 0, height: 3, background: `linear-gradient(90deg, ${C.accent}00, ${C.accent}60, ${C.gold}60, ${C.accent}00)`, backgroundSize: "200% 100%", animation: "shimmer 3s ease-in-out infinite" }} />
      <button onClick={dismiss} style={{ position: "absolute", top: 12, right: 14, background: "transparent", border: "none", color: C.inkMuted, cursor: "pointer", fontSize: 14, fontFamily: "inherit", padding: 4 }}>âœ•</button>
      <div style={{ fontSize: mobile ? 16 : 18, fontWeight: 800, color: C.ink, marginBottom: 12 }}>ğŸ° {greeting}ï¼Œé­”æ³•é•·ï¼</div>
      <div style={{ display: "flex", flexDirection: "column", gap: 8 }}>
        {lines.map((l, i) => (
          <div key={i} style={{ display: "flex", alignItems: "center", gap: 10, fontSize: 14, color: l.color || C.inkSoft }}>
            <span>{l.icon}</span>
            <span>{l.text}</span>
          </div>
        ))}
      </div>
      <div style={{ fontSize: 11, color: C.inkMuted, marginTop: 12, borderTop: `1px solid ${C.border}`, paddingTop: 10 }}>
        ğŸ“Š ç®¡ç·šä¸­ {active.length} æ¡ˆ Â· ğŸ“‹ å¾…è¾¦ {tasks.filter(t => !t.archived && t.status !== "done").length} é … Â· ğŸ¯ è¿½è¹¤ {leads.filter(l => !l.archived).length} å€‹ BD å°è±¡
      </div>
    </div>
  );
};

// â”€â”€ Animated Stat Number â”€â”€
const AnimStat = ({ value, prefix = "", suffix = "", color, size }) => {
  const num = typeof value === "number" ? value : parseInt(String(value).replace(/[^0-9-]/g, "")) || 0;
  const animated = useAnimatedNumber(num);
  const display = prefix + animated.toLocaleString() + suffix;
  return <span style={{ fontSize: size, fontWeight: 800, color, fontFamily: "'JetBrains Mono',monospace", animation: "countUp .4s ease" }}>{display}</span>;
};

const StatsRow = ({ deals, tasks, leads, onHealthClick }) => {
  const { mobile } = useWindowSize();
  const active = deals.filter((d) => !d.archived && !["won", "lost"].includes(d.stage));
  const won = deals.filter((d) => !d.archived && d.stage === "won");
  const all = deals.filter((d) => !d.archived);
  const stageWeights = { inquiry: 0.1, exploring: 0.25, proposal: 0.5, negotiation: 0.75, won: 1, lost: 0 };
  const weightedPipeline = active.reduce((s, d) => s + d.value * (stageWeights[d.stage] || 0.1), 0);

  const wonTotal = won.reduce((s, d) => s + d.value, 0);
  const lost = deals.filter((d) => !d.archived && d.stage === "lost");
  const closed = won.length + lost.length;
  const winRate = closed > 0 ? Math.round((won.length / closed) * 100) : 0;
  const wonWithDates = won.filter(d => d.signedDate && d.created);
  const avgCycle = wonWithDates.length > 0 ? Math.round(wonWithDates.reduce((s, d) => s + (new Date(d.signedDate) - new Date(d.created)) / 86400000, 0) / wonWithDates.length) : null;

  const stats = [
    { label: "ğŸ‰ å·²ç°½ç´„ç‡Ÿæ”¶", rawNum: wonTotal, prefix: "NT$ ", value: fmt(wonTotal), color: C.emerald, sub: `${won.length} ä»¶æˆäº¤ Â· åŒ—æ¥µæ˜ŸæŒ‡æ¨™ â­` },
    { label: "ğŸ† è´å–®ç‡", rawNum: winRate, suffix: "%", value: `${winRate}%`, color: winRate >= 50 ? C.emerald : winRate >= 30 ? C.gold : C.rose, sub: closed > 0 ? `å·²çµæ¡ˆ ${closed} æ¡ˆï¼ˆè´ ${won.length} / è¼¸ ${lost.length}ï¼‰` : "å°šç„¡å·²çµæ¡ˆæ¡ˆä»¶" },
    { label: "ğŸ“Š åŠ æ¬Šç®¡ç·šå€¼", rawNum: Math.round(weightedPipeline), prefix: "NT$ ", value: fmt(Math.round(weightedPipeline)), color: C.gold, sub: `${active.length} é€²è¡Œä¸­ Â· é ä¼°è½‰æ›æ”¶å…¥` },
    { label: "â± æˆäº¤é€±æœŸ", rawNum: avgCycle, suffix: avgCycle !== null ? " å¤©" : "", value: avgCycle !== null ? `${avgCycle} å¤©` : "â€”", color: avgCycle !== null ? (avgCycle <= 14 ? C.emerald : avgCycle <= 30 ? C.gold : C.orange) : C.inkMuted, sub: avgCycle !== null ? `æ´½è©¢â†’ç°½ç´„å¹³å‡ ${avgCycle} å¤©` : "å°šç„¡æˆäº¤æ•¸æ“š" },
  ];
  return (
    <div style={{ display: "grid", gridTemplateColumns: mobile ? "1fr 1fr" : "repeat(4,1fr)", gap: mobile ? 10 : 16, marginBottom: mobile ? 20 : 28, position: "relative" }}>
      {stats.map((s, i) => (
        <HoverCard key={i} style={{ padding: mobile ? "14px 16px" : "20px 24px" }}>
          <div className="castle-stat-card" style={{ animationDelay: `${i * 60}ms` }}>
            <div style={{ fontSize: 12, color: C.inkMuted, marginBottom: 6, fontWeight: 500, letterSpacing: ".04em" }}>{s.label}</div>
            {s.rawNum !== null && s.rawNum !== undefined ? (
              <AnimStat value={s.rawNum} prefix={s.prefix || ""} suffix={s.suffix || ""} color={s.color} size={mobile ? 22 : 28} />
            ) : (
              <div style={{ fontSize: mobile ? 22 : 28, fontWeight: 800, color: s.color, fontFamily: "'JetBrains Mono',monospace" }}>{s.value}</div>
            )}
            {s.sub && <div style={{ fontSize: 11, color: C.inkMuted, marginTop: 4 }}>{s.sub}</div>}
          </div>
        </HoverCard>
      ))}
    </div>
  );
};

// â”€â”€ Pipeline (Deals) with Detail Drawer â”€â”€
const PipelineView = ({ deals, roles, onArchive, onUpdate, onStageChange, expandedId, onExpand }) => {
  const { mobile, tablet } = useWindowSize();
  const [editing, setEditing] = useState(false);
  const [draft, setDraft] = useState(null);
  const active = deals.filter((d) => !d.archived);
  const selectedDeal = active.find((d) => d.id === expandedId);
  const displayStage = editing && draft ? draft.stage : selectedDeal?.stage;
  const selectedStage = displayStage ? STAGES.find((s) => s.id === displayStage) : null;

  useEffect(() => { setEditing(false); setDraft(null); }, [expandedId]);
  const startEdit = () => { setDraft({...selectedDeal}); setEditing(true); };
  const cancelEdit = () => { setDraft(null); setEditing(false); };
  const saveEdit = () => { if (draft && draft.name && draft.company) { onUpdate(draft); setEditing(false); setDraft(null); } };
  const setD = (k, v) => setDraft(prev => ({...prev, [k]: v}));

  const DealCard = ({ d, stage }) => {
    const isSelected = expandedId === d.id;
    const health = dealHealth(d);
    return (
      <div style={{ marginBottom: 8 }}>
        <HoverCard onClick={() => onExpand(isSelected ? null : d.id)} selected={isSelected} accentColor={stage.color}>
          <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start" }}>
            <div style={{ fontSize: 14, fontWeight: 700, color: C.ink, lineHeight: 1.4, flex: 1 }}>
              {d.name}
              {health && health.level !== "ok" && (
                <span title={health.label} style={{ marginLeft: 6, fontSize: 10, padding: "2px 6px", borderRadius: 6, background: `${health.color}20`, color: health.color, fontWeight: 600, verticalAlign: "middle" }}>{health.label}</span>
              )}
            </div>
            <span style={{ fontSize: 13, color: C.inkMuted, opacity: .6 }}>â†’</span>
          </div>
          <div style={{ fontSize: 12, color: C.inkMuted, margin: "6px 0 8px" }}>{d.company}</div>
          <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
            <Badge color={C.gold} bg={C.goldSoft} small>{fmt(d.value)}</Badge>
            <RolePill roleId={d.role} roles={roles} />
          </div>
        </HoverCard>
      </div>
    );
  };

  // Deal Detail Drawer â€” inline editable (v5.3)
  const dealDrawer = selectedDeal && selectedStage && (
    <DetailDrawer open={!!selectedDeal} onClose={() => { cancelEdit(); onExpand(null); }}
      title={editing ? "ç·¨è¼¯æ¡ˆä»¶" : selectedDeal.name}
      icon={editing ? "âœï¸" : selectedStage.icon}
      accentColor={selectedStage.color}
      actions={editing ? <>
        <Btn color={C.emerald} size="sm" onClick={saveEdit}>å„²å­˜è®Šæ›´</Btn>
        <Btn variant="ghost" size="sm" onClick={cancelEdit}>å–æ¶ˆ</Btn>
      </> : <>
        <Btn size="sm" color={C.accent} onClick={startEdit}>ç·¨è¼¯</Btn>
        <Btn variant="secondary" color={C.rose} size="sm" onClick={() => { onArchive(selectedDeal.id); onExpand(null); }}>å°å­˜</Btn>
      </>}
    >
      {/* Stage quick-switch â€” always visible */}
      <div style={{ marginBottom: 20 }}>
        <div style={{ fontSize: 11, fontWeight: 600, color: C.inkMuted, letterSpacing: ".08em", textTransform: "uppercase", marginBottom: 8 }}>éšæ®µ</div>
        <div style={{ display: "flex", gap: 6, flexWrap: "wrap" }}>
          {STAGES.map((s) => {
            const current = editing && draft ? draft.stage : selectedDeal.stage;
            return (
              <button key={s.id} onClick={() => {
                if (editing) setD("stage", s.id);
                else onStageChange(selectedDeal.id, s.id);
              }}
                style={{ padding: "6px 14px", borderRadius: 9, border: current === s.id ? `1.5px solid ${s.color}` : `1px solid ${C.border}`, background: current === s.id ? `${s.color}20` : "transparent", color: current === s.id ? s.color : C.inkMuted, fontSize: 12, fontWeight: 600, cursor: "pointer", fontFamily: "inherit", whiteSpace: "nowrap", transition: T }}>
                {s.icon} {s.label}
              </button>
            );
          })}
        </div>
      </div>

      {editing && draft ? (
        <>
          <DrawerSection label="æ¡ˆä»¶è³‡è¨Š">
            <Field label="æ¡ˆä»¶åç¨±"><input style={inputStyle} value={draft.name} onChange={(e) => setD("name", e.target.value)} /></Field>
            <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: "0 14px" }}>
              <Field label="é‡‘é¡ (NT$)"><input style={inputStyle} type="number" step="10000" value={draft.value} onChange={(e) => setD("value", Number(e.target.value))} /></Field>
              <Field label="æ–¹æ¡ˆ"><select style={selectStyle} value={draft.tier} onChange={(e) => setD("tier", e.target.value)}>{TIERS.map((t) => <option key={t} value={t}>{t}</option>)}</select></Field>
            </div>
            <Field label="è² è²¬è§’è‰²"><select style={selectStyle} value={draft.role} onChange={(e) => setD("role", e.target.value)}>{roles.map((r) => <option key={r.id} value={r.id}>{r.emoji} {r.name} ({r.title})</option>)}</select></Field>
          </DrawerSection>
          <DrawerSection label="å®¢æˆ¶è³‡è¨Š">
            <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: "0 14px" }}>
              <Field label="å…¬å¸"><input style={inputStyle} value={draft.company} onChange={(e) => setD("company", e.target.value)} /></Field>
              <Field label="è¯ç¹«äºº"><input style={inputStyle} value={draft.contact} onChange={(e) => setD("contact", e.target.value)} /></Field>
            </div>
            <Field label="Email"><input style={inputStyle} type="email" value={draft.email} onChange={(e) => setD("email", e.target.value)} /></Field>
          </DrawerSection>
          <DrawerSection label="å‚™è¨»">
            <textarea style={{ ...inputStyle, minHeight: 100, resize: "vertical" }} value={draft.notes} onChange={(e) => setD("notes", e.target.value)} placeholder="æ¡ˆä»¶å‚™å¿˜éŒ„..." />
          </DrawerSection>
        </>
      ) : (
        <>
          {/* View mode */}
          <div style={{ display: "flex", alignItems: "center", gap: 10, marginBottom: 20 }}>
            <Badge color={C.gold} bg={C.goldSoft}>{fmt(selectedDeal.value)}</Badge>
            <Badge color={C.accent} bg={C.accentSoft}>{selectedDeal.tier}</Badge>
          </div>
          <DrawerSection label="å®¢æˆ¶è³‡è¨Š">
            <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 4 }}>
              <DrawerField label="å…¬å¸" value={selectedDeal.company} />
              <DrawerField label="è¯ç¹«äºº" value={selectedDeal.contact} />
              <DrawerField label="Email" value={selectedDeal.email} />
              <DrawerField label="å»ºç«‹æ—¥æœŸ" value={selectedDeal.created} mono />
            </div>
          </DrawerSection>
          {selectedDeal.signedDate && (
            <DrawerSection label="ç°½ç´„è³‡è¨Š">
              <DrawerField label="ç°½ç´„æ—¥æœŸ" value={selectedDeal.signedDate} mono color={C.emerald} />
            </DrawerSection>
          )}
          <DrawerSection label="è² è²¬äºº">
            <RolePill roleId={selectedDeal.role} roles={roles} />
          </DrawerSection>
          {/* Parent deal (if upsell/repeat) */}
          {selectedDeal.parentDealId && (() => {
            const parent = deals.find((d) => d.id === selectedDeal.parentDealId);
            return parent ? (
              <DrawerSection label="ğŸ”„ å»¶ä¼¸è‡ª">
                <div style={{ background: C.surface, borderRadius: 10, padding: 14, border: `1px solid ${C.border}`, display: "flex", alignItems: "center", gap: 10 }}>
                  <span style={{ fontSize: 16 }}>â†©</span>
                  <div>
                    <div style={{ fontSize: 14, fontWeight: 600, color: C.ink }}>{parent.name}</div>
                    <div style={{ fontSize: 12, color: C.inkMuted }}>{parent.company} Â· {fmt(parent.value)}</div>
                  </div>
                </div>
              </DrawerSection>
            ) : null;
          })()}
          {/* Upsell children */}
          {(() => {
            const children = deals.filter((d) => d.parentDealId === selectedDeal.id && !d.archived);
            return children.length > 0 ? (
              <DrawerSection label="ğŸ”„ è¡ç”Ÿæ¡ˆä»¶">
                <div style={{ display: "flex", flexDirection: "column", gap: 6 }}>
                  {children.map((c) => {
                    const cStage = STAGES.find((s) => s.id === c.stage);
                    return (
                      <div key={c.id} style={{ background: C.surface, borderRadius: 10, padding: "10px 14px", border: `1px solid ${C.border}`, display: "flex", alignItems: "center", gap: 10 }}>
                        <span style={{ fontSize: 14 }}>{cStage?.icon || "ğŸ“"}</span>
                        <div style={{ flex: 1 }}>
                          <div style={{ fontSize: 13, fontWeight: 600, color: C.ink }}>{c.name}</div>
                          <div style={{ fontSize: 11, color: C.inkMuted }}>{cStage?.label} Â· {fmt(c.value)}</div>
                        </div>
                      </div>
                    );
                  })}
                </div>
              </DrawerSection>
            ) : null;
          })()}
          {/* Stage History Timeline */}
          {selectedDeal.stageHistory && selectedDeal.stageHistory.length > 0 && (
            <DrawerSection label="ğŸ“ éšæ®µæ­·ç¨‹">
              <div style={{ position: "relative", paddingLeft: 20 }}>
                {/* Vertical line */}
                <div style={{ position: "absolute", left: 7, top: 4, bottom: 4, width: 2, background: C.border, borderRadius: 1 }} />
                {selectedDeal.stageHistory.map((h, i) => {
                  const sMeta = STAGES.find((s) => s.id === h.stage);
                  const isLast = i === selectedDeal.stageHistory.length - 1;
                  const nextAt = selectedDeal.stageHistory[i + 1]?.at;
                  const days = nextAt ? Math.max(1, Math.round((new Date(nextAt) - new Date(h.at)) / 86400000)) : null;
                  return (
                    <div key={i} style={{ display: "flex", alignItems: "flex-start", gap: 12, marginBottom: i < selectedDeal.stageHistory.length - 1 ? 14 : 0, position: "relative" }}>
                      <div style={{ position: "absolute", left: -16, top: 2, width: 12, height: 12, borderRadius: "50%", background: isLast ? (sMeta?.color || C.accent) : C.surface, border: `2px solid ${sMeta?.color || C.accent}`, zIndex: 1 }} />
                      <div style={{ flex: 1 }}>
                        <div style={{ display: "flex", alignItems: "center", gap: 6 }}>
                          <span style={{ fontSize: 13, fontWeight: 600, color: isLast ? (sMeta?.color || C.ink) : C.inkSoft }}>{sMeta?.icon} {sMeta?.label || h.stage}</span>
                          <span style={{ fontSize: 11, color: C.inkMuted, fontFamily: "monospace" }}>{h.at}</span>
                        </div>
                        {days && <div style={{ fontSize: 11, color: C.inkMuted, marginTop: 2 }}>åœç•™ {days} å¤©</div>}
                      </div>
                    </div>
                  );
                })}
              </div>
            </DrawerSection>
          )}
          {/* Lost Reason */}
          {selectedDeal.stage === "lost" && selectedDeal.lostReason && (
            <DrawerSection label="ğŸ’” æµå¤±åŸå› ">
              <div style={{ background: `${C.rose}10`, borderRadius: 10, padding: 14, border: `1px solid ${C.rose}25` }}>
                <div style={{ fontSize: 14, fontWeight: 600, color: C.rose }}>
                  {(() => { const r = LOST_REASONS.find((lr) => lr.id === selectedDeal.lostReason); return r ? `${r.icon} ${r.label}` : selectedDeal.lostReason; })()}
                </div>
                {selectedDeal.lostNote && <div style={{ fontSize: 13, color: C.inkSoft, marginTop: 6 }}>{selectedDeal.lostNote}</div>}
              </div>
            </DrawerSection>
          )}
          {selectedDeal.notes && (
            <DrawerSection label="å‚™è¨»">
              <div style={{ background: C.surface, borderRadius: 10, padding: 14, fontSize: 14, color: C.inkSoft, lineHeight: 1.8, border: `1px solid ${C.border}` }}>{selectedDeal.notes}</div>
            </DrawerSection>
          )}
          {/* Smart: Suggested tasks for current stage */}
          {STAGE_TASKS[selectedDeal.stage] && (
            <DrawerSection label="ğŸ’¡ å»ºè­°ä»»å‹™">
              <div style={{ display: "flex", flexDirection: "column", gap: 6 }}>
                {STAGE_TASKS[selectedDeal.stage].map((st, i) => (
                  <div key={i} style={{ display: "flex", alignItems: "center", gap: 10, padding: "8px 12px", background: C.surface, borderRadius: 10, border: `1px solid ${C.border}`, fontSize: 13, color: C.inkSoft }}>
                    <span style={{ color: st.priority === "high" ? C.rose : C.gold, fontSize: 10 }}>{st.priority === "high" ? "ğŸ”´" : "ğŸŸ¡"}</span>
                    <span style={{ flex: 1 }}>{st.text}</span>
                  </div>
                ))}
              </div>
            </DrawerSection>
          )}
          {/* Smart: Email template */}
          {EMAIL_TEMPLATES[selectedDeal.stage] && (
            <DrawerSection label="ğŸ“§ å¿«é€Ÿè·Ÿé€²ä¿¡ä»¶">
              <div style={{ position: "relative" }}>
                <pre style={{ background: C.surface, borderRadius: 10, padding: 14, fontSize: 12, color: C.inkSoft, lineHeight: 1.7, border: `1px solid ${C.border}`, whiteSpace: "pre-wrap", wordBreak: "break-word", fontFamily: "inherit", margin: 0, maxHeight: 200, overflowY: "auto" }}>
                  {EMAIL_TEMPLATES[selectedDeal.stage](selectedDeal)}
                </pre>
                <Btn small color={C.accent} onClick={() => { navigator.clipboard?.writeText(EMAIL_TEMPLATES[selectedDeal.stage](selectedDeal)); }}
                  style={{ position: "absolute", top: 8, right: 8 }}>ğŸ“‹ è¤‡è£½</Btn>
              </div>
            </DrawerSection>
          )}
        </>
      )}
    </DetailDrawer>
  );

  if (mobile) {
    return (
      <>
        <div style={{ display: "flex", flexDirection: "column", gap: 16 }}>
          {STAGES.map((stage) => {
            const sd = active.filter((d) => d.stage === stage.id);
            if (sd.length === 0) return null;
            return (
              <div key={stage.id}>
                <div style={{ display: "flex", alignItems: "center", gap: 8, marginBottom: 10 }}>
                  <span style={{ fontSize: 14, fontWeight: 700, color: stage.color }}>{stage.icon} {stage.label}</span>
                  <span style={{ fontSize: 12, color: C.inkMuted, background: C.surface, padding: "1px 8px", borderRadius: 10 }}>{sd.length}</span>
                </div>
                {sd.map((d) => <DealCard key={d.id} d={d} stage={stage} />)}
              </div>
            );
          })}
        </div>
        {dealDrawer}
      </>
    );
  }

  return (
    <>
      <div style={{ overflowX: "auto", paddingBottom: 8 }}>
        <div style={{ display: "grid", gridTemplateColumns: mobile ? "1fr" : `repeat(${STAGES.length}, minmax(200px, 1fr))`, gap: 12, minWidth: mobile ? "auto" : (tablet ? STAGES.length * 210 : "auto") }}>
          {STAGES.map((stage) => {
            const sd = active.filter((d) => d.stage === stage.id);
            return (
              <div key={stage.id}>
                <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 10 }}>
                  <span style={{ fontSize: 13, fontWeight: 700, color: stage.color }}>{stage.icon} {stage.label}</span>
                  <span style={{ fontSize: 12, color: C.inkMuted, background: C.surface, padding: "1px 8px", borderRadius: 10 }}>{sd.length}</span>
                </div>
                <div style={{ height: 3, background: `${stage.color}15`, borderRadius: 2, marginBottom: 10 }}>
                  <div style={{ height: "100%", width: sd.length ? "100%" : 0, background: stage.color, borderRadius: 2, transition: "width .4s ease" }} />
                </div>
                <div style={{ display: "flex", flexDirection: "column", gap: 4 }}>
                  {sd.map((d) => <DealCard key={d.id} d={d} stage={stage} />)}
                  {sd.length === 0 && <div style={{ padding: 24, textAlign: "center", color: C.inkMuted, fontSize: 12, border: `1px dashed ${C.border}`, borderRadius: 10 }}>æš«ç„¡æ¡ˆä»¶</div>}
                </div>
              </div>
            );
          })}
        </div>
      </div>
      {dealDrawer}
    </>
  );
};

// â”€â”€ Tasks View (v5.2: Detail Drawer) â”€â”€
const TasksView = ({ tasks, deals, roles, onEdit, onArchive, onStatusChange, search, filter }) => {
  const { mobile, tablet } = useWindowSize();
  const [selectedId, setSelectedId] = useState(null);

  let visible = tasks.filter((t) => !t.archived);
  if (search) { const q = search.toLowerCase(); visible = visible.filter((t) => t.text.toLowerCase().includes(q)); }
  if (filter === "overdue") visible = visible.filter((t) => t.status !== "done" && t.due < today());
  else if (filter === "high") visible = visible.filter((t) => t.priority === "high");
  else if (filter && filter !== "all") visible = visible.filter((t) => t.role === filter);

  const selectedTask = visible.find((t) => t.id === selectedId) || tasks.find((t) => t.id === selectedId);

  const TaskCard = ({ t }) => {
    const dl = deals.find((d) => d.id === t.dealId);
    const isOverdue = t.status !== "done" && t.due < today();
    const isSelected = selectedId === t.id;
    const st = TASK_STATUS.find((s) => s.id === t.status);

    return (
      <div style={{ marginBottom: 6 }}>
        <HoverCard onClick={() => setSelectedId(isSelected ? null : t.id)} selected={isSelected}>
          <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start", gap: 10 }}>
            <div style={{ display: "flex", alignItems: "flex-start", gap: 8, flex: 1 }}>
              <PriorityDot priority={t.priority} />
              <span style={{ fontSize: 14, color: C.ink, lineHeight: 1.5, flex: 1 }}>{t.text}</span>
            </div>
            <span style={{ fontSize: 13, color: C.inkMuted, opacity: .6 }}>â†’</span>
          </div>
          <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", flexWrap: "wrap", gap: 6, marginTop: 8 }}>
            <RolePill roleId={t.role} roles={roles} />
            <span style={{ fontSize: 11, color: isOverdue ? C.rose : C.inkMuted, fontWeight: isOverdue ? 700 : 400, fontFamily: "monospace" }}>{isOverdue ? "âš ï¸ " : ""}{t.due}</span>
          </div>
        </HoverCard>
      </div>
    );
  };

  // Task Detail Drawer
  const taskDrawer = selectedTask && (() => {
    const dl = deals.find((d) => d.id === selectedTask.dealId);
    const st = TASK_STATUS.find((s) => s.id === selectedTask.status);
    const pri = PRIORITY.find((p) => p.id === selectedTask.priority);
    const isOverdue = selectedTask.status !== "done" && selectedTask.due < today();
    return (
      <DetailDrawer open={!!selectedTask} onClose={() => setSelectedId(null)}
        title={selectedTask.text} icon={pri?.icon || "ğŸ“‹"} accentColor={st?.color}
        actions={<>
          <Btn size="sm" color={C.accent} onClick={() => onEdit(selectedTask)}>ç·¨è¼¯ä»»å‹™</Btn>
          <Btn variant="secondary" color={C.rose} size="sm" onClick={() => { onArchive(selectedTask.id); setSelectedId(null); }}>å°å­˜</Btn>
        </>}
      >
        {/* Status badge row */}
        <div style={{ display: "flex", alignItems: "center", gap: 10, marginBottom: 20, flexWrap: "wrap" }}>
          <Badge color={st?.color} bg={`${st?.color}18`}>{st?.icon} {st?.label}</Badge>
          <Badge color={pri?.color || C.inkMuted} bg={`${(pri?.color || C.inkMuted)}18`}>{pri?.icon} {pri?.label}</Badge>
          {isOverdue && <Badge color={C.rose} bg={`${C.rose}18`}>âš ï¸ é€¾æœŸ</Badge>}
        </div>
        {/* Status quick-switch */}
        <DrawerSection label="è®Šæ›´ç‹€æ…‹">
          <div style={{ display: "flex", gap: 8, flexWrap: "wrap" }}>
            {TASK_STATUS.map((s) => (
              <button key={s.id} onClick={() => onStatusChange(selectedTask.id, s.id)}
                style={{ padding: "8px 16px", borderRadius: 10, border: selectedTask.status === s.id ? `2px solid ${s.color}` : `1px solid ${C.border}`, background: selectedTask.status === s.id ? `${s.color}15` : C.surface, color: selectedTask.status === s.id ? s.color : C.inkMuted, fontSize: 13, fontWeight: 600, cursor: "pointer", fontFamily: "inherit", transition: T }}>
                {s.icon} {s.label}
              </button>
            ))}
          </div>
        </DrawerSection>
        <DrawerSection label="è©³ç´°è³‡è¨Š">
          <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 4 }}>
            <DrawerField label="åˆ°æœŸæ—¥" value={selectedTask.due} mono color={isOverdue ? C.rose : undefined} />
            <DrawerField label="è² è²¬äºº"><RolePill roleId={selectedTask.role} roles={roles} /></DrawerField>
          </div>
        </DrawerSection>
        {dl && (
          <DrawerSection label="é—œè¯æ¡ˆä»¶">
            <div style={{ background: C.surface, borderRadius: 10, padding: 14, border: `1px solid ${C.border}`, display: "flex", alignItems: "center", gap: 10 }}>
              <span style={{ fontSize: 16 }}>ğŸ“</span>
              <div>
                <div style={{ fontSize: 14, fontWeight: 600, color: C.ink }}>{dl.name}</div>
                <div style={{ fontSize: 12, color: C.inkMuted }}>{dl.company} Â· {fmt(dl.value)}</div>
              </div>
            </div>
          </DrawerSection>
        )}
      </DetailDrawer>
    );
  })();

  if (mobile) {
    return (
      <>
      <div style={{ display: "flex", flexDirection: "column", gap: 20 }}>
        {TASK_STATUS.map((st) => {
          const items = visible.filter((t) => t.status === st.id);
          return (
            <div key={st.id}>
              <div style={{ display: "flex", alignItems: "center", gap: 8, marginBottom: 10, paddingBottom: 10, borderBottom: `1px solid ${C.border}` }}>
                <span style={{ fontSize: 15, fontWeight: 700, color: st.color }}>{st.icon} {st.label}</span>
                <span style={{ fontSize: 12, color: C.inkMuted, background: C.surface, padding: "1px 8px", borderRadius: 10 }}>{items.length}</span>
              </div>
              <div style={{ display: "flex", flexDirection: "column", gap: 4 }}>
                {items.map((t) => <TaskCard key={t.id} t={t} />)}
                {items.length === 0 && <div style={{ padding: 16, textAlign: "center", color: C.inkMuted, fontSize: 13 }}>æš«ç„¡ä»»å‹™</div>}
              </div>
            </div>
          );
        })}
      </div>
      {taskDrawer}
      </>
    );
  }

  return (
    <>
    <div style={{ display: "grid", gridTemplateColumns: mobile ? "1fr" : (tablet ? "1fr 1fr" : "repeat(3,1fr)"), gap: 16 }}>
      {TASK_STATUS.map((st) => {
        const items = visible.filter((t) => t.status === st.id);
        return (
          <div key={st.id}>
            <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 12 }}>
              <span style={{ fontSize: 14, fontWeight: 700, color: st.color }}>{st.icon} {st.label}</span>
              <span style={{ fontSize: 12, color: C.inkMuted, background: C.surface, padding: "1px 8px", borderRadius: 10 }}>{items.length}</span>
            </div>
            <div style={{ height: 3, background: `${st.color}15`, borderRadius: 2, marginBottom: 12 }}>
              <div style={{ height: "100%", width: items.length ? "100%" : 0, background: st.color, borderRadius: 2, transition: "width .4s ease" }} />
            </div>
            <div style={{ display: "flex", flexDirection: "column", gap: 4 }}>
              {items.map((t) => <TaskCard key={t.id} t={t} />)}
              {items.length === 0 && <div style={{ padding: 24, textAlign: "center", color: C.inkMuted, fontSize: 13, border: `1px dashed ${C.border}`, borderRadius: 10 }}>æš«ç„¡ä»»å‹™</div>}
            </div>
          </div>
        );
      })}
    </div>
    {taskDrawer}
    </>
  );
};

// â”€â”€ BD Tracker View (v5.2: Detail Drawer) â”€â”€
const BDTrackerView = ({ leads, roles, onEdit, onArchive, onConvert }) => {
  const { mobile, tablet } = useWindowSize();
  const [selectedId, setSelectedId] = useState(null);
  const active = leads.filter((l) => !l.archived);

  const total = active.length;
  const inProgress = active.filter((l) => !["converted", "dormant"].includes(l.status)).length;
  const booked = active.filter((l) => l.status === "call_booked").length;
  const converted = active.filter((l) => l.status === "converted").length;

  const selectedLead = active.find((l) => l.id === selectedId);
  const selectedStatus = selectedLead ? BD_STATUS.find((s) => s.id === selectedLead.status) : null;

  const LeadCard = ({ lead, status }) => {
    const isSelected = selectedId === lead.id;
    return (
      <div style={{ marginBottom: 6 }}>
        <HoverCard onClick={() => setSelectedId(isSelected ? null : lead.id)} accentColor={status.color} selected={isSelected}>
          <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start" }}>
            <div style={{ fontSize: 14, fontWeight: 700, color: C.ink }}>{lead.name}</div>
            <span style={{ fontSize: 13, color: C.inkMuted, opacity: .6 }}>â†’</span>
          </div>
          <div style={{ fontSize: 12, color: C.inkMuted, marginTop: 2 }}>{lead.title}</div>
          <div style={{ fontSize: 13, color: C.inkSoft, margin: "4px 0 8px" }}>{lead.company}</div>
          <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
            <span style={{ fontSize: 11, color: C.inkMuted, background: C.surface, padding: "2px 8px", borderRadius: 6 }}>{lead.channel}</span>
            <RolePill roleId={lead.role} roles={roles} />
          </div>
        </HoverCard>
      </div>
    );
  };

  // Lead Detail Drawer
  const leadDrawer = selectedLead && selectedStatus && (
    <DetailDrawer open={!!selectedLead} onClose={() => setSelectedId(null)}
      title={selectedLead.name} icon="ğŸ¯" accentColor={selectedStatus.color}
      actions={<>
        <Btn size="sm" color={C.accent} onClick={() => onEdit(selectedLead)}>ç·¨è¼¯</Btn>
        {selectedLead.status === "call_booked" && <Btn size="sm" color={C.emerald} onClick={() => { onConvert(selectedLead); setSelectedId(null); }}>è½‰å…¥æ¼æ–—</Btn>}
        <Btn variant="secondary" color={C.rose} size="sm" onClick={() => { onArchive(selectedLead.id); setSelectedId(null); }}>å°å­˜</Btn>
      </>}
    >
      <div style={{ display: "flex", alignItems: "center", gap: 10, marginBottom: 20, flexWrap: "wrap" }}>
        <Badge color={selectedStatus.color} bg={`${selectedStatus.color}18`}>{selectedStatus.icon} {selectedStatus.label}</Badge>
        <span style={{ fontSize: 12, color: C.inkMuted, fontFamily: "monospace" }}>æœ€å¾Œäº’å‹• {selectedLead.lastTouch}</span>
      </div>
      <DrawerSection label="è¯ç¹«äººè³‡è¨Š">
        <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 4 }}>
          <DrawerField label="å§“å" value={selectedLead.name} />
          <DrawerField label="è·ç¨±" value={selectedLead.title} />
          <DrawerField label="å…¬å¸" value={selectedLead.company} />
          <DrawerField label="ä¾†æºç®¡é“" value={selectedLead.channel} />
        </div>
      </DrawerSection>
      <DrawerSection label="è² è²¬äºº">
        <RolePill roleId={selectedLead.role} roles={roles} />
      </DrawerSection>
      {selectedLead.notes && (
        <DrawerSection label="å‚™è¨»èˆ‡äº’å‹•ç´€éŒ„">
          <div style={{ background: C.surface, borderRadius: 10, padding: 14, fontSize: 14, color: C.inkSoft, lineHeight: 1.8, border: `1px solid ${C.border}` }}>{selectedLead.notes}</div>
        </DrawerSection>
      )}
    </DetailDrawer>
  );

  return (
    <>
    <div>
      <div style={{ display: "grid", gridTemplateColumns: mobile ? "1fr 1fr" : "repeat(4,1fr)", gap: mobile ? 10 : 16, marginBottom: 24 }}>
        {[
          { label: "ç¸½è¿½è¹¤", value: total, color: C.accent },
          { label: "é€²è¡Œä¸­", value: inProgress, color: C.cyan },
          { label: "å·²ç´„è¨ª", value: booked, color: C.emerald },
          { label: "å·²è½‰å…¥", value: converted, color: C.violet },
        ].map((s, i) => (
          <HoverCard key={i} style={{ padding: mobile ? "12px 14px" : "18px 22px" }}>
            <div style={{ fontSize: 12, color: C.inkMuted, marginBottom: 6, fontWeight: 500 }}>{s.label}</div>
            <div style={{ fontSize: mobile ? 22 : 26, fontWeight: 800, color: s.color, fontFamily: "'JetBrains Mono',monospace" }}>{s.value}</div>
          </HoverCard>
        ))}
      </div>

      {mobile ? (
        <div style={{ display: "flex", flexDirection: "column", gap: 16 }}>
          {BD_STATUS.map((st) => {
            const sl = active.filter((l) => l.status === st.id);
            if (!sl.length) return null;
            return (
              <div key={st.id}>
                <div style={{ display: "flex", alignItems: "center", gap: 8, marginBottom: 10 }}>
                  <span style={{ fontSize: 14, fontWeight: 700, color: st.color }}>{st.icon} {st.label}</span>
                  <span style={{ fontSize: 12, color: C.inkMuted, background: C.surface, padding: "1px 8px", borderRadius: 10 }}>{sl.length}</span>
                </div>
                <div style={{ display: "flex", flexDirection: "column", gap: 4 }}>{sl.map((l) => <LeadCard key={l.id} lead={l} status={st} />)}</div>
              </div>
            );
          })}
        </div>
      ) : (
        <div style={{ overflowX: "auto", paddingBottom: 12 }}>
          <div style={{ display: "grid", gridTemplateColumns: mobile ? "1fr" : `repeat(${BD_STATUS.length}, minmax(180px, 1fr))`, gap: 12, minWidth: mobile ? "auto" : BD_STATUS.length * 190 }}>
            {BD_STATUS.map((st) => {
              const sl = active.filter((l) => l.status === st.id);
              return (
                <div key={st.id}>
                  <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 10 }}>
                    <span style={{ fontSize: 13, fontWeight: 700, color: st.color }}>{st.icon} {st.label}</span>
                    <span style={{ fontSize: 12, color: C.inkMuted, background: C.surface, padding: "1px 8px", borderRadius: 10 }}>{sl.length}</span>
                  </div>
                  <div style={{ height: 3, background: `${st.color}15`, borderRadius: 2, marginBottom: 10 }}>
                    <div style={{ height: "100%", width: sl.length ? "100%" : 0, background: st.color, borderRadius: 2, transition: "width .4s ease" }} />
                  </div>
                  <div style={{ display: "flex", flexDirection: "column", gap: 4 }}>
                    {sl.map((l) => <LeadCard key={l.id} lead={l} status={st} />)}
                    {!sl.length && <div style={{ padding: 24, textAlign: "center", color: C.inkMuted, fontSize: 13, border: `1px dashed ${C.border}`, borderRadius: 10 }}>æš«ç„¡</div>}
                  </div>
                </div>
              );
            })}
          </div>
        </div>
      )}
    </div>
    {leadDrawer}
    </>
  );
};

// â”€â”€ Analytics View â”€â”€
const AnalyticsView = ({ deals, roles, goals: savedGoals, onGoalsChange }) => {
  const { mobile } = useWindowSize();
  const [period, setPeriod] = useState("month"); // month | quarter | year
  const [selectedRole, setSelectedRole] = useState("all");
  const [showGoalEditor, setShowGoalEditor] = useState(false);
  const [goalDraft, setGoalDraft] = useState(null);
  const activeRoles = roles.filter((r) => !r.archived);

  const now = new Date();
  const currentYear = now.getFullYear();
  const currentMonth = now.getMonth();
  const currentQuarter = Math.floor(currentMonth / 3);

  // Filter deals by period
  const inPeriod = (dateStr) => {
    if (!dateStr) return false;
    const d = new Date(dateStr);
    if (period === "month") return d.getFullYear() === currentYear && d.getMonth() === currentMonth;
    if (period === "quarter") return d.getFullYear() === currentYear && Math.floor(d.getMonth() / 3) === currentQuarter;
    return d.getFullYear() === currentYear;
  };

  const allDeals = deals.filter((d) => !d.archived);
  const periodDeals = allDeals.filter((d) => inPeriod(d.created));
  const periodWon = allDeals.filter((d) => d.stage === "won" && inPeriod(d.signedDate || d.created));
  const filtered = selectedRole === "all" ? periodDeals : periodDeals.filter((d) => d.role === selectedRole);
  const filteredWon = selectedRole === "all" ? periodWon : periodWon.filter((d) => d.role === selectedRole);

  // Goals â€” user-configurable, persisted to localStorage
  const defaultGoals = { month: { deals: 5, revenue: 300000 }, quarter: { deals: 12, revenue: 800000 }, year: { deals: 40, revenue: 3000000 } };
  const goals = savedGoals || defaultGoals;
  const goal = goals[period];
  const wonRevenue = filteredWon.reduce((s, d) => s + d.value, 0);
  const pipelineValue = filtered.filter((d) => !["won", "lost"].includes(d.stage)).reduce((s, d) => s + d.value, 0);

  const pctDeals = goal.deals > 0 ? Math.round((filteredWon.length / goal.deals) * 100) : 0;
  const pctRevenue = goal.revenue > 0 ? Math.round((wonRevenue / goal.revenue) * 100) : 0;

  // Deal Velocity â€” days from created to signedDate for won deals
  const velocityDeals = allDeals.filter((d) => d.stage === "won" && d.signedDate && d.created);
  const velocities = velocityDeals.map((d) => {
    const start = new Date(d.created);
    const end = new Date(d.signedDate);
    return Math.max(1, Math.round((end - start) / (1000 * 60 * 60 * 24)));
  });
  const avgVelocity = velocities.length > 0 ? Math.round(velocities.reduce((a, b) => a + b, 0) / velocities.length) : 0;

  // Role performance
  const rolePerf = activeRoles.map((r) => {
    const rd = allDeals.filter((d) => d.role === r.id);
    const rWon = rd.filter((d) => d.stage === "won" && inPeriod(d.signedDate || d.created));
    const rActive = rd.filter((d) => !d.archived && !["won", "lost"].includes(d.stage) && inPeriod(d.created));
    const rv = rd.filter((d) => d.stage === "won" && d.signedDate && d.created);
    const rVelocities = rv.map((d) => Math.max(1, Math.round((new Date(d.signedDate) - new Date(d.created)) / 86400000)));
    const rAvgV = rVelocities.length > 0 ? Math.round(rVelocities.reduce((a, b) => a + b, 0) / rVelocities.length) : 0;
    return { ...r, wonCount: rWon.length, wonRevenue: rWon.reduce((s, d) => s + d.value, 0), activeCount: rActive.length, avgVelocity: rAvgV, totalDeals: rd.filter((d) => inPeriod(d.created)).length };
  });

  const periodLabels = { month: "æœ¬æœˆ", quarter: "æœ¬å­£", year: "æœ¬å¹´" };

  const ProgressBar = ({ value, max, color }) => {
    const pct = max > 0 ? Math.min(100, Math.round((value / max) * 100)) : 0;
    return (
      <div style={{ position: "relative", height: 10, background: C.surface, borderRadius: 6, overflow: "hidden" }}>
        <div style={{ height: "100%", width: `${pct}%`, background: color, borderRadius: 6, transition: "width .6s cubic-bezier(.4,0,.2,1)" }} />
      </div>
    );
  };

  return (
    <div>
      {/* Period selector + role filter + goal settings */}
      <div style={{ display: "flex", flexDirection: mobile ? "column" : "row", gap: 12, marginBottom: 24, alignItems: mobile ? "stretch" : "center" }}>
        <div style={{ display: "flex", gap: 4, background: C.surface, borderRadius: 10, padding: 4 }}>
          {["month", "quarter", "year"].map((p) => (
            <button key={p} onClick={() => setPeriod(p)}
              style={{ padding: "7px 18px", borderRadius: 8, border: "none", cursor: "pointer", fontSize: 14, fontWeight: 600, fontFamily: "inherit", background: period === p ? C.card : "transparent", color: period === p ? C.ink : C.inkMuted, transition: T }}>
              {periodLabels[p]}
            </button>
          ))}
        </div>
        <div style={{ display: "flex", gap: 6, flexWrap: "wrap", flex: 1 }}>
          <button onClick={() => setSelectedRole("all")}
            style={{ padding: "5px 14px", borderRadius: 20, border: selectedRole === "all" ? `1.5px solid ${C.accent}` : `1px solid ${C.border}`, background: selectedRole === "all" ? `${C.accent}15` : "transparent", color: selectedRole === "all" ? C.accent : C.inkMuted, fontSize: 13, fontWeight: 600, cursor: "pointer", fontFamily: "inherit", transition: T }}>å…¨å“¡</button>
          {activeRoles.map((r) => (
            <button key={r.id} onClick={() => setSelectedRole(r.id)}
              style={{ padding: "5px 14px", borderRadius: 20, border: selectedRole === r.id ? `1.5px solid ${r.color}` : `1px solid ${C.border}`, background: selectedRole === r.id ? `${r.color}15` : "transparent", color: selectedRole === r.id ? r.color : C.inkMuted, fontSize: 13, fontWeight: 600, cursor: "pointer", fontFamily: "inherit", transition: T }}>
              {r.emoji} {r.name}
            </button>
          ))}
        </div>
        <button onClick={() => { setGoalDraft(JSON.parse(JSON.stringify(goals))); setShowGoalEditor(!showGoalEditor); }}
          style={{ padding: "7px 14px", borderRadius: 10, border: `1px solid ${showGoalEditor ? C.accent : C.border}`, background: showGoalEditor ? `${C.accent}15` : "transparent", color: showGoalEditor ? C.accent : C.inkMuted, fontSize: 13, fontWeight: 600, cursor: "pointer", fontFamily: "inherit", transition: T, whiteSpace: "nowrap", display: "flex", alignItems: "center", gap: 6 }}>
          âš™ï¸ ç›®æ¨™è¨­å®š
        </button>
      </div>

      {/* Goal Editor Panel */}
      {showGoalEditor && goalDraft && (
        <div style={{ background: C.card, border: `1px solid ${C.borderHover}`, borderRadius: 14, padding: mobile ? 20 : 24, marginBottom: 24, animation: "drawerFadeIn .2s ease" }}>
          <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 18 }}>
            <div style={{ fontSize: 16, fontWeight: 800, color: C.ink }}>ğŸ¯ èª¿æ•´æ¥­ç¸¾ç›®æ¨™</div>
            <button onClick={() => setShowGoalEditor(false)} style={{ background: "rgba(255,255,255,.06)", border: "none", color: C.inkMuted, fontSize: 14, padding: "4px 10px", borderRadius: 8, cursor: "pointer", fontFamily: "inherit" }}>âœ•</button>
          </div>
          <div style={{ display: "grid", gridTemplateColumns: mobile ? "1fr" : "1fr 1fr 1fr", gap: 16 }}>
            {[{ key: "month", label: "æœˆç›®æ¨™" }, { key: "quarter", label: "å­£ç›®æ¨™" }, { key: "year", label: "å¹´ç›®æ¨™" }].map(({ key, label }) => (
              <div key={key} style={{ background: C.surface, borderRadius: 12, padding: 16, border: `1px solid ${C.border}` }}>
                <div style={{ fontSize: 13, fontWeight: 700, color: C.gold, marginBottom: 12 }}>{label}</div>
                <div style={{ marginBottom: 10 }}>
                  <label style={{ display: "block", fontSize: 12, color: C.inkMuted, marginBottom: 4 }}>ç°½ç´„ä»¶æ•¸</label>
                  <input type="number" min="0" step="1" value={goalDraft[key].deals}
                    onChange={(e) => setGoalDraft({ ...goalDraft, [key]: { ...goalDraft[key], deals: Math.max(0, Number(e.target.value)) } })}
                    style={{ ...inputStyle, padding: "8px 12px", fontSize: 15, fontWeight: 700, fontFamily: "'JetBrains Mono',monospace" }} />
                </div>
                <div>
                  <label style={{ display: "block", fontSize: 12, color: C.inkMuted, marginBottom: 4 }}>ç‡Ÿæ”¶ç›®æ¨™ (NT$)</label>
                  <input type="number" min="0" step="10000" value={goalDraft[key].revenue}
                    onChange={(e) => setGoalDraft({ ...goalDraft, [key]: { ...goalDraft[key], revenue: Math.max(0, Number(e.target.value)) } })}
                    style={{ ...inputStyle, padding: "8px 12px", fontSize: 15, fontWeight: 700, fontFamily: "'JetBrains Mono',monospace" }} />
                </div>
              </div>
            ))}
          </div>
          <div style={{ display: "flex", gap: 10, justifyContent: "flex-end", marginTop: 18 }}>
            <Btn variant="ghost" size="sm" onClick={() => setShowGoalEditor(false)}>å–æ¶ˆ</Btn>
            <Btn color={C.emerald} size="sm" onClick={() => { onGoalsChange(goalDraft); setShowGoalEditor(false); }}>å„²å­˜ç›®æ¨™</Btn>
          </div>
        </div>
      )}

      {/* Goal Progress */}
      <div style={{ display: "grid", gridTemplateColumns: mobile ? "1fr" : "1fr 1fr", gap: 16, marginBottom: 24 }}>
        <HoverCard style={{ padding: 24 }}>
          <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 12 }}>
            <div style={{ fontSize: 14, fontWeight: 700, color: C.ink }}>ğŸ¯ {periodLabels[period]}ç°½ç´„ç›®æ¨™</div>
            <span style={{ fontSize: 22, fontWeight: 800, color: pctDeals >= 100 ? C.emerald : C.gold, fontFamily: "monospace" }}>{pctDeals}%</span>
          </div>
          <ProgressBar value={filteredWon.length} max={goal.deals} color={pctDeals >= 100 ? C.emerald : C.accent} />
          <div style={{ display: "flex", justifyContent: "space-between", marginTop: 8, fontSize: 12, color: C.inkMuted }}>
            <span>å·²ç°½ç´„ {filteredWon.length} ä»¶</span><span>ç›®æ¨™ {goal.deals} ä»¶</span>
          </div>
        </HoverCard>
        <HoverCard style={{ padding: 24 }}>
          <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 12 }}>
            <div style={{ fontSize: 14, fontWeight: 700, color: C.ink }}>ğŸ’° {periodLabels[period]}ç‡Ÿæ”¶ç›®æ¨™</div>
            <span style={{ fontSize: 22, fontWeight: 800, color: pctRevenue >= 100 ? C.emerald : C.gold, fontFamily: "monospace" }}>{pctRevenue}%</span>
          </div>
          <ProgressBar value={wonRevenue} max={goal.revenue} color={pctRevenue >= 100 ? C.emerald : C.gold} />
          <div style={{ display: "flex", justifyContent: "space-between", marginTop: 8, fontSize: 12, color: C.inkMuted }}>
            <span>å·²ç°½ç´„ {fmt(wonRevenue)}</span><span>ç›®æ¨™ {fmt(goal.revenue)}</span>
          </div>
        </HoverCard>
      </div>

      {/* Key Metrics */}
      <div style={{ display: "grid", gridTemplateColumns: mobile ? "1fr 1fr" : "repeat(4,1fr)", gap: 12, marginBottom: 24 }}>
        {[
          { label: `${periodLabels[period]}é€²ä»¶`, value: filtered.length, color: C.accent },
          { label: "ç®¡ç·šç¸½å€¼", value: fmt(pipelineValue), color: C.gold },
          { label: "å¹³å‡ç°½ç´„é€Ÿåº¦", value: avgVelocity > 0 ? `${avgVelocity} å¤©` : "â€”", color: C.cyan },
          { label: "ç°½ç´„ç‡", value: filtered.length > 0 ? `${Math.round((filteredWon.length / filtered.length) * 100)}%` : "â€”", color: C.emerald },
        ].map((s, i) => (
          <HoverCard key={i} style={{ padding: mobile ? "14px 16px" : "18px 22px" }}>
            <div style={{ fontSize: 12, color: C.inkMuted, marginBottom: 6, fontWeight: 500 }}>{s.label}</div>
            <div style={{ fontSize: mobile ? 20 : 24, fontWeight: 800, color: s.color, fontFamily: "'JetBrains Mono',monospace" }}>{s.value}</div>
          </HoverCard>
        ))}
      </div>

      {/* Deal Velocity Table */}
      <div style={{ marginBottom: 24 }}>
        <h3 style={{ fontSize: 16, fontWeight: 800, color: C.ink, marginBottom: 14 }}>âš¡ æ¡ˆä»¶é€Ÿåº¦åˆ†æ</h3>
        {velocityDeals.length === 0 ? (
          <div style={{ padding: 32, textAlign: "center", background: C.surface, borderRadius: 12, display: "flex", flexDirection: "column", alignItems: "center", gap: 12 }}>
            <HowlIdleCompanion message="é‚„æ²’æœ‰ç°½ç´„æ¡ˆä»¶...ä¾†æ‰¾éˆé­‚å§ã€‚" />
            <div style={{ fontSize: 13, color: C.inkMuted }}>å°šç„¡å·²ç°½ç´„æ¡ˆä»¶è³‡æ–™</div>
          </div>
        ) : (
          <div style={{ overflowX: "auto" }}>
            <table style={{ width: "100%", borderCollapse: "separate", borderSpacing: "0 4px" }}>
              <thead>
                <tr>{["æ¡ˆä»¶", "å…¬å¸", "é€²ä»¶æ—¥", "ç°½ç´„æ—¥", "å¤©æ•¸", "é‡‘é¡", "è©•ç´š"].map((h) => <th key={h} style={{ padding: "10px 14px", textAlign: "left", fontSize: 12, fontWeight: 600, color: C.inkMuted, borderBottom: `1px solid ${C.border}` }}>{h}</th>)}</tr>
              </thead>
              <tbody>
                {velocityDeals.map((d) => {
                  const days = Math.max(1, Math.round((new Date(d.signedDate) - new Date(d.created)) / 86400000));
                  const speed = days <= 14 ? { label: "ğŸš€ å¿«é€Ÿ", color: C.emerald } : days <= 30 ? { label: "âœ… æ­£å¸¸", color: C.accent } : { label: "ğŸ¢ åæ…¢", color: C.orange };
                  return (
                    <tr key={d.id}>
                      <td style={{ padding: "10px 14px", fontSize: 14, fontWeight: 600, color: C.ink, background: C.card, borderRadius: "8px 0 0 8px" }}>{d.name}</td>
                      <td style={{ padding: "10px 14px", fontSize: 13, color: C.inkSoft, background: C.card }}>{d.company}</td>
                      <td style={{ padding: "10px 14px", fontSize: 12, color: C.inkMuted, fontFamily: "monospace", background: C.card }}>{d.created}</td>
                      <td style={{ padding: "10px 14px", fontSize: 12, color: C.inkMuted, fontFamily: "monospace", background: C.card }}>{d.signedDate}</td>
                      <td style={{ padding: "10px 14px", fontSize: 14, fontWeight: 700, color: speed.color, fontFamily: "monospace", background: C.card }}>{days}</td>
                      <td style={{ padding: "10px 14px", fontSize: 13, color: C.gold, fontFamily: "monospace", background: C.card }}>{fmt(d.value)}</td>
                      <td style={{ padding: "10px 14px", background: C.card, borderRadius: "0 8px 8px 0" }}><Badge color={speed.color} bg={`${speed.color}15`} small>{speed.label}</Badge></td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>
        )}
      </div>

      {/* Stage Dwell Time Analysis */}
      {(() => {
        // Calculate avg days per stage from stageHistory
        const stageIds = ["inquiry", "exploring", "proposal", "negotiation"];
        const dwellData = stageIds.map((sid) => {
          const stageMeta = STAGES.find((s) => s.id === sid);
          const durations = [];
          allDeals.forEach((d) => {
            const hist = d.stageHistory || [];
            for (let i = 0; i < hist.length; i++) {
              if (hist[i].stage === sid) {
                const enter = new Date(hist[i].at);
                const exit = hist[i + 1] ? new Date(hist[i + 1].at) : (d.stage === sid ? new Date() : null);
                if (exit) durations.push(Math.max(1, Math.round((exit - enter) / 86400000)));
              }
            }
          });
          const avg = durations.length > 0 ? Math.round(durations.reduce((a, b) => a + b, 0) / durations.length) : 0;
          const max = durations.length > 0 ? Math.max(...durations) : 0;
          return { id: sid, label: stageMeta?.label || sid, icon: stageMeta?.icon || "ğŸ“", color: stageMeta?.color || C.inkMuted, avg, max, count: durations.length };
        });
        const maxAvg = Math.max(...dwellData.map((d) => d.avg), 1);
        const hasData = dwellData.some((d) => d.count > 0);
        return (
          <div style={{ marginBottom: 24 }}>
            <h3 style={{ fontSize: 16, fontWeight: 800, color: C.ink, marginBottom: 14 }}>ğŸ”¬ éšæ®µåœç•™å¤©æ•¸åˆ†æ</h3>
            {!hasData ? (
              <div style={{ padding: 24, textAlign: "center", color: C.inkMuted, fontSize: 14, background: C.surface, borderRadius: 12 }}>æ¡ˆä»¶éšæ®µæ­·å²è³‡æ–™ç´¯ç©ä¸­ï¼Œä½¿ç”¨ç³»çµ±å¾Œæ•¸æ“šå°‡è‡ªå‹•å»ºç«‹</div>
            ) : (
              <div style={{ display: "grid", gridTemplateColumns: mobile ? "1fr" : "1fr 1fr", gap: 12 }}>
                {dwellData.map((s) => (
                  <HoverCard key={s.id} style={{ padding: 20 }}>
                    <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 12 }}>
                      <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
                        <span style={{ fontSize: 16 }}>{s.icon}</span>
                        <span style={{ fontSize: 14, fontWeight: 700, color: s.color }}>{s.label}</span>
                      </div>
                      <span style={{ fontSize: 11, color: C.inkMuted }}>{s.count} æ¡ˆ</span>
                    </div>
                    <div style={{ display: "flex", alignItems: "flex-end", gap: 16, marginBottom: 8 }}>
                      <div>
                        <div style={{ fontSize: 10, color: C.inkMuted, marginBottom: 2 }}>å¹³å‡</div>
                        <div style={{ fontSize: 24, fontWeight: 800, color: s.avg > 14 ? C.orange : s.avg > 7 ? C.gold : C.emerald, fontFamily: "monospace" }}>{s.avg}<span style={{ fontSize: 12, fontWeight: 500, marginLeft: 2 }}>å¤©</span></div>
                      </div>
                      <div>
                        <div style={{ fontSize: 10, color: C.inkMuted, marginBottom: 2 }}>æœ€é•·</div>
                        <div style={{ fontSize: 16, fontWeight: 600, color: C.inkSoft, fontFamily: "monospace" }}>{s.max} å¤©</div>
                      </div>
                    </div>
                    {/* Bar chart */}
                    <div style={{ height: 8, background: C.surface, borderRadius: 4, overflow: "hidden" }}>
                      <div style={{ height: "100%", width: `${Math.round((s.avg / maxAvg) * 100)}%`, background: s.avg > 14 ? C.orange : s.avg > 7 ? C.gold : C.emerald, borderRadius: 4, transition: "width .6s ease" }} />
                    </div>
                    {s.avg > 14 && <div style={{ fontSize: 11, color: C.orange, marginTop: 6, fontWeight: 600 }}>âš ï¸ æ­¤éšæ®µå¯èƒ½æ˜¯ç“¶é ¸ï¼Œå»ºè­°å„ªåŒ–æµç¨‹</div>}
                  </HoverCard>
                ))}
              </div>
            )}
          </div>
        );
      })()}

      {/* Lost Reason Statistics */}
      {(() => {
        const lostDeals = allDeals.filter((d) => d.stage === "lost" && d.lostReason);
        if (lostDeals.length === 0) return null;
        const reasonCounts = {};
        lostDeals.forEach((d) => {
          const r = d.lostReason;
          if (!reasonCounts[r]) reasonCounts[r] = { count: 0, value: 0 };
          reasonCounts[r].count++;
          reasonCounts[r].value += d.value;
        });
        const sorted = Object.entries(reasonCounts).sort((a, b) => b[1].count - a[1].count);
        const maxCount = sorted.length > 0 ? sorted[0][1].count : 1;
        const totalLostValue = lostDeals.reduce((s, d) => s + d.value, 0);
        return (
          <div style={{ marginBottom: 24 }}>
            <h3 style={{ fontSize: 16, fontWeight: 800, color: C.ink, marginBottom: 14 }}>ğŸ’” æµå¤±åŸå› åˆ†æ</h3>
            <div style={{ display: "grid", gridTemplateColumns: mobile ? "1fr" : "1fr 1fr", gap: 16 }}>
              {/* Left: reason bars */}
              <HoverCard style={{ padding: 20 }}>
                <div style={{ fontSize: 13, fontWeight: 700, color: C.ink, marginBottom: 16 }}>æµå¤±åŸå› æ’è¡Œ</div>
                <div style={{ display: "flex", flexDirection: "column", gap: 10 }}>
                  {sorted.map(([rId, data]) => {
                    const rMeta = LOST_REASONS.find((r) => r.id === rId);
                    return (
                      <div key={rId}>
                        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 4 }}>
                          <span style={{ fontSize: 13, color: C.inkSoft }}>{rMeta?.icon || "ğŸ“"} {rMeta?.label || rId}</span>
                          <span style={{ fontSize: 13, fontWeight: 700, color: C.rose, fontFamily: "monospace" }}>{data.count} æ¡ˆ</span>
                        </div>
                        <div style={{ height: 6, background: C.surface, borderRadius: 3, overflow: "hidden" }}>
                          <div style={{ height: "100%", width: `${Math.round((data.count / maxCount) * 100)}%`, background: C.rose, borderRadius: 3, transition: "width .5s ease" }} />
                        </div>
                      </div>
                    );
                  })}
                </div>
              </HoverCard>
              {/* Right: summary stats */}
              <div style={{ display: "flex", flexDirection: "column", gap: 12 }}>
                <HoverCard style={{ padding: 20 }}>
                  <div style={{ fontSize: 12, color: C.inkMuted, marginBottom: 6 }}>æµå¤±æ¡ˆä»¶ç¸½æ•¸</div>
                  <div style={{ fontSize: 28, fontWeight: 800, color: C.rose, fontFamily: "monospace" }}>{lostDeals.length}</div>
                </HoverCard>
                <HoverCard style={{ padding: 20 }}>
                  <div style={{ fontSize: 12, color: C.inkMuted, marginBottom: 6 }}>æµå¤±ç¸½é‡‘é¡</div>
                  <div style={{ fontSize: 22, fontWeight: 800, color: C.rose, fontFamily: "monospace" }}>{fmt(totalLostValue)}</div>
                </HoverCard>
                <HoverCard style={{ padding: 20 }}>
                  <div style={{ fontSize: 12, color: C.inkMuted, marginBottom: 6 }}>æœ€å¸¸è¦‹æµå¤±åŸå› </div>
                  <div style={{ fontSize: 15, fontWeight: 700, color: C.ink }}>{(() => { const top = LOST_REASONS.find((r) => r.id === sorted[0]?.[0]); return top ? `${top.icon} ${top.label}` : "â€”"; })()}</div>
                </HoverCard>
              </div>
            </div>
          </div>
        );
      })()}

      {/* Role Performance */}
      <div>
        <h3 style={{ fontSize: 16, fontWeight: 800, color: C.ink, marginBottom: 14 }}>ğŸ‘¥ {periodLabels[period]}è§’è‰²æ¥­ç¸¾æ’è¡Œ</h3>
        <div style={{ display: "grid", gridTemplateColumns: mobile ? "1fr" : "repeat(auto-fill, minmax(280px, 1fr))", gap: 12 }}>
          {rolePerf.sort((a, b) => b.wonRevenue - a.wonRevenue).map((r) => (
            <HoverCard key={r.id} style={{ padding: 20, borderTop: `3px solid ${r.color}` }}>
              <div style={{ display: "flex", alignItems: "center", gap: 10, marginBottom: 14 }}>
                <span style={{ fontSize: 26 }}>{r.emoji}</span>
                <div>
                  <div style={{ fontSize: 16, fontWeight: 800, color: r.color }}>{r.name}</div>
                  <div style={{ fontSize: 12, color: C.inkMuted }}>{r.title}</div>
                </div>
              </div>
              <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 10 }}>
                <div style={{ background: C.surface, borderRadius: 8, padding: "8px 12px" }}>
                  <div style={{ fontSize: 10, color: C.inkMuted }}>é€²ä»¶</div>
                  <div style={{ fontSize: 18, fontWeight: 700, color: C.accent, fontFamily: "monospace" }}>{r.totalDeals}</div>
                </div>
                <div style={{ background: C.surface, borderRadius: 8, padding: "8px 12px" }}>
                  <div style={{ fontSize: 10, color: C.inkMuted }}>ç°½ç´„</div>
                  <div style={{ fontSize: 18, fontWeight: 700, color: C.emerald, fontFamily: "monospace" }}>{r.wonCount}</div>
                </div>
                <div style={{ background: C.surface, borderRadius: 8, padding: "8px 12px" }}>
                  <div style={{ fontSize: 10, color: C.inkMuted }}>ç°½ç´„é‡‘é¡</div>
                  <div style={{ fontSize: 14, fontWeight: 700, color: C.gold, fontFamily: "monospace" }}>{fmt(r.wonRevenue)}</div>
                </div>
                <div style={{ background: C.surface, borderRadius: 8, padding: "8px 12px" }}>
                  <div style={{ fontSize: 10, color: C.inkMuted }}>å¹³å‡é€Ÿåº¦</div>
                  <div style={{ fontSize: 14, fontWeight: 700, color: C.cyan, fontFamily: "monospace" }}>{r.avgVelocity > 0 ? `${r.avgVelocity} å¤©` : "â€”"}</div>
                </div>
              </div>
            </HoverCard>
          ))}
        </div>
      </div>
    </div>
  );
};

// â”€â”€ Documents / Templates View â”€â”€
const DocumentsView = ({ userDocs, onAddDoc, onDeleteDoc, showAddForm, onCloseForm }) => {
  const { mobile } = useWindowSize();
  const [catFilter, setCatFilter] = useState("å…¨éƒ¨");
  const [copied, setCopied] = useState(null);
  const [newDoc, setNewDoc] = useState({ name: "", url: "", category: "å…¶ä»–", desc: "" });

  const docs = userDocs || [];
  const filtered = catFilter === "å…¨éƒ¨" ? docs : docs.filter((d) => d.category === catFilter);
  const usedCats = ["å…¨éƒ¨", ...DOC_CATEGORIES.filter(c => c !== "å…¨éƒ¨" && docs.some(d => d.category === c))];

  const copyLink = (id, url) => {
    navigator.clipboard?.writeText(url).then(() => {
      setCopied(id);
      setTimeout(() => setCopied(null), 2000);
    });
  };

  const detectFormat = (url) => {
    const ext = url.match(/\.(pdf|docx?|xlsx?|pptx?|csv|txt)/i)?.[1]?.toUpperCase();
    if (ext) return ext;
    if (url.includes("drive.google.com")) return "GDRIVE";
    if (url.includes("dropbox.com")) return "DBOX";
    if (url.includes("notion.so") || url.includes("notion.site")) return "NOTION";
    if (url.includes("figma.com")) return "FIGMA";
    return "LINK";
  };

  const formatIcons = { PDF: "ğŸ“•", DOCX: "ğŸ“„", DOC: "ğŸ“„", PPTX: "ğŸ“Š", PPT: "ğŸ“Š", XLSX: "ğŸ“—", XLS: "ğŸ“—", CSV: "ğŸ“—", GDRIVE: "â˜ï¸", DBOX: "ğŸ“¦", NOTION: "ğŸ“", FIGMA: "ğŸ¨", LINK: "ğŸ”—", TXT: "ğŸ“ƒ" };
  const formatColors = { DOCX: C.accent, DOC: C.accent, PPTX: C.orange, PPT: C.orange, PDF: C.rose, XLSX: C.emerald, XLS: C.emerald, CSV: C.emerald, GDRIVE: C.cyan, DBOX: C.accent, NOTION: C.inkSoft, FIGMA: C.violet, LINK: C.cyan, TXT: C.inkSoft };

  const handleAddDoc = () => {
    if (!newDoc.name || !newDoc.url) return;
    const fmt = detectFormat(newDoc.url);
    const doc = { id: "doc_" + Date.now(), name: newDoc.name, url: newDoc.url, category: newDoc.category || "å…¶ä»–", icon: formatIcons[fmt] || "ğŸ“", format: fmt, desc: newDoc.desc || "", custom: true };
    onAddDoc(doc);
    setNewDoc({ name: "", url: "", category: "å…¶ä»–", desc: "" });
    if (onCloseForm) onCloseForm();
  };

  return (
    <div>
      <div style={{ fontSize: 15, color: C.inkSoft, marginBottom: 20, lineHeight: 1.7 }}>
        ä½ çš„æ¥­å‹™æ–‡ä»¶è³‡æºåº«ã€‚è²¼ä¸Š Google Driveã€Dropboxã€Notion æˆ–ä»»ä½•é€£çµä¾†çµ±ä¸€ç®¡ç†æ–‡ä»¶ã€‚
      </div>

      {/* Category filter â€” only show categories that have docs */}
      {docs.length > 0 && (
        <div style={{ display: "flex", gap: 6, marginBottom: 20, flexWrap: "wrap" }}>
          {usedCats.map((cat) => {
            const count = cat === "å…¨éƒ¨" ? docs.length : docs.filter(d => d.category === cat).length;
            return (
              <button key={cat} onClick={() => setCatFilter(cat)}
                style={{ padding: "6px 16px", borderRadius: 20, border: catFilter === cat ? `1.5px solid ${C.accent}` : `1px solid ${C.border}`, background: catFilter === cat ? `${C.accent}15` : "transparent", color: catFilter === cat ? C.accent : C.inkMuted, fontSize: 13, fontWeight: 600, cursor: "pointer", fontFamily: "inherit", transition: T }}>
                {cat} ({count})
              </button>
            );
          })}
        </div>
      )}

      {/* Add Document Form */}
      {showAddForm && (
        <div style={{ background: C.card, border: `1px solid ${C.borderHover}`, borderRadius: 14, padding: mobile ? 18 : 24, marginBottom: 20 }}>
          <div style={{ fontSize: 16, fontWeight: 700, color: C.ink, marginBottom: 16 }}>ğŸ“ æ–°å¢æ–‡ä»¶</div>
          <div style={{ display: "grid", gridTemplateColumns: mobile ? "1fr" : "1fr 1fr", gap: 12, marginBottom: 12 }}>
            <div>
              <label style={{ fontSize: 12, color: C.inkMuted, marginBottom: 4, display: "block" }}>æ–‡ä»¶åç¨± *</label>
              <input value={newDoc.name} onChange={(e) => setNewDoc({ ...newDoc, name: e.target.value })} placeholder="ä¾‹ï¼šQ1 å®¢æˆ¶ææ¡ˆç°¡å ±"
                style={{ width: "100%", padding: "10px 14px", borderRadius: 10, border: `1px solid ${C.border}`, background: C.surface, color: C.ink, fontSize: 14, outline: "none", fontFamily: "inherit", boxSizing: "border-box" }} />
            </div>
            <div>
              <label style={{ fontSize: 12, color: C.inkMuted, marginBottom: 4, display: "block" }}>åˆ†é¡</label>
              <select value={newDoc.category} onChange={(e) => setNewDoc({ ...newDoc, category: e.target.value })}
                style={{ width: "100%", padding: "10px 14px", borderRadius: 10, border: `1px solid ${C.border}`, background: C.surface, color: C.ink, fontSize: 14, outline: "none", fontFamily: "inherit", boxSizing: "border-box" }}>
                {DOC_CATEGORIES.filter(c => c !== "å…¨éƒ¨").map(c => <option key={c} value={c}>{c}</option>)}
              </select>
            </div>
          </div>
          <div style={{ marginBottom: 12 }}>
            <label style={{ fontSize: 12, color: C.inkMuted, marginBottom: 4, display: "block" }}>é€£çµ URL *</label>
            <input value={newDoc.url} onChange={(e) => setNewDoc({ ...newDoc, url: e.target.value })} placeholder="https://drive.google.com/file/d/... æˆ–ä»»ä½•é€£çµ"
              style={{ width: "100%", padding: "10px 14px", borderRadius: 10, border: `1px solid ${C.border}`, background: C.surface, color: C.ink, fontSize: 14, outline: "none", fontFamily: "inherit", boxSizing: "border-box" }} />
            <div style={{ fontSize: 11, color: C.inkMuted, marginTop: 4 }}>æ”¯æ´ï¼šGoogle Driveã€Dropboxã€Notionã€Figmaã€æˆ–ä»»ä½•å¯é–‹å•Ÿçš„ç¶²å€</div>
          </div>
          <div style={{ marginBottom: 16 }}>
            <label style={{ fontSize: 12, color: C.inkMuted, marginBottom: 4, display: "block" }}>å‚™è¨»èªªæ˜</label>
            <input value={newDoc.desc} onChange={(e) => setNewDoc({ ...newDoc, desc: e.target.value })} placeholder="ç°¡è¿°æ–‡ä»¶ç”¨é€”..."
              style={{ width: "100%", padding: "10px 14px", borderRadius: 10, border: `1px solid ${C.border}`, background: C.surface, color: C.ink, fontSize: 14, outline: "none", fontFamily: "inherit", boxSizing: "border-box" }} />
          </div>
          <div style={{ display: "flex", gap: 10 }}>
            <Btn color={C.emerald} size="sm" onClick={handleAddDoc}>æ–°å¢</Btn>
            <Btn variant="ghost" size="sm" onClick={onCloseForm}>å–æ¶ˆ</Btn>
          </div>
        </div>
      )}

      {/* Document cards */}
      {filtered.length > 0 ? (
        <div style={{ display: "grid", gridTemplateColumns: mobile ? "1fr" : "repeat(auto-fill, minmax(340px, 1fr))", gap: 12 }}>
          {filtered.map((doc) => (
            <HoverCard key={doc.id} style={{ padding: 20 }}>
              <div style={{ display: "flex", gap: 14, alignItems: "flex-start" }}>
                <span style={{ fontSize: 28, flexShrink: 0 }}>{doc.icon || "ğŸ“"}</span>
                <div style={{ flex: 1, minWidth: 0 }}>
                  <div style={{ display: "flex", alignItems: "center", gap: 8, marginBottom: 4 }}>
                    <div style={{ fontSize: 15, fontWeight: 700, color: C.ink, wordBreak: "break-word" }}>{doc.name}</div>
                    <Badge color={formatColors[doc.format] || C.cyan} bg={`${formatColors[doc.format] || C.cyan}15`} small>{doc.format}</Badge>
                  </div>
                  {doc.desc && <div style={{ fontSize: 13, color: C.inkSoft, lineHeight: 1.6, marginBottom: 12 }}>{doc.desc}</div>}
                  <div style={{ display: "flex", gap: 8, flexWrap: "wrap" }}>
                    <Btn color={C.accent} size="sm" onClick={() => window.open(doc.url, "_blank")}>é–‹å•Ÿ</Btn>
                    <Btn variant="secondary" color={copied === doc.id ? C.emerald : C.inkMuted} size="sm" onClick={() => copyLink(doc.id, doc.url)}>
                      {copied === doc.id ? "å·²è¤‡è£½" : "è¤‡è£½é€£çµ"}
                    </Btn>
                    <Btn variant="secondary" color={C.rose} size="sm" onClick={() => onDeleteDoc(doc.id)}>åˆªé™¤</Btn>
                  </div>
                </div>
              </div>
            </HoverCard>
          ))}
        </div>
      ) : (
        <div style={{ textAlign: "center", padding: "60px 20px" }}>
          <TurnipIdleCompanion message="...é€™è£¡é‚„ç©ºç©ºçš„ã€‚" />
          <div style={{ marginTop: 16, fontSize: 16, fontWeight: 700, color: C.ink, marginBottom: 8 }}>{catFilter === "å…¨éƒ¨" ? "å°šæœªæ–°å¢ä»»ä½•æ–‡ä»¶" : `ã€Œ${catFilter}ã€åˆ†é¡å°šç„¡æ–‡ä»¶`}</div>
          <div style={{ fontSize: 14, color: C.inkMuted, marginBottom: 20, lineHeight: 1.6 }}>é»æ“Šä¸Šæ–¹ã€Œ+ æ–°å¢æ–‡ä»¶ã€é–‹å§‹å»ºç«‹ä½ çš„æ¥­å‹™æ–‡ä»¶åº«<br/>å¯è²¼ä¸Š Google Driveã€Dropbox æˆ–ä»»ä½•æª”æ¡ˆé€£çµ</div>
        </div>
      )}
    </div>
  );
};

// â”€â”€ Roles Management View â”€â”€
const RolesView = ({ roles, onAdd, onEdit, onArchive }) => {
  const { mobile } = useWindowSize();
  return (
    <div>
      <div style={{ fontSize: 15, color: C.inkSoft, marginBottom: 20, lineHeight: 1.7 }}>ç®¡ç†åŸå ¡è§’è‰²ã€‚æ–°å¢è‡ªè¨‚è§’è‰²ã€ä¿®æ”¹åç¨±èˆ‡åœ–ç¤ºï¼Œæˆ–å°å­˜ä¸å†ä½¿ç”¨çš„è§’è‰²ã€‚</div>
      <div style={{ display: "grid", gridTemplateColumns: mobile ? "1fr" : "repeat(3,1fr)", gap: 14 }}>
        {roles.filter((r) => !r.archived).map((r) => (
          <HoverCard key={r.id} style={{ padding: 24, borderTop: `3px solid ${r.color}` }}>
            <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start" }}>
              <div style={{ display: "flex", alignItems: "center", gap: 12 }}>
                <span style={{ fontSize: 32 }}>{r.emoji}</span>
                <div>
                  <div style={{ fontSize: 18, fontWeight: 800, color: r.color }}>{r.name}</div>
                  <div style={{ fontSize: 13, color: C.inkMuted }}>{r.title}</div>
                </div>
              </div>
              <div style={{ display: "flex", gap: 6 }}>
                <Btn small color={C.accent} onClick={() => onEdit(r)}>ç·¨è¼¯</Btn>
                <Btn variant="secondary" color={C.rose} size="sm" onClick={() => onArchive(r.id)}>å°å­˜</Btn>
              </div>
            </div>
          </HoverCard>
        ))}
        {/* Add new role card */}
        <button onClick={onAdd} style={{ background: "transparent", border: `2px dashed ${C.border}`, borderRadius: 12, padding: 24, cursor: "pointer", display: "flex", flexDirection: "column", alignItems: "center", justifyContent: "center", gap: 10, minHeight: 110, transition: T }}>
          <span style={{ fontSize: 28, color: C.inkMuted }}>+</span>
          <span style={{ fontSize: 14, color: C.inkMuted, fontFamily: "inherit" }}>æ–°å¢è§’è‰²</span>
        </button>
      </div>
    </div>
  );
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ® Pixel Art â€” Howl's Moving Castle World
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Pixel renderer: uses CSS box-shadow to draw pixel art (no images)
const px = (size, grid) => {
  const shadows = [];
  grid.forEach((row, y) => {
    [...row].forEach((ch, x) => {
      const c = {
        "#": "#3a3a5c", "W": "#e8e8f0", "B": "#6C8EFF", "F": "#FB923C", "R": "#F472B6",
        "G": "#34D399", "Y": "#F5A623", "V": "#A78BFA", "D": "#1c1c28", "S": "#8888aa",
        "O": "#FB923C", "L": "#22D3EE", "C": "#cc5533",
        // Extended palette for characters (matched to bead art reference)
        "H": "#FFD700", // Howl's golden hair (bright)
        "h": "#C4A000", // Howl hair shadow
        "P": "#FDDCB5", // Skin/peach (warm)
        "p": "#E8A090", // Skin shadow
        "K": "#1a1a2a", // Black coat/clothes
        "k": "#3a3a5c", // Dark grey fabric
        "M": "#CD7F32", // Brown/orange hair
        "m": "#A0522D", // Darker brown hair
        "T": "#D2691E", // Tan/brown
        "t": "#F4A460", // Sandy brown / straw hat
        "e": "#4CAF50", // Markl green outfit (brighter)
        "g": "#2E7D32", // Darker green
        "b": "#4A90D9", // Sophie blue dress
        "a": "#7BB8F0", // Sophie light blue
        "r": "#CC3333", // Red accent / Howl coat lining
        "w": "#DCDCDC", // Light grey / white gloves
        "n": "#8B7355", // Wood/stick brown
        "I": "#FFE4B5", // Light skin
        "i": "#DEB887", // Darker skin
        "E": "#C0C0C0", // Silver/metal
        "Z": "#708090", // Slate grey (metal parts)
        "q": "#8B0000", // Dark red (roof)
        "u": "#CD853F", // Peru (building)
        "1": "#FF6600", // Calcifer bright orange
        "2": "#FF4400", // Calcifer deep orange
        "3": "#FFaa00", // Calcifer yellow-orange
        "4": "#663311", // Dark wood (log)
        "5": "#995522", // Medium wood
        "6": "#BB7744", // Light wood
        "7": "#FFEE88", // Howl bright yellow hair
        "8": "#DD8855", // Coat rust/tan highlight
        "9": "#556688", // Dark blue-grey (Howl coat outer)
      }[ch];
      if (c) shadows.push(`${x * size}px ${y * size}px 0 0 ${c}`);
    });
  });
  return shadows.join(",");
};

// ğŸ° Moving Castle pixel sprite (16x18) â€” enhanced with wings, chimneys, flags
const CASTLE_FRAMES = [
  [
    "     E          ",
    "    EZE    S    ",
    "   EZZE   SS    ",
    "  ##ZZ## SSS    ",
    "  #qWq##RVRV   ",
    " ##qWq###       ",
    " #WWnWW##qqqq  ",
    "##WWnWWW#quuq# ",
    "#GGnnnGG#uuuu# ",
    "#WWuuuWW##uu## ",
    "##uBuBu####WW# ",
    " #uuuuuuWWWW## ",
    " ##uuBuuWWBW#  ",
    "  ##uuuu###W#  ",
    "  #ZZZZ#ZZZ#   ",
    "  #Z  Z#Z Z#   ",
    "   Z  Z Z Z    ",
    "   Z    Z      ",
  ],
  [
    "     E          ",
    "    EZE    S    ",
    "   EZZE   SS    ",
    "  ##ZZ## SSS    ",
    "  #qWq##VRVRV  ",
    " ##qWq###       ",
    " #WWnWW##qqqq  ",
    "##WWnWWW#quuq# ",
    "#GGnnnGG#uuuu# ",
    "#WWuuuWW##uu## ",
    "##uBuBu####WW# ",
    " #uuuuuuWWWW## ",
    " ##uuBuuWWBW#  ",
    "  ##uuuu###W#  ",
    "  #ZZZZ#ZZZ#   ",
    "  #Z  Z#Z Z#   ",
    "   Z  Z  Z Z   ",
    "    Z    Z     ",
  ],
];

// ğŸ”¥ Calcifer pixel sprite (10x9) â€” based on bead art: flame with face on logs
const CALCIFER_FRAMES = [
  [
    "   3YY3   ",
    "  31OO13  ",
    " 3O1FF1O3 ",
    " 1FFFFFF1 ",
    "O1FFFFFF1O",
    " 1FKFFKF1 ",
    " 1FF22FF1 ",
    "  456654  ",
    "  44  44  ",
  ],
  [
    "  3Y3YY   ",
    "  31OO13  ",
    "  O1FF1O3 ",
    " 1FFFFFF1 ",
    "31FFFFFF1O",
    " 1FKFFKF1 ",
    " 1FF22FF1 ",
    "  456654  ",
    "   44 44  ",
  ],
];

// ğŸ¥• Turnip Head pixel sprite (11x16) â€” scarecrow with top hat, outstretched arms, stick
const TURNIP_FRAMES = [
  [
    "    KKK    ",
    "   KKKKK   ",
    "   KRRRK   ",
    "   KKKKK   ",
    "    PPP    ",
    "   PkPkP   ",
    "    PPP    ",
    "  w KBKK w ",
    " ww KKKK ww",
    "    KKKK   ",
    "    KKKK   ",
    "    K  K   ",
    "    K  K   ",
    "     nn    ",
    "     nn    ",
    "     nn    ",
  ],
  [
    "    KKK    ",
    "   KKKKK   ",
    "   KRRRK   ",
    "   KKKKK   ",
    "    PPP    ",
    "   PkPkP   ",
    "    PPP    ",
    " w  KBKK  w",
    "ww  KKKK  w",
    "    KKKK   ",
    "    KKKK   ",
    "    K  K   ",
    "    K  K   ",
    "     nn    ",
    "     nn    ",
    "      nn   ",
  ],
];

// ğŸ§™ Howl pixel sprite (12x18) â€” based on bead art: golden hair, dark coat with red/rainbow lining, walking
const HOWL_FRAMES = [
  [
    "    7HHH    ",
    "   7HHHHH   ",
    "   H7HHhH   ",
    "   PPPPPH   ",
    "   PkPkPh   ",
    "    PPPP    ",
    "   9rYr9K   ",
    "  9KrFr9KK  ",
    "  9Kr8r9K   ",
    "  9KKKKK    ",
    "   KKKKK    ",
    "   K9K9K    ",
    "   KK KK    ",
    "   KK KK    ",
    "   KK  KK   ",
    "   KK  KK   ",
    "   KK  KK   ",
    "   ##  ##   ",
  ],
  [
    "    7HHH    ",
    "   7HHHHH   ",
    "   H7HHhH   ",
    "   PPPPPH   ",
    "   PkPkPh   ",
    "    PPPP    ",
    "   9rYr9K   ",
    "  9KrFr9KK  ",
    "  9Kr8r9K   ",
    "  9KKKKK    ",
    "   KKKKK    ",
    "   K9K9K    ",
    "   KK KK    ",
    "    KK KK   ",
    "   KK   KK  ",
    "   KK   KK  ",
    "   ##    KK ",
    "         ## ",
  ],
];

// ğŸŒ¸ Sophie pixel sprite (10x16) â€” based on bead art: straw hat with red band, brown hair, blue dress, walking stick
const SOPHIE_FRAMES = [
  [
    "   ttttt   ",
    "  ttttttt  ",
    "  trrrrrt  ",
    "  tttttt   ",
    "   MmMm    ",
    "  MMMMMM   ",
    "   PPPPP   ",
    "   PkPkP   ",
    "    PPP    ",
    "   bbbbb   ",
    "  bbbbbbb  ",
    "  bababbb  ",
    "  bbbbbbb  ",
    "   bbbbb   ",
    "   PP PP n ",
    "   ## ## n ",
  ],
  [
    "   ttttt   ",
    "  ttttttt  ",
    "  trrrrrt  ",
    "  tttttt   ",
    "   MmMm    ",
    "  MMMMMM   ",
    "   PPPPP   ",
    "   PkPkP   ",
    "    PPP    ",
    "   bbbbb   ",
    "  bbbbbbb  ",
    "  bababbb  ",
    "  bbbbbbb  ",
    "   bbbbb   ",
    "    PP PP n",
    "    ## ##n ",
  ],
];

// ğŸŒ¿ Markl pixel sprite (9x13) â€” based on bead art: small kid, messy orange-brown hair, green tunic
const MARKL_FRAMES = [
  [
    "  mMMMm  ",
    " MmMMMmM ",
    " MMMMMM  ",
    "  PPPPP  ",
    "  PkPkP  ",
    "   PPP   ",
    "  eeeee  ",
    " eeeeeee ",
    " eegegee ",
    "  eeeee  ",
    "  ee ee  ",
    "  PP PP  ",
    "  #   #  ",
  ],
  [
    "  mMMMm  ",
    " MmMMMmM ",
    " MMMMMM  ",
    "  PPPPP  ",
    "  PkPkP  ",
    "   PPP   ",
    "  eeeee  ",
    " eeeeeee ",
    " eegegee ",
    "  eeeee  ",
    "  ee ee  ",
    "   PP PP ",
    "   #   # ",
  ],
];

// âœ¨ Magic sparkle frames (5x5)
const SPARKLE_FRAMES = [
  [
    "  L  ",
    " LLL ",
    "LLLLL",
    " LLL ",
    "  L  ",
  ],
  [
    "  L  ",
    "     ",
    "L L L",
    "     ",
    "  L  ",
  ],
];

// Pixel art sprite component â€” renders pixel grid using box-shadow
const PixelSprite = ({ frames, size = 2, interval = 500, style = {} }) => {
  const [frame, setFrame] = useState(0);
  useEffect(() => {
    if (frames.length <= 1) return;
    const id = setInterval(() => setFrame((f) => (f + 1) % frames.length), interval);
    return () => clearInterval(id);
  }, [frames.length, interval]);
  const shadow = px(size, frames[frame]);
  const w = frames[0][0].length * size;
  const h = frames[0].length * size;
  return React.createElement("div", {
    style: { width: w, height: h, position: "relative", ...style },
  }, React.createElement("div", {
    style: { position: "absolute", top: 0, left: 0, width: size, height: size, boxShadow: shadow, willChange: "box-shadow" },
  }));
};

// ğŸ° Footer parade â€” castle + characters walking across the bottom
const PARADE_GROUPS = [
  { frames: CASTLE_FRAMES, size: 2, interval: 400, offsetY: -4, label: null },
  { frames: HOWL_FRAMES, size: 2, interval: 500, offsetY: 0, label: "ğŸ§™ éœçˆ¾", gap: 36 },
  { frames: CALCIFER_FRAMES, size: 2, interval: 300, offsetY: 18, label: "ğŸ”¥ å¡è¥¿æ³•", gap: 12 },
  { frames: SOPHIE_FRAMES, size: 2, interval: 500, offsetY: 4, label: "ğŸŒ¸ è˜‡è²", gap: 28 },
  { frames: MARKL_FRAMES, size: 2, interval: 450, offsetY: 10, label: "ğŸŒ¿ é¦¬é­¯å…‹", gap: 22 },
  { frames: TURNIP_FRAMES, size: 2, interval: 600, offsetY: 4, label: "ğŸ¥• è•ªèé ­", gap: 26 },
];

// ğŸ­ Character dialogue scenes â€” random interactions between characters
// Parade order: 0=Castle, 1=Howl, 2=Calcifer, 3=Sophie, 4=Markl, 5=Turnip
const DIALOGUE_SCENES = [
  { speaker: 1, text: "é€™ç”¢å“éœ€è¦æ›´å¤šéˆé­‚...", color: C.accent },
  { speaker: 3, text: "å…ˆç¢ºèªç”¨æˆ¶æ˜¯èª°ï¼", color: C.rose },
  { speaker: 2, text: "å‘Šè¨´æˆ‘è¦ä»€éº¼ï¼Œäº¤çµ¦æˆ‘ï¼", color: C.orange },
  { speaker: 1, text: "è®“æˆ‘æŠŠæ•…äº‹èªªå¾—ç„¡æ³•æŠ—æ‹’", color: C.accent },
  { speaker: 4, text: "æˆªæ­¢æ—¥æ˜¯ä»€éº¼æ™‚å€™ï¼Ÿ", color: C.emerald },
  { speaker: 5, text: "...æ•¸æ“šä¸æ˜¯é€™æ¨£èªªçš„ã€‚", color: C.violet },
  { speaker: 3, text: "ROI ç®—éäº†å—ï¼Ÿ", color: C.rose },
  { speaker: 2, text: "ä¸‰å¤©ï¼Œä½†éœ€æ±‚ä¸èƒ½å†æ”¹äº†ï¼", color: C.orange },
  { speaker: 1, text: "å¹³åº¸çš„è¨­è¨ˆï¼Ÿé‡ä¾†ã€‚", color: C.accent },
  { speaker: 4, text: "æ”¶åˆ°ï¼æ•´ç†æˆä¸‰å€‹ action items", color: C.emerald },
  { speaker: 5, text: "...å…ˆè§€å¯Ÿã€‚", color: C.violet },
  { speaker: 3, text: "é ç®—è¦æŠ“ç·Šå•Šï¼", color: C.rose },
  { speaker: 2, text: "æŠ€è¡“ä¸Šæ²’å•é¡Œï¼Œäº¤çµ¦æˆ‘ç‡’", color: C.orange },
  { speaker: 1, text: "æˆ‘çœ‹åˆ°å·®ç•°åŒ–äº†ï¼", color: C.accent },
  { speaker: 4, text: "é€²åº¦æˆ‘ä¾†è¿½è¹¤ï¼", color: C.emerald },
  { speaker: 5, text: "ç”¨æˆ¶èªªçš„å’Œåšçš„ä¸ä¸€æ¨£", color: C.violet },
  { speaker: 3, text: "é€™ç¯‡æ–‡æ¡ˆå¯ä»¥æ›´æœ‰æº«åº¦", color: C.rose },
  { speaker: 4, text: "Checklist å·²æ›´æ–°ï¼", color: C.emerald },
  { speaker: 2, text: "åˆè¦åŠ éœ€æ±‚...æˆ‘è¦ç‡’å…‰äº†", color: C.orange },
];

const CastleParade = () => {
  const [pos, setPos] = useState(-280);
  const [visible, setVisible] = useState(false);
  const [hovered, setHovered] = useState(null);
  const [dialogue, setDialogue] = useState(null);
  const timer = useRef(null);
  const dialogueTimer = useRef(null);
  const dialogueIdx = useRef(0);

  useEffect(() => {
    const first = setTimeout(() => { setPos(-280); setVisible(true); }, 6000);
    return () => { clearTimeout(first); clearTimeout(timer.current); clearInterval(dialogueTimer.current); };
  }, []);

  // Random dialogue bubbles while walking
  useEffect(() => {
    if (!visible) { setDialogue(null); return; }
    const showNext = () => {
      const scene = DIALOGUE_SCENES[dialogueIdx.current % DIALOGUE_SCENES.length];
      dialogueIdx.current++;
      setDialogue(scene);
      setTimeout(() => setDialogue(null), 3000);
    };
    const delay = setTimeout(showNext, 3000);
    dialogueTimer.current = setInterval(showNext, 8000);
    return () => { clearTimeout(delay); clearInterval(dialogueTimer.current); };
  }, [visible]);

  useEffect(() => {
    if (!visible) return;
    const id = setInterval(() => {
      setPos((p) => {
        if (p > window.innerWidth + 300) {
          setVisible(false);
          timer.current = setTimeout(() => { setPos(-280); setVisible(true); dialogueIdx.current = Math.floor(Math.random() * DIALOGUE_SCENES.length); }, 40000);
          return -280;
        }
        return p + 0.5;
      });
    }, 30);
    return () => clearInterval(id);
  }, [visible]);

  if (!visible) return null;

  return React.createElement("div", {
    style: { position: "fixed", bottom: 44, left: pos, zIndex: 50, display: "flex", alignItems: "flex-end", opacity: hovered !== null ? 0.9 : 0.5, transition: "opacity .5s", pointerEvents: "auto" },
  },
    PARADE_GROUPS.map((g, i) => {
      return React.createElement("div", {
        key: i,
        style: { marginLeft: g.gap || 0, marginBottom: g.offsetY || 0, position: "relative", cursor: "default" },
        onMouseEnter: () => setHovered(i),
        onMouseLeave: () => setHovered(null),
      },
        // Character name on hover
        hovered === i && g.label && React.createElement("div", {
          style: { position: "absolute", top: -22, left: "50%", transform: "translateX(-50%)", fontSize: 10, color: C.accent, whiteSpace: "nowrap", animation: "fadeSlideUp .3s ease", pointerEvents: "none", textShadow: "0 1px 4px rgba(0,0,0,.9)" },
        }, g.label),
        // Dialogue bubble â€” shows above the speaking character
        dialogue && dialogue.speaker === i && React.createElement("div", {
          style: {
            position: "absolute", top: -40, left: "50%", transform: "translateX(-50%)",
            background: `${C.card}ee`, border: `1px solid ${dialogue.color}40`,
            borderRadius: 8, padding: "4px 10px", fontSize: 10, color: dialogue.color,
            whiteSpace: "nowrap", animation: "fadeSlideUp .4s ease", pointerEvents: "none",
            boxShadow: `0 2px 12px rgba(0,0,0,.5), 0 0 8px ${dialogue.color}15`,
            fontWeight: 600, letterSpacing: ".01em",
          },
        }, dialogue.text),
        React.createElement(PixelSprite, { frames: g.frames, size: g.size, interval: g.interval })
      );
    })
  );
};

// ğŸ”¥ Calcifer companion â€” floats near sync button, reacts to hover, click shows changelog
const CalciferCompanion = ({ syncing, onShowChangelog }) => {
  const [happy, setHappy] = useState(false);
  return React.createElement("div", {
    style: { display: "inline-flex", alignItems: "center", cursor: "pointer", position: "relative" },
    onMouseEnter: () => setHappy(true),
    onMouseLeave: () => setHappy(false),
    onClick: onShowChangelog,
    title: syncing ? "å¡è¥¿æ³•æ­£åœ¨ç‡ƒç‡’åŒæ­¥ä¸­..." : "ğŸ”¥ é»æ“Šå¡è¥¿æ³•æŸ¥çœ‹æ›´ç‰ˆç´€éŒ„",
  },
    React.createElement("div", {
      style: { animation: syncing ? "float 0.6s ease-in-out infinite" : "float 3s ease-in-out infinite", filter: happy ? "brightness(1.3) drop-shadow(0 0 6px #FB923C)" : "none", transition: "filter .3s" },
    }, React.createElement(PixelSprite, { frames: CALCIFER_FRAMES, size: 2, interval: syncing ? 150 : 500 })),
    happy && !syncing && React.createElement("span", {
      style: { position: "absolute", top: -18, left: "50%", transform: "translateX(-50%)", fontSize: 10, color: C.orange, whiteSpace: "nowrap", animation: "fadeSlideUp .3s ease", pointerEvents: "none" },
    }, "é»æˆ‘çœ‹æ›´æ–°ï¼ğŸ”¥")
  );
};

// ğŸ­ Character idle companion â€” generic for any character with quotes
const CharacterIdleCompanion = ({ frames, interval = 500, label, color = C.violet, quotes = ["..."], defaultMsg = "..." }) => {
  const [clicked, setClicked] = useState(false);
  const [quote, setQuote] = useState(defaultMsg);

  const handleClick = () => {
    setClicked(true);
    setQuote(quotes[Math.floor(Math.random() * quotes.length)]);
    setTimeout(() => setClicked(false), 2500);
  };

  return React.createElement("div", {
    style: { display: "flex", flexDirection: "column", alignItems: "center", gap: 6, cursor: "pointer", userSelect: "none" },
    onClick: handleClick,
  },
    clicked && React.createElement("div", {
      style: { background: C.card, border: `1px solid ${C.borderHover}`, borderRadius: 10, padding: "6px 12px", fontSize: 11, color, animation: "fadeSlideUp .3s ease", maxWidth: 160, textAlign: "center" },
    }, quote),
    React.createElement("div", {
      style: { animation: "float 2.5s ease-in-out infinite" },
    }, React.createElement(PixelSprite, { frames, size: 2, interval })),
    React.createElement("span", { style: { fontSize: 10, color: C.inkMuted } }, label)
  );
};

// ğŸ¥• Turnip Head â€” appears on empty states
const TurnipIdleCompanion = ({ message = "..." }) => React.createElement(CharacterIdleCompanion, {
  frames: TURNIP_FRAMES, interval: 600, label: "ğŸ¥• è•ªèé ­", color: C.violet, defaultMsg: message,
  quotes: ["...ï¼ˆçœ‹äº†æ•¸æ“šï¼‰...ä¸å°ã€‚", "ç”¨æˆ¶èªªçš„å’Œåšçš„ä¸ä¸€æ¨£ã€‚", "...éœ€è¦æ›´å¤šæ•¸æ“šã€‚", "...ï¼ˆæ²‰æ€ä¸­ï¼‰...", "å…ˆè§€å¯Ÿã€‚", "...é€™å€¼å¾—æ¸¬è©¦ã€‚"],
});

// ğŸ§™ Howl idle companion â€” appears on empty pipeline
const HowlIdleCompanion = ({ message = "..." }) => React.createElement(CharacterIdleCompanion, {
  frames: HOWL_FRAMES, interval: 500, label: "ğŸ§™ éœçˆ¾", color: C.accent, defaultMsg: message,
  quotes: ["é€™å€‹ç”¢å“éœ€è¦ä¸€å€‹éˆé­‚ã€‚", "è®“æˆ‘æŠŠé€™å€‹æ•…äº‹èªªå¾—ç„¡æ³•æŠ—æ‹’ã€‚", "å¹³åº¸çš„è¨­è¨ˆï¼Ÿä¸ï¼Œé‡ä¾†ã€‚", "æˆ‘çœ‹åˆ°æ½›åŠ›äº†......", "å…ˆæ‰¾åˆ°å·®ç•°åŒ–ï¼Œå…¶ä»–çš„éƒ½æ˜¯å™ªéŸ³ã€‚", "é€™å€‹ææ¡ˆå¯ä»¥æ›´è¿·äººã€‚"],
});

// ğŸŒ¸ Sophie idle companion â€” appears on empty BD
const SophieIdleCompanion = ({ message = "..." }) => React.createElement(CharacterIdleCompanion, {
  frames: SOPHIE_FRAMES, interval: 500, label: "ğŸŒ¸ è˜‡è²", color: C.rose, defaultMsg: message,
  quotes: ["å…ˆç¢ºèªç”¨æˆ¶æ˜¯èª°ï¼Œå†è«‡æ€éº¼èªªæœä»–å€‘ã€‚", "æ•¸å­—ä¸æœƒèªªè¬Šï¼Œä½†æœƒè¢«èª¤è®€ã€‚", "é ç®—è¦æŠ“ç·Šï¼Œåˆ¥èŠ±å†¤æ‰éŒ¢ã€‚", "é€™ç¯‡æ–‡æ¡ˆå¯ä»¥æ›´æœ‰æº«åº¦ã€‚", "ROI ç®—éäº†å—ï¼Ÿ", "å®¢æˆ¶ä¸æœƒè‡ªå·±èµ°é€²ä¾†ã€‚"],
});

// ğŸŒ¿ Markl idle companion â€” appears on empty tasks
const MarklIdleCompanion = ({ message = "..." }) => React.createElement(CharacterIdleCompanion, {
  frames: MARKL_FRAMES, interval: 450, label: "ğŸŒ¿ é¦¬é­¯å…‹", color: C.emerald, defaultMsg: message,
  quotes: ["æ”¶åˆ°ï¼æ•´ç†æˆä¸‰å€‹ action itemsã€‚", "æˆªæ­¢æ—¥æœŸæ˜¯ï¼Ÿ", "é€™å€‹éœ€è¦æ‹†æ›´ç´°ã€‚", "é€²åº¦æˆ‘ä¾†è¿½è¹¤ï¼", "Checklist å·²æ›´æ–°ã€‚", "èª°è² è²¬é€™å€‹ï¼Ÿæ¨™è¨˜ä¸€ä¸‹ã€‚"],
});

// âœ¨ Magic sparkle burst â€” appears on successful actions
const SparkleField = ({ count = 6, trigger }) => {
  const [sparkles, setSparkles] = useState([]);

  useEffect(() => {
    if (!trigger) return;
    const newSparkles = Array.from({ length: count }, (_, i) => ({
      id: Date.now() + i,
      x: Math.random() * 80 + 10,
      y: Math.random() * 80 + 10,
      delay: Math.random() * 400,
      scale: 0.5 + Math.random() * 0.8,
    }));
    setSparkles(newSparkles);
    const t = setTimeout(() => setSparkles([]), 1200);
    return () => clearTimeout(t);
  }, [trigger]);

  if (sparkles.length === 0) return null;
  return React.createElement("div", { style: { position: "absolute", inset: 0, pointerEvents: "none", overflow: "hidden", zIndex: 10 } },
    sparkles.map((s) =>
      React.createElement("div", {
        key: s.id,
        style: { position: "absolute", left: `${s.x}%`, top: `${s.y}%`, transform: `scale(${s.scale})`, animation: `sparklePopFade 0.8s ${s.delay}ms ease-out both`, opacity: 0 },
      }, React.createElement(PixelSprite, { frames: SPARKLE_FRAMES, size: 2, interval: 200 }))
    )
  );
};

// ğŸŒ™ Ambient stars â€” subtle twinkling background for sidebar/empty areas
const AmbientStars = ({ width = 200, height = 120 }) => {
  const stars = useMemo(() =>
    Array.from({ length: 12 }, (_, i) => ({
      id: i,
      x: Math.random() * width,
      y: Math.random() * height,
      size: Math.random() > 0.6 ? 2 : 1,
      delay: Math.random() * 3,
      duration: 2 + Math.random() * 3,
    })), [width, height]);

  return React.createElement("div", { style: { position: "relative", width, height, pointerEvents: "none" } },
    stars.map((s) =>
      React.createElement("div", {
        key: s.id,
        style: {
          position: "absolute", left: s.x, top: s.y, width: s.size, height: s.size,
          borderRadius: "50%", background: s.size > 1 ? C.accent : "rgba(255,255,255,.4)",
          animation: `starTwinkle ${s.duration}s ${s.delay}s ease-in-out infinite`,
        },
      })
    )
  );
};

// â”€â”€ Version Changelog â”€â”€
const VERSION = "1.08";
const CHANGELOG = [
  {
    version: "1.08", date: "2026-03-01", title: "Bug ä¿®å¾© & äº’å‹•å‡ç´š",
    features: [
      { icon: "ğŸ°", text: "è§’è‰²äº’å‹•å ´æ™¯ â€” Footer ä¸Šç·£çš„åƒç´ è§’è‰²å°è©±å‹•ç•«ï¼Œéœçˆ¾ & è˜‡è² & é¦¬é­¯å…‹ & è•ªèé ­éš¨æ©Ÿäº’å‹•" },
      { icon: "ğŸ’¬", text: "è§’è‰²å°è©±æ°£æ³¡ â€” è§’è‰²å·¡éŠæ™‚éš¨æ©Ÿå†’å‡ºç¶“å…¸å°è©ï¼Œå¢åŠ åŸå ¡ç”Ÿæ´»æ„Ÿ" },
      { icon: "ğŸ¨", text: "Drawer é¢æ¿è¦–è¦ºå‡ç´š â€” æé«˜ç·¨è¼¯é¢æ¿äº®åº¦èˆ‡å°æ¯”ï¼Œæ¸›å°‘èƒŒæ™¯æ¨¡ç³Šå¹²æ“¾" },
    ],
    fixes: [
      { icon: "ğŸ›", text: "ä¿®å¾©å¡è¥¿æ³•æ›´ç‰ˆå½ˆçª—ç™½å± â€” CHANGELOG ç¼ºå°‘ fixes å±¬æ€§å°è‡´ .length crash" },
      { icon: "ğŸ›", text: "ä¿®å¾©æŒ‰éˆ•è¨­è¨ˆä¸ä¸€è‡´ â€” ç§»é™¤æ®˜é¤˜ emojiã€çµ±ä¸€ä½¿ç”¨ Design System Btn çµ„ä»¶" },
      { icon: "ğŸ›", text: "ä¿®å¾©ç·¨è¼¯é¢æ¿è¢«éœ§ç»ç’ƒé®è”½ â€” é™ä½èƒŒæ™¯é®ç½©ä¸é€æ˜åº¦ï¼Œæäº®é¢æ¿åº•è‰²" },
    ],
  },
  {
    version: "1.07", date: "2026-03-01", title: "Design System è¨­è¨ˆç³»çµ±",
    features: [
      { icon: "ğŸ¨", text: "æŒ‰éˆ•è¨­è¨ˆç³»çµ± â€” å»ºç«‹çµ±ä¸€çš„ Btn çµ„ä»¶ï¼šprimaryï¼ˆå¯¦å¿ƒå¡«è‰²ï¼‰/ secondaryï¼ˆæé‚Šï¼‰/ ghostï¼ˆæ–‡å­—ï¼‰/ danger å››ç¨®è®Šé«”" },
      { icon: "ğŸ“", text: "æŒ‰éˆ•å°ºå¯¸è¦ç¯„ â€” sm / md / lg ä¸‰ç¨®æ¨™æº–å°ºå¯¸ï¼Œçµ±ä¸€ paddingã€fontSizeã€borderRadius" },
      { icon: "âœ¨", text: "æŒ‰éˆ•è¦–è¦ºå‡ç´š â€” Primary æŒ‰éˆ•ä½¿ç”¨ç™½è‰²æ–‡å­— + å½©è‰²å¡«å…… + hover é™°å½±ï¼Œæ›´ç›´è¦ºæ¸…æ™°" },
      { icon: "ğŸ§¹", text: "ç§»é™¤æŒ‰éˆ•å…§ emoji â€” ä¸å†ç”¨ âœ…ğŸ’¾ğŸ“¦ğŸ—‘ğŸ“‚ğŸ”— ç­‰ emoji è£é£¾æŒ‰éˆ•ï¼Œè®“è¨­è¨ˆæ›´ä¹¾æ·¨å°ˆæ¥­" },
      { icon: "ğŸ‘»", text: "Ghost æŒ‰éˆ•å–ä»£å–æ¶ˆ â€” æ‰€æœ‰ã€Œå–æ¶ˆã€æŒ‰éˆ•çµ±ä¸€ç‚º ghost è®Šé«”ï¼Œè¦–è¦ºæ¬Šé‡é™ä½ï¼Œä¸»æ¬¡åˆ†æ˜" },
    ],
  },
  {
    version: "1.06", date: "2026-03-01", title: "åƒç´ ä¸–ç•Œå¤§å‡ç´š",
    features: [
      { icon: "ğŸ§™", text: "éœçˆ¾åƒç´ ç²¾éˆ â€” é‡‘é«®é»‘è¢çš„ 10x14 åƒç´ è§’è‰²ï¼Œé»æ“Šèªªå‡ºç”¢å“ç­–ç•¥èªéŒ„" },
      { icon: "ğŸŒ¸", text: "è˜‡è²åƒç´ ç²¾éˆ â€” è—è£™æ£•é«®çš„ 9x14 åƒç´ è§’è‰²ï¼Œé»æ“Šèªªå‡ºè¡ŒéŠ·èˆ‡è²¡å‹™æ™ºæ…§" },
      { icon: "ğŸŒ¿", text: "é¦¬é­¯å…‹åƒç´ ç²¾éˆ â€” ç¶ è¡£å°åŠ©æ‰‹ 8x12 åƒç´ è§’è‰²ï¼Œé»æ“Šèªªå‡º PM åè¨€" },
      { icon: "ğŸ°", text: "åŸå ¡åƒç´ å¤§å‡ç´š â€” 16x18 å°ºå¯¸ï¼ŒåŠ å…¥ç…™å›ªã€ç¿…è†€ã€å½©æ——ã€å±‹é ‚ã€æ©Ÿæ¢°è…¿ç­‰ç´°ç¯€" },
      { icon: "ğŸ­", text: "è§’è‰²å·¡éŠéšŠä¼ â€” Footer å·¡éŠå‡ç´šç‚ºå…¨å“¡å‡ºå‹•ï¼šåŸå ¡ + éœçˆ¾ + è˜‡è² + é¦¬é­¯å…‹ + è•ªèé ­ä¸€èµ·èµ°éè¢å¹•" },
      { icon: "ğŸ’¬", text: "è§’è‰²äº’å‹•èªéŒ„ â€” Hover è§’è‰²å·¡éŠé¡¯ç¤ºåå­—ï¼Œç©ºç™½ç‹€æ…‹é»æ“Šè§’è‰²å¯çœ‹éš¨æ©ŸèªéŒ„" },
    ],
  },
  {
    version: "1.05", date: "2026-03-01", title: "é«”é©—ç²¾ä¿® & æ™ºæ…§ç™»å…¥",
    features: [
      { icon: "ğŸ”¥", text: "å¡è¥¿æ³•æ›´ç‰ˆå…¥å£ â€” é»æ“Šå³ä¸Šè§’å¡è¥¿æ³•å³å¯æŸ¥çœ‹å®Œæ•´æ›´ç‰ˆç´€éŒ„" },
      { icon: "ğŸ”", text: "ç™»å…¥è‡ªå‹•æ¸…é™¤ç¤ºç¯„è³‡æ–™ â€” é¦–æ¬¡ç™»å…¥å¾Œè‡ªå‹•æ¸…ç©º Demo è³‡æ–™ï¼Œè®“ä½ å¾é›¶é–‹å§‹å»ºç«‹è‡ªå·±çš„æ¥­å‹™" },
      { icon: "ğŸ“±", text: "RWD Header å„ªåŒ– â€” æ‰‹æ©Ÿç‰ˆæ¨™é¡Œç²¾ç°¡ã€æŒ‰éˆ•å°ºå¯¸é©é…ã€é–“è·èª¿æ•´ï¼Œå°è¢å¹•ä¸å†æ“æ“ " },
      { icon: "ğŸ“±", text: "Tab åˆ—è¡¨å„ªåŒ– â€” æ‰‹æ©Ÿç‰ˆå­—é«”ç¸®å°ã€é–“è·ç²¾èª¿ï¼Œå…­å€‹ Tab ä¸å†æº¢å‡º" },
    ],
    fixes: [
      { icon: "ğŸ›", text: "ä¿®å¾©æ´»å‹•ç´€éŒ„é—œé–‰æŒ‰éˆ•é¡¯ç¤ºç‚ºç™½è‰²æ–¹å¡Šçš„ CSS bugï¼ˆrgba + hex è¡çªï¼‰" },
      { icon: "ğŸ›", text: "ä¿®å¾©å¸³è™Ÿé ­åƒåœ–ç‰‡è¼‰å…¥å¤±æ•—æ™‚ç„¡ fallback çš„å•é¡Œï¼ŒåŠ å…¥ onError åŠ referrerPolicy" },
    ],
  },
  {
    version: "1.04", date: "2026-03-01", title: "åƒç´ é­”æ³•ä¸–ç•Œ",
    features: [
      { icon: "ğŸ°", text: "åƒç´ ç§»å‹•åŸå ¡ â€” Footer åº•éƒ¨ä¸å®šæ™‚èµ°éçš„åƒç´ é¢¨åŸå ¡å·¡éŠå‹•ç•«" },
      { icon: "ğŸ”¥", text: "å¡è¥¿æ³•å¤¥ä¼´ â€” Header åŒæ­¥æŒ‰éˆ•æ—çš„åƒç´ ç«ç„°ç²¾éˆï¼Œhover æœ‰é©šå–œå°è©" },
      { icon: "ğŸ¥•", text: "è•ªèé ­å½©è›‹ â€” ç©ºç‹€æ…‹é é¢çš„äº’å‹•è•ªèé ­ï¼Œé»æ“Šéš¨æ©Ÿå†’å‡ºç¶“å…¸èªéŒ„" },
      { icon: "âœ¨", text: "é­”æ³•ç²’å­ç‰¹æ•ˆ â€” æˆåŠŸæ“ä½œæ™‚ç¶»æ”¾çš„æ˜Ÿæ˜Ÿåƒç´ çˆ†è£‚å‹•ç•«" },
      { icon: "ğŸŒ™", text: "æ˜Ÿç©ºå¾®å…‰èƒŒæ™¯ â€” Footer é–ƒçˆæ˜Ÿé»ç’°å¢ƒæ°›åœ" },
      { icon: "ğŸ“‹", text: "ç‰ˆæœ¬æ›´æ–°ç´€éŒ„ â€” é»æ“Š Footer ç‰ˆæœ¬è™Ÿå³å¯æŸ¥çœ‹å®Œæ•´ Changelog" },
    ],
    fixes: [
      { icon: "ğŸ›", text: "ä¿®å¾© UndoToast åœ¨ info-only toast æ™‚ undo ç‚º null çš„ crash" },
      { icon: "ğŸ›", text: "é›²ç«¯åŒæ­¥å¢åŠ æˆåŠŸ/å¤±æ•— Toast å›é¥‹èˆ‡åŒæ­¥æ™‚é–“è¨˜éŒ„" },
    ],
  },
  {
    version: "1.03", date: "2026-03-01", title: "é€²éšå•†æ¥­æ™ºæ…§",
    features: [
      { icon: "ğŸ’”", text: "æµå¤±åŸå› è¿½è¹¤ â€” æ¡ˆä»¶æ¨™ç‚ºã€Œæœªæˆæ¡ˆã€æ™‚å¼·åˆ¶è¨˜éŒ„åŸå› ï¼Œç´¯ç©æ•¸æ“šæ”¹å–„è½‰åŒ–ç‡" },
      { icon: "ğŸ“", text: "éšæ®µæ­·ç¨‹æ™‚é–“è»¸ â€” æ¯æ¬¡éšæ®µåˆ‡æ›è‡ªå‹•è¨˜éŒ„æ™‚é–“æˆ³ï¼Œæ¡ˆä»¶ Drawer ä¸­é¡¯ç¤ºå®Œæ•´è»Œè·¡" },
      { icon: "ğŸ”¬", text: "éšæ®µåœç•™å¤©æ•¸åˆ†æ â€” æ•¸æ“šåˆ†æé æ–°å¢ç“¶é ¸æª¢æ¸¬ï¼Œè‡ªå‹•è­¦ç¤ºåœæ»¯è¶…é 14 å¤©çš„éšæ®µ" },
      { icon: "ğŸ’”", text: "æµå¤±åŸå› çµ±è¨ˆ â€” æ•¸æ“šåˆ†æé æ–°å¢æµå¤±åŸå› æ’è¡Œã€æµå¤±é‡‘é¡ã€æœ€å¸¸è¦‹åŸå› " },
      { icon: "ğŸ”„", text: "Upsell è¿½è¹¤ â€” æ–°å¢æ¡ˆä»¶æ™‚å¯æ¨™è¨˜ã€Œå»¶ä¼¸è‡ªã€å·²ç°½ç´„æ¡ˆä»¶ï¼Œè¿½è¹¤äºŒæœŸ/è¿½åŠ /æ“´å……" },
      { icon: "âœ¨", text: "è¦–è¦ºå‹•æ…‹å‡ç´š â€” Tab åˆ‡æ›å‹•ç•«ã€æ•¸å­—è·³å‹•æ•ˆæœã€å¡ç‰‡å…¥å ´å‹•ç•«ã€æŒ‰éˆ•å½ˆè·³å¾®äº’å‹•" },
      { icon: "ğŸ””", text: "é€¾æœŸè„ˆè¡è­¦ç¤º â€” Header é€¾æœŸæŒ‰éˆ•åŠ å…¥å‘¼å¸ç‡ˆå‹•ç•«" },
    ],
    fixes: [
      { icon: "ğŸ›", text: "ä¿®å¾©æ–‡ä»¶ã€Œè¤‡è£½é€£çµã€çš„ state race condition" },
      { icon: "ğŸ›", text: "ä¿®å¾©æ™¨å ±æ¯æ¬¡è¼‰å…¥é‡æ–°å‡ºç¾çš„å•é¡Œï¼Œç¾åœ¨æŒ‰æ—¥æŒä¹…åŒ–" },
    ],
  },
  {
    version: "1.01", date: "2026-02-28", title: "åˆå§‹ç‰ˆæœ¬",
    features: [
      { icon: "ğŸ“Š", text: "æ¥­å‹™æ¼æ–— â€” æ¡ˆä»¶å…­éšæ®µç®¡ç† + è©³æƒ… Drawer + å³æ™‚éšæ®µåˆ‡æ›" },
      { icon: "ğŸ“‹", text: "ä»»å‹™çœ‹æ¿ â€” ä¸‰æ¬„ä½ˆå±€ + æœå°‹ç¯©é¸ + å„ªå…ˆç´š + é—œè¯æ¡ˆä»¶" },
      { icon: "ğŸ¯", text: "BD é–‹ç™¼ â€” æ½›åœ¨å®¢æˆ¶è¿½è¹¤ + ä¸ƒéšæ®µç‹€æ…‹ + è½‰å…¥æ¼æ–—" },
      { icon: "ğŸ“ˆ", text: "æ•¸æ“šåˆ†æ â€” æœˆ/å­£/å¹´ç›®æ¨™ + æ¡ˆä»¶é€Ÿåº¦åˆ†æ + è§’è‰²æ¥­ç¸¾æ’è¡Œ" },
      { icon: "ğŸ“", text: "æ–‡ä»¶è³‡æºåº« â€” è‡ªè¨‚æ–‡ä»¶ CRUD + å¤šå¹³å°é€£çµï¼ˆGoogle Drive / Dropbox / Notionï¼‰" },
      { icon: "ğŸ‘¥", text: "è§’è‰²ç®¡ç† â€” åŸå ¡äº”è§’è‰² + è‡ªè¨‚è§’è‰² + Emoji & é¡è‰²é¸æ“‡" },
      { icon: "ğŸ°", text: "æ™ºæ…§æ™¨å ± â€” æ¯æ—¥æ¥­å‹™æ‘˜è¦ + åœæ»¯æ¡ˆä»¶è­¦ç¤º + é€¾æœŸä»»å‹™æé†’" },
      { icon: "ğŸ’¡", text: "æ¡ˆä»¶åŠ©æ‰‹ â€” éšæ®µå»ºè­°ä»»å‹™ + Email æ¨¡æ¿ + å¥åº·åº¦æŒ‡æ¨™" },
      { icon: "â˜ï¸", text: "é›²ç«¯åŒæ­¥ â€” Google Sheets å¾Œç«¯ + å¤šå¸³è™Ÿéš”é›¢" },
      { icon: "ğŸ”", text: "Google Sign-In â€” OAuth 2.0 ä¸€éµç™»å…¥" },
      { icon: "âŒ¨ï¸", text: "æŒ‡ä»¤é¢æ¿ â€” Cmd+K å¿«é€Ÿæ“ä½œ" },
      { icon: "ğŸ“œ", text: "æ´»å‹•ç´€éŒ„ â€” æ‰€æœ‰æ“ä½œæ­·å²è¿½è¹¤" },
      { icon: "â¬‡", text: "CSV åŒ¯å‡º â€” æ¡ˆä»¶ / ä»»å‹™ / BD è³‡æ–™åŒ¯å‡º" },
    ],
    fixes: [],
  },
];

const ChangelogModal = ({ open, onClose }) => {
  const { mobile } = useWindowSize();
  if (!open) return null;
  return (
    <div style={{ position: "fixed", inset: 0, background: "rgba(0,0,0,.7)", backdropFilter: "blur(6px)", display: "flex", alignItems: mobile ? "flex-end" : "center", justifyContent: "center", zIndex: 1200 }} onClick={onClose}>
      <div onClick={(e) => e.stopPropagation()} style={{ background: C.card, border: `1px solid ${C.borderHover}`, borderRadius: mobile ? "20px 20px 0 0" : 18, width: mobile ? "100%" : 560, maxHeight: mobile ? "90vh" : "80vh", display: "flex", flexDirection: "column", animation: "scaleIn .25s cubic-bezier(.4,0,.2,1)" }}>
        {/* Header */}
        <div style={{ padding: "24px 28px 16px", borderBottom: `1px solid ${C.border}`, display: "flex", justifyContent: "space-between", alignItems: "center" }}>
          <div>
            <div style={{ fontSize: 18, fontWeight: 800, color: C.ink }}>ğŸ° ç‰ˆæœ¬æ›´æ–°ç´€éŒ„</div>
            <div style={{ fontSize: 12, color: C.inkMuted, marginTop: 4 }}>ç§»å‹•åŸå ¡æŒ‡æ®éƒ¨ â€” What's New</div>
          </div>
          <button onClick={onClose} style={{ background: "rgba(255,255,255,.06)", border: "none", color: C.inkMuted, cursor: "pointer", fontSize: 14, padding: "6px 10px", borderRadius: 8, fontFamily: "inherit" }}>âœ•</button>
        </div>
        {/* Content */}
        <div style={{ flex: 1, overflowY: "auto", padding: "20px 28px" }}>
          {CHANGELOG.map((release, ri) => (
            <div key={release.version} style={{ marginBottom: ri < CHANGELOG.length - 1 ? 32 : 0 }}>
              <div style={{ display: "flex", alignItems: "center", gap: 10, marginBottom: 16 }}>
                <span style={{ padding: "4px 12px", borderRadius: 8, background: ri === 0 ? `${C.emerald}20` : `${C.accent}15`, color: ri === 0 ? C.emerald : C.accent, fontSize: 14, fontWeight: 800, fontFamily: "monospace" }}>v{release.version}</span>
                <span style={{ fontSize: 13, color: C.inkMuted }}>{release.date}</span>
                {ri === 0 && <span style={{ padding: "2px 8px", borderRadius: 6, background: `${C.emerald}15`, color: C.emerald, fontSize: 11, fontWeight: 700 }}>æœ€æ–°</span>}
              </div>
              <div style={{ fontSize: 15, fontWeight: 700, color: C.ink, marginBottom: 12 }}>{release.title}</div>
              {release.features.length > 0 && (
                <div style={{ marginBottom: 12 }}>
                  <div style={{ fontSize: 11, fontWeight: 600, color: C.emerald, letterSpacing: ".06em", marginBottom: 8 }}>NEW FEATURES</div>
                  <div style={{ display: "flex", flexDirection: "column", gap: 6 }}>
                    {release.features.map((f, i) => (
                      <div key={i} style={{ display: "flex", alignItems: "flex-start", gap: 10, padding: "8px 12px", background: C.surface, borderRadius: 10, fontSize: 13, color: C.inkSoft, lineHeight: 1.6 }}>
                        <span style={{ fontSize: 14, flexShrink: 0, marginTop: 1 }}>{f.icon}</span>
                        <span>{f.text}</span>
                      </div>
                    ))}
                  </div>
                </div>
              )}
              {(release.fixes || []).length > 0 && (
                <div>
                  <div style={{ fontSize: 11, fontWeight: 600, color: C.orange, letterSpacing: ".06em", marginBottom: 8 }}>BUG FIXES</div>
                  <div style={{ display: "flex", flexDirection: "column", gap: 6 }}>
                    {(release.fixes || []).map((f, i) => (
                      <div key={i} style={{ display: "flex", alignItems: "flex-start", gap: 10, padding: "8px 12px", background: C.surface, borderRadius: 10, fontSize: 13, color: C.inkSoft, lineHeight: 1.6 }}>
                        <span style={{ fontSize: 14, flexShrink: 0, marginTop: 1 }}>{f.icon}</span>
                        <span>{f.text}</span>
                      </div>
                    ))}
                  </div>
                </div>
              )}
              {ri < CHANGELOG.length - 1 && <div style={{ height: 1, background: C.border, marginTop: 24 }} />}
            </div>
          ))}
        </div>
      </div>
    </div>
  );
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Main App
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ Command Palette (Cmd+K) â”€â”€
const CommandPalette = ({ open, onClose, onAction }) => {
  const [q, setQ] = useState("");
  const inputRef = useRef(null);
  const { mobile } = useWindowSize();

  useEffect(() => { if (open && inputRef.current) setTimeout(() => inputRef.current.focus(), 50); }, [open]);

  const commands = [
    { id: "addDeal", label: "æ–°å¢æ¡ˆä»¶", icon: "ğŸ“Š", shortcut: "D" },
    { id: "addTask", label: "æ–°å¢ä»»å‹™", icon: "ğŸ“‹", shortcut: "T" },
    { id: "addLead", label: "æ–°å¢ BD å°è±¡", icon: "ğŸ¯", shortcut: "B" },
    { id: "addRole", label: "æ–°å¢è§’è‰²", icon: "ğŸ‘¥", shortcut: "R" },
    { id: "goToPipeline", label: "å‰å¾€æ¥­å‹™æ¼æ–—", icon: "ğŸ“Š", shortcut: "1" },
    { id: "goToTasks", label: "å‰å¾€ä»»å‹™çœ‹æ¿", icon: "ğŸ“‹", shortcut: "2" },
    { id: "goToBD", label: "å‰å¾€ BD é–‹ç™¼", icon: "ğŸ¯", shortcut: "3" },
    { id: "goToAnalytics", label: "å‰å¾€æ•¸æ“šåˆ†æ", icon: "ğŸ“ˆ", shortcut: "4" },
    { id: "goToDocs", label: "å‰å¾€æ–‡ä»¶è³‡æº", icon: "ğŸ“", shortcut: "5" },
    { id: "goToRoles", label: "å‰å¾€è§’è‰²ç®¡ç†", icon: "ğŸ‘¥", shortcut: "6" },
    { id: "exportDeals", label: "åŒ¯å‡ºæ¡ˆä»¶ CSV", icon: "â¬‡", shortcut: null },
    { id: "exportTasks", label: "åŒ¯å‡ºä»»å‹™ CSV", icon: "â¬‡", shortcut: null },
    { id: "exportLeads", label: "åŒ¯å‡º BD å°è±¡ CSV", icon: "â¬‡", shortcut: null },
  ];

  const filtered = q ? commands.filter((c) => c.label.toLowerCase().includes(q.toLowerCase())) : commands;

  if (!open) return null;
  return (
    <div style={{ position: "fixed", inset: 0, background: "rgba(0,0,0,.6)", backdropFilter: "blur(8px)", display: "flex", alignItems: "flex-start", justifyContent: "center", paddingTop: mobile ? 60 : 120, zIndex: 1200 }} onClick={onClose}>
      <div onClick={(e) => e.stopPropagation()} style={{ background: C.card, border: `1px solid ${C.borderHover}`, borderRadius: 16, width: mobile ? "92%" : 480, overflow: "hidden", boxShadow: "0 20px 60px rgba(0,0,0,.5)" }}>
        <div style={{ padding: "16px 18px", borderBottom: `1px solid ${C.border}`, display: "flex", alignItems: "center", gap: 10 }}>
          <span style={{ color: C.inkMuted, fontSize: 16 }}>ğŸ”</span>
          <input ref={inputRef} value={q} onChange={(e) => setQ(e.target.value)} placeholder="è¼¸å…¥æŒ‡ä»¤... (æ–°å¢ã€å‰å¾€ã€åŒ¯å‡º)"
            onKeyDown={(e) => { if (e.key === "Escape") onClose(); if (e.key === "Enter" && filtered.length > 0) { onAction(filtered[0].id); onClose(); } }}
            style={{ flex: 1, background: "transparent", border: "none", color: C.ink, fontSize: 15, outline: "none", fontFamily: "inherit" }} />
          <span style={{ fontSize: 11, color: C.inkMuted, background: C.surface, padding: "2px 8px", borderRadius: 6 }}>ESC</span>
        </div>
        <div style={{ maxHeight: 320, overflowY: "auto", padding: "6px 0" }}>
          {filtered.map((cmd) => (
            <button key={cmd.id} onClick={() => { onAction(cmd.id); onClose(); }}
              style={{ display: "flex", alignItems: "center", gap: 12, width: "100%", padding: "10px 18px", border: "none", background: "transparent", color: C.ink, fontSize: 14, cursor: "pointer", fontFamily: "inherit", transition: T, textAlign: "left" }}
              onMouseEnter={(e) => e.currentTarget.style.background = C.surface}
              onMouseLeave={(e) => e.currentTarget.style.background = "transparent"}>
              <span style={{ fontSize: 16 }}>{cmd.icon}</span>
              <span style={{ flex: 1 }}>{cmd.label}</span>
              {cmd.shortcut && <span style={{ fontSize: 11, color: C.inkMuted, background: C.surface, padding: "2px 8px", borderRadius: 6, fontFamily: "monospace" }}>{cmd.shortcut}</span>}
            </button>
          ))}
          {filtered.length === 0 && <div style={{ padding: 20, textAlign: "center", color: C.inkMuted, fontSize: 13 }}>æ‰¾ä¸åˆ°æŒ‡ä»¤</div>}
        </div>
      </div>
    </div>
  );
};

// â”€â”€ Activity Log Sidebar â”€â”€
const ActivityLog = ({ log, open, onClose }) => {
  const { mobile } = useWindowSize();
  if (!open) return null;
  return (
    <div style={{ position: "fixed", inset: 0, zIndex: 1050, display: "flex", justifyContent: "flex-end" }} onClick={onClose}>
      <div onClick={(e) => e.stopPropagation()}
        style={{ width: mobile ? "100%" : 380, height: "100%", background: C.card, borderLeft: `1px solid ${C.borderHover}`, padding: "24px 20px", overflowY: "auto", boxShadow: "-8px 0 30px rgba(0,0,0,.3)" }}>
        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 20 }}>
          <h3 style={{ margin: 0, fontSize: 18, fontWeight: 800, color: C.ink }}>ğŸ“œ æ´»å‹•ç´€éŒ„</h3>
          <button onClick={onClose} style={{ background: "rgba(255,255,255,.06)", border: "none", color: C.inkMuted, cursor: "pointer", fontSize: 14, padding: "6px 10px", borderRadius: 8, fontFamily: "inherit" }}>âœ•</button>
        </div>
        {log.length === 0 ? (
          <div style={{ display: "flex", flexDirection: "column", alignItems: "center", paddingTop: 30 }}>
            <MarklIdleCompanion message="é‚„æ²’æœ‰æ“ä½œç´€éŒ„å‘¢ã€‚" />
            <div style={{ fontSize: 13, color: C.inkMuted, marginTop: 8 }}>å°šç„¡æ´»å‹•ç´€éŒ„</div>
          </div>
        ) : (
          <div style={{ display: "flex", flexDirection: "column", gap: 4 }}>
            {log.map((entry, i) => (
              <div key={i} style={{ padding: "12px 14px", background: i === 0 ? `${C.accent}08` : "transparent", borderRadius: 10, borderLeft: `3px solid ${entry.color || C.accent}`, transition: T }}>
                <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 4 }}>
                  <span style={{ fontSize: 13, fontWeight: 600, color: C.ink }}>{entry.icon} {entry.action}</span>
                  <span style={{ fontSize: 11, color: C.inkMuted }}>{timeAgo(entry.time)}</span>
                </div>
                <div style={{ fontSize: 12, color: C.inkSoft }}>{entry.detail}</div>
              </div>
            ))}
          </div>
        )}
      </div>
    </div>
  );
};

function CastleDashboard() {
  const { mobile } = useWindowSize();
  const [user, setUser] = useState(() => ls.getUser());
  const [tab, setTab] = useState("pipeline");
  const [deals, setDeals] = usePersisted("deals", INIT_DEALS);
  const [tasks, setTasks] = usePersisted("tasks", INIT_TASKS);
  const [leads, setLeads] = usePersisted("leads", INIT_LEADS);
  const [roles, setRoles] = usePersisted("roles", DEFAULT_ROLES);
  const [modal, setModal] = useState(null);
  const [editItem, setEditItem] = useState(null);
  const [toast, setToast] = useState(null);
  const [confirmAction, setConfirmAction] = useState(null);
  const [taskSearch, setTaskSearch] = useState("");
  const [taskFilter, setTaskFilter] = useState("all");
  const [expandedDealId, setExpandedDealId] = useState(null);
  const [cmdOpen, setCmdOpen] = useState(false);
  const [logOpen, setLogOpen] = useState(false);
  const [activityLog, setActivityLog] = usePersisted("log", []);
  const [goals, setGoals] = usePersisted("goals", { month: { deals: 5, revenue: 300000 }, quarter: { deals: 12, revenue: 800000 }, year: { deals: 40, revenue: 3000000 } });
  const [syncing, setSyncing] = useState(false);
  const [userDocs, setUserDocs] = usePersisted("docs", DEFAULT_DOCS);
  const [changelogOpen, setChangelogOpen] = useState(false);

  const addUserDoc = (doc) => setUserDocs((prev) => [...prev, doc]);
  const deleteUserDoc = (id) => setUserDocs((prev) => prev.filter((d) => d.id !== id));

  const nDeal = useRef(Math.max(...(deals.length ? deals : INIT_DEALS).map((d) => d.id)) + 1);
  const nTask = useRef(Math.max(...(tasks.length ? tasks : INIT_TASKS).map((t) => t.id)) + 1);
  const nLead = useRef(Math.max(...(leads.length ? leads : INIT_LEADS).map((l) => l.id)) + 1);
  const nRole = useRef(100);

  // â”€â”€ Google Login Handler â”€â”€
  const handleGoogleLogin = useCallback(async (credential) => {
    // Decode JWT from Google Sign-In
    const payload = JSON.parse(atob(credential.split(".")[1]));
    const u = { email: payload.email, name: payload.name, picture: payload.picture };
    setUser(u);
    ls.setUser(u);
    // Notify API
    api.post("login", u.email, u);
    // Try to load cloud data
    const cloud = await api.get("getAll", u.email);
    if (cloud && (cloud.deals?.length || cloud.tasks?.length || cloud.leads?.length)) {
      // Load existing cloud data
      if (cloud.deals?.length) setDeals(cloud.deals);
      if (cloud.tasks?.length) setTasks(cloud.tasks);
      if (cloud.leads?.length) setLeads(cloud.leads);
    } else {
      // First login â€” clear demo data so user starts fresh
      setDeals([]);
      setTasks([]);
      setLeads([]);
      setActivityLog([]);
    }
  }, []);

  const handleLogout = () => {
    setUser(null);
    ls.setUser(null);
  };

  // â”€â”€ Cloud Sync (manual) â”€â”€
  const [lastSyncTime, setLastSyncTime] = usePersisted("lastSync", null);
  const syncToCloud = useCallback(async () => {
    if (!user || !API_URL) return;
    setSyncing(true);
    try {
      await api.post("syncAll", user.email, { deals, tasks, leads });
      const now = new Date().toISOString();
      setLastSyncTime(now);
      addLog("â˜ï¸", "é›²ç«¯åŒæ­¥", `${deals.filter(d => !d.archived).length} æ¡ˆä»¶ Â· ${tasks.filter(t => !t.archived).length} ä»»å‹™ Â· ${leads.filter(l => !l.archived).length} BD`, C.emerald);
      setToast({ message: "âœ… å·²åŒæ­¥åˆ° Google Sheets é›²ç«¯", undo: null });
    } catch (e) {
      setToast({ message: "âŒ åŒæ­¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š", undo: null });
    }
    setSyncing(false);
  }, [user, deals, tasks, leads]);

  // â”€â”€ Activity Logger â”€â”€
  const addLog = useCallback((icon, action, detail, color) => {
    setActivityLog((prev) => [{ icon, action, detail, color, time: new Date().toISOString() }, ...prev].slice(0, 50));
  }, []);

  // â”€â”€ Google Sign-In Initialization â”€â”€
  useEffect(() => {
    if (!GOOGLE_CLIENT_ID || typeof google === "undefined") return;
    try {
      google.accounts.id.initialize({
        client_id: GOOGLE_CLIENT_ID,
        callback: (response) => handleGoogleLogin(response.credential),
        auto_select: true,
      });
      // Render sign-in button if not logged in
      if (!user) {
        const el = document.getElementById("g_id_signin");
        if (el) google.accounts.id.renderButton(el, { theme: "filled_black", size: "medium", shape: "pill", text: "signin_with" });
        google.accounts.id.prompt(); // One Tap
      }
    } catch (e) { console.warn("Google Sign-In init error:", e); }
  }, [user, handleGoogleLogin]);

  // â”€â”€ Keyboard Shortcuts â”€â”€
  useEffect(() => {
    const handler = (e) => {
      if ((e.metaKey || e.ctrlKey) && e.key === "k") { e.preventDefault(); setCmdOpen(true); }
    };
    window.addEventListener("keydown", handler);
    return () => window.removeEventListener("keydown", handler);
  }, []);

  // â”€â”€ Archive with Undo + Activity Log â”€â”€
  const archiveDeal = (id) => {
    const d = deals.find((x) => x.id === id);
    setDeals((p) => p.map((d) => d.id === id ? { ...d, archived: true } : d));
    setExpandedDealId(null);
    addLog("ğŸ“¦", "å°å­˜æ¡ˆä»¶", d?.name || "", C.rose);
    setToast({ message: "æ¡ˆä»¶å·²å°å­˜", undo: () => setDeals((p) => p.map((d) => d.id === id ? { ...d, archived: false } : d)) });
  };
  const archiveTask = (id) => {
    const t = tasks.find((x) => x.id === id);
    setTasks((p) => p.map((t) => t.id === id ? { ...t, archived: true } : t));
    addLog("ğŸ“¦", "å°å­˜ä»»å‹™", t?.text || "", C.rose);
    setToast({ message: "ä»»å‹™å·²å°å­˜", undo: () => setTasks((p) => p.map((t) => t.id === id ? { ...t, archived: false } : t)) });
  };
  const archiveLead = (id) => {
    const l = leads.find((x) => x.id === id);
    setLeads((p) => p.map((l) => l.id === id ? { ...l, archived: true } : l));
    addLog("ğŸ“¦", "å°å­˜ BD å°è±¡", l?.name || "", C.rose);
    setToast({ message: "BD å°è±¡å·²å°å­˜", undo: () => setLeads((p) => p.map((l) => l.id === id ? { ...l, archived: false } : l)) });
  };
  const archiveRole = (id) => {
    setConfirmAction({
      title: "å°å­˜è§’è‰²", message: "å°å­˜å¾Œæ­¤è§’è‰²ä¸æœƒå‡ºç¾åœ¨é¸é …ä¸­ï¼Œä½†å·²æŒ‡æ´¾çš„ä»»å‹™ä¸å—å½±éŸ¿ã€‚ç¢ºå®šå—ï¼Ÿ",
      onConfirm: () => {
        setRoles((p) => p.map((r) => r.id === id ? { ...r, archived: true } : r));
        setToast({ message: "è§’è‰²å·²å°å­˜", undo: () => setRoles((p) => p.map((r) => r.id === id ? { ...r, archived: false } : r)) });
        setConfirmAction(null);
      }
    });
  };

  // â”€â”€ Lost Reason Modal State â”€â”€
  const [lostReasonModal, setLostReasonModal] = useState(null); // { dealId, dealName }

  // â”€â”€ CRUD + Activity Log â”€â”€
  const addDeal = (d) => {
    const newDeal = { ...d, id: nDeal.current++, stageHistory: d.stageHistory || [{ stage: d.stage || "inquiry", at: today() }], lostReason: null, parentDealId: d.parentDealId || null };
    setDeals([...deals, newDeal]); setModal(null); addLog("ğŸ“Š", "æ–°å¢æ¡ˆä»¶", d.name, C.emerald);
  };
  const updateDeal = (d) => { setDeals(deals.map((x) => x.id === d.id ? d : x)); setModal(null); setEditItem(null); addLog("âœï¸", "ç·¨è¼¯æ¡ˆä»¶", d.name, C.accent); };
  const changeStage = (id, stage) => {
    const d = deals.find((x) => x.id === id);
    if (!d) return;
    // Intercept "lost" â€” force lost reason modal
    if (stage === "lost") {
      setLostReasonModal({ dealId: id, dealName: d.name });
      return;
    }
    const st = STAGES.find((s) => s.id === stage);
    const newHistory = [...(d.stageHistory || []), { stage, at: today() }];
    setDeals(deals.map((x) => x.id === id ? { ...x, stage, stageHistory: newHistory, signedDate: stage === "won" ? (x.signedDate || today()) : x.signedDate } : x));
    addLog(st?.icon || "ğŸ”„", "åˆ‡æ›éšæ®µ", `${d.name} â†’ ${st?.label}`, st?.color || C.accent);
  };
  const confirmLostDeal = (reason, customNote) => {
    if (!lostReasonModal) return;
    const { dealId, dealName } = lostReasonModal;
    const d = deals.find((x) => x.id === dealId);
    const reasonLabel = LOST_REASONS.find((r) => r.id === reason)?.label || reason;
    const newHistory = [...(d?.stageHistory || []), { stage: "lost", at: today() }];
    setDeals(deals.map((x) => x.id === dealId ? { ...x, stage: "lost", lostReason: reason, lostNote: customNote || "", stageHistory: newHistory } : x));
    addLog("â€”", "æ¨™è¨˜æœªæˆæ¡ˆ", `${dealName}ï¼ˆ${reasonLabel}${customNote ? `: ${customNote}` : ""}ï¼‰`, C.rose);
    setLostReasonModal(null);
  };

  const addTask = (t) => { setTasks([...tasks, { ...t, id: nTask.current++ }]); setModal(null); addLog("ğŸ“‹", "æ–°å¢ä»»å‹™", t.text, C.cyan); };
  const updateTask = (t) => { setTasks(tasks.map((x) => x.id === t.id ? t : x)); setModal(null); setEditItem(null); addLog("âœï¸", "ç·¨è¼¯ä»»å‹™", t.text, C.accent); };
  const changeTaskStatus = (id, status) => {
    const t = tasks.find((x) => x.id === id);
    const st = TASK_STATUS.find((s) => s.id === status);
    setTasks(tasks.map((t) => t.id === id ? { ...t, status } : t));
    addLog(st?.icon || "ğŸ”„", "æ›´æ–°ä»»å‹™ç‹€æ…‹", `${t?.text} â†’ ${st?.label}`, st?.color || C.accent);
  };

  const addLead = (l) => { setLeads([...leads, { ...l, id: nLead.current++ }]); setModal(null); addLog("ğŸ¯", "æ–°å¢ BD å°è±¡", `${l.name} (${l.company})`, C.cyan); };
  const updateLead = (l) => { setLeads(leads.map((x) => x.id === l.id ? l : x)); setModal(null); setEditItem(null); addLog("âœï¸", "ç·¨è¼¯ BD å°è±¡", l.name, C.accent); };
  const convertLead = (lead) => {
    const nd = { id: nDeal.current++, name: `${lead.company} å°ˆæ¡ˆ`, company: lead.company, contact: lead.name, email: "", stage: "inquiry", value: 30000, tier: "Tier 1", notes: `å¾ BD è½‰å…¥ (${lead.channel})\n${lead.notes}`, created: today(), role: lead.role, archived: false };
    setDeals([...deals, nd]);
    setLeads(leads.map((l) => l.id === lead.id ? { ...l, status: "converted" } : l));
    addLog("ğŸ¯", "BD è½‰å…¥æ¼æ–—", `${lead.name} â†’ ${lead.company} å°ˆæ¡ˆ`, C.violet);
  };

  const addRole = (r) => { setRoles([...roles, { ...r, id: `role_${nRole.current++}`, archived: false }]); setModal(null); addLog("ğŸ‘¥", "æ–°å¢è§’è‰²", r.name, C.violet); };
  const updateRole = (r) => { setRoles(roles.map((x) => x.id === r.id ? r : x)); setModal(null); setEditItem(null); addLog("âœï¸", "ç·¨è¼¯è§’è‰²", r.name, C.accent); };

  // â”€â”€ CSV Export â”€â”€
  const doExportDeals = () => {
    const headers = ["æ¡ˆä»¶åç¨±", "å…¬å¸", "è¯ç¹«äºº", "Email", "éšæ®µ", "é‡‘é¡", "æ–¹æ¡ˆ", "å»ºç«‹æ—¥æœŸ", "ç°½ç´„æ—¥æœŸ", "æµå¤±åŸå› ", "å‚™è¨»"];
    const rows = deals.filter((d) => !d.archived).map((d) => [d.name, d.company, d.contact, d.email, stageOf(d.stage)?.label || d.stage, d.value, d.tier, d.created, d.signedDate || "", d.lostReason ? (LOST_REASONS.find(r => r.id === d.lostReason)?.label || d.lostReason) : "", d.notes]);
    exportCSV("beyond-spec-deals.csv", headers, rows);
    addLog("â¬‡", "åŒ¯å‡ºæ¡ˆä»¶ CSV", `${rows.length} ç­†`, C.gold);
    setToast({ message: `ğŸ“¥ å·²ä¸‹è¼‰ beyond-spec-deals.csvï¼ˆ${rows.length} ç­†æ¡ˆä»¶ï¼‰`, undo: null });
  };
  const doExportTasks = () => {
    const headers = ["ä»»å‹™", "ç‹€æ…‹", "å„ªå…ˆç´š", "è² è²¬è§’è‰²", "æˆªæ­¢æ—¥æœŸ"];
    const rows = tasks.filter((t) => !t.archived).map((t) => [t.text, TASK_STATUS.find((s) => s.id === t.status)?.label || t.status, PRIORITY.find((p) => p.id === t.priority)?.label || t.priority, roles.find((r) => r.id === t.role)?.name || t.role, t.due]);
    exportCSV("beyond-spec-tasks.csv", headers, rows);
    addLog("â¬‡", "åŒ¯å‡ºä»»å‹™ CSV", `${rows.length} ç­†`, C.gold);
    setToast({ message: `ğŸ“¥ å·²ä¸‹è¼‰ beyond-spec-tasks.csvï¼ˆ${rows.length} ç­†ä»»å‹™ï¼‰`, undo: null });
  };
  const doExportLeads = () => {
    const headers = ["å§“å", "è·ç¨±", "å…¬å¸", "ç®¡é“", "ç‹€æ…‹", "å‚™è¨»", "æœ€å¾Œäº’å‹•"];
    const rows = leads.filter((l) => !l.archived).map((l) => [l.name, l.title, l.company, l.channel, BD_STATUS.find((s) => s.id === l.status)?.label || l.status, l.notes, l.lastTouch]);
    exportCSV("beyond-spec-bd-leads.csv", headers, rows);
    addLog("â¬‡", "åŒ¯å‡º BD å°è±¡ CSV", `${rows.length} ç­†`, C.gold);
    setToast({ message: `ğŸ“¥ å·²ä¸‹è¼‰ beyond-spec-bd-leads.csvï¼ˆ${rows.length} ç­† BD å°è±¡ï¼‰`, undo: null });
  };

  // â”€â”€ Command Palette Actions â”€â”€
  const handleCommand = (cmdId) => {
    const goMap = { goToPipeline: "pipeline", goToTasks: "tasks", goToBD: "bd", goToAnalytics: "analytics", goToDocs: "docs", goToRoles: "roles" };
    if (goMap[cmdId]) { setTab(goMap[cmdId]); return; }
    if (cmdId === "addDeal") setModal("addDeal");
    else if (cmdId === "addTask") setModal("addTask");
    else if (cmdId === "addLead") setModal("addLead");
    else if (cmdId === "addRole") setModal("addRole");
    else if (cmdId === "exportDeals") doExportDeals();
    else if (cmdId === "exportTasks") doExportTasks();
    else if (cmdId === "exportLeads") doExportLeads();
  };

  const activeRoles = roles.filter((r) => !r.archived);
  const now = new Date().toLocaleDateString("zh-TW", { year: "numeric", month: "long", day: "numeric", weekday: mobile ? undefined : "long" });

  const TABS = [
    { id: "pipeline", label: mobile ? "ğŸ“Š æ¼æ–—" : "ğŸ“Š æ¥­å‹™æ¼æ–—" },
    { id: "tasks", label: mobile ? "ğŸ“‹ ä»»å‹™" : "ğŸ“‹ ä»»å‹™çœ‹æ¿" },
    { id: "bd", label: mobile ? "ğŸ¯ BD" : "ğŸ¯ BD é–‹ç™¼" },
    { id: "analytics", label: mobile ? "ğŸ“ˆ åˆ†æ" : "ğŸ“ˆ æ•¸æ“šåˆ†æ" },
    { id: "docs", label: mobile ? "ğŸ“ æ–‡ä»¶" : "ğŸ“ æ–‡ä»¶è³‡æº" },
    { id: "roles", label: mobile ? "ğŸ‘¥ è§’è‰²" : "ğŸ‘¥ è§’è‰²ç®¡ç†" },
  ];

  const TASK_FILTERS = [
    { id: "all", label: "å…¨éƒ¨", color: C.accent },
    { id: "high", label: "ğŸ”´ é«˜å„ªå…ˆ", color: C.rose },
    { id: "overdue", label: "âš ï¸ é€¾æœŸ", color: C.orange },
    ...activeRoles.map((r) => ({ id: r.id, label: `${r.emoji} ${r.name}`, color: r.color })),
  ];

  return (
    <div style={{ minHeight: "100vh", display: "flex", flexDirection: "column", background: C.bg, color: C.ink, fontFamily: "'Noto Sans TC',-apple-system,sans-serif", fontSize: 15 }}>
      <style>{`
@keyframes fadeSlideIn{from{opacity:0;transform:translateY(-8px)}to{opacity:1;transform:translateY(0)}}
@keyframes fadeSlideUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
@keyframes drawerSlideIn{from{transform:translateX(100%)}to{transform:translateX(0)}}
@keyframes drawerFadeIn{from{opacity:0}to{opacity:1}}
@keyframes briefSlideDown{from{opacity:0;transform:translateY(-20px);max-height:0}to{opacity:1;transform:translateY(0);max-height:400px}}
@keyframes pulseGlow{0%,100%{box-shadow:0 0 0 0 rgba(239,68,68,.4)}50%{box-shadow:0 0 12px 4px rgba(239,68,68,.15)}}
@keyframes shimmer{from{background-position:200% 0}to{background-position:-200% 0}}
@keyframes countUp{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
@keyframes tabSlide{from{opacity:0;transform:translateX(8px)}to{opacity:1;transform:translateX(0)}}
@keyframes scaleIn{from{opacity:0;transform:scale(.95)}to{opacity:1;transform:scale(1)}}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-4px)}}
@keyframes sparklePopFade{0%{opacity:0;transform:scale(0) translateY(0)}30%{opacity:1;transform:scale(1) translateY(-8px)}100%{opacity:0;transform:scale(0.5) translateY(-20px)}}
@keyframes starTwinkle{0%,100%{opacity:.15}50%{opacity:.8}}
@keyframes castleWalk{0%,100%{transform:translateY(0)}50%{transform:translateY(-1px)}}
.castle-tab-content{animation:fadeSlideUp .35s cubic-bezier(.4,0,.2,1)}
.castle-stat-card{animation:scaleIn .4s cubic-bezier(.4,0,.2,1) both}
.castle-stat-card:nth-child(1){animation-delay:0ms}
.castle-stat-card:nth-child(2){animation-delay:60ms}
.castle-stat-card:nth-child(3){animation-delay:120ms}
.castle-stat-card:nth-child(4){animation-delay:180ms}
.castle-brief{animation:briefSlideDown .5s cubic-bezier(.4,0,.2,1)}
.castle-pulse{animation:pulseGlow 2s ease-in-out infinite}
.castle-hover-lift{transition:all .25s cubic-bezier(.4,0,.2,1)}
.castle-hover-lift:hover{transform:translateY(-3px);box-shadow:0 12px 32px rgba(0,0,0,.3)}
.castle-btn-pop{transition:all .2s cubic-bezier(.34,1.56,.64,1)}
.castle-btn-pop:hover{transform:scale(1.04)}
.castle-btn-pop:active{transform:scale(.97)}
*{scrollbar-width:thin;scrollbar-color:rgba(255,255,255,.12) transparent}::-webkit-scrollbar{width:5px;height:5px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:rgba(255,255,255,.12);border-radius:99px}::-webkit-scrollbar-thumb:hover{background:rgba(255,255,255,.25)}
`}</style>
      {/* Header */}
      <div style={{ borderBottom: `1px solid ${C.border}`, padding: mobile ? "12px 14px" : "16px 36px", display: "flex", justifyContent: "space-between", alignItems: "center", background: `${C.surface}80`, backdropFilter: "blur(12px)", position: "sticky", top: 0, zIndex: 100, gap: mobile ? 8 : 16 }}>
        <div style={{ display: "flex", alignItems: "center", gap: mobile ? 8 : 16, minWidth: 0, flexShrink: 1 }}>
          <span style={{ fontSize: mobile ? 20 : 26, flexShrink: 0 }}>ğŸ°</span>
          <div style={{ minWidth: 0 }}>
            <div style={{ fontSize: mobile ? 14 : 18, fontWeight: 800, letterSpacing: ".02em", whiteSpace: "nowrap", overflow: "hidden", textOverflow: "ellipsis" }}>{mobile ? "åŸå ¡æŒ‡æ®éƒ¨" : "ç§»å‹•åŸå ¡æŒ‡æ®éƒ¨"}</div>
            {!mobile && <div style={{ fontSize: 12, color: C.inkMuted, marginTop: 2 }}>Beyond Spec æ¥­å‹™ç®¡ç†ç³»çµ±</div>}
          </div>
        </div>
        <div style={{ display: "flex", alignItems: "center", gap: mobile ? 6 : 8, flexShrink: 0 }}>
          {!mobile && <span style={{ fontSize: 13, color: C.inkMuted }}>{now}</span>}
          {/* Cmd+K button */}
          <button onClick={() => setCmdOpen(true)} title="æŒ‡ä»¤é¢æ¿ (âŒ˜K)"
            style={{ display: "flex", alignItems: "center", gap: mobile ? 0 : 6, padding: mobile ? "5px 8px" : "5px 12px", borderRadius: 10, border: `1px solid ${C.border}`, background: "transparent", color: C.inkMuted, fontSize: 12, cursor: "pointer", fontFamily: "inherit", transition: T }}>
            ğŸ” {!mobile && "æŒ‡ä»¤"} {!mobile && <span style={{ fontSize: 10, background: C.surface, padding: "1px 5px", borderRadius: 4, fontFamily: "monospace" }}>âŒ˜K</span>}
          </button>
          {/* Export button */}
          {(tab === "pipeline" || tab === "tasks" || tab === "bd") && (
            <button onClick={() => { if (tab === "pipeline") doExportDeals(); else if (tab === "tasks") doExportTasks(); else doExportLeads(); }}
              title="åŒ¯å‡º CSV"
              style={{ width: mobile ? 30 : 34, height: mobile ? 30 : 34, borderRadius: 10, border: `1px solid ${C.border}`, background: "transparent", color: C.inkMuted, cursor: "pointer", fontSize: mobile ? 12 : 14, display: "flex", alignItems: "center", justifyContent: "center", transition: T }}>â¬‡</button>
          )}
          {/* Activity log button */}
          <button onClick={() => setLogOpen(true)} title="æ´»å‹•ç´€éŒ„"
            style={{ position: "relative", width: mobile ? 30 : 34, height: mobile ? 30 : 34, borderRadius: 10, border: `1px solid ${C.border}`, background: "transparent", color: C.inkMuted, cursor: "pointer", fontSize: mobile ? 12 : 14, display: "flex", alignItems: "center", justifyContent: "center", transition: T }}>
            ğŸ“œ
            {activityLog.length > 0 && <span style={{ position: "absolute", top: -2, right: -2, width: 8, height: 8, borderRadius: "50%", background: C.accent }} />}
          </button>
          {/* Overdue badge */}
          {(() => { const overdue = tasks.filter((t) => !t.archived && t.status !== "done" && t.due < today()).length; return overdue > 0 ? (
            <button onClick={() => { setTab("tasks"); setTaskFilter("overdue"); }} title={`${overdue} å€‹é€¾æœŸä»»å‹™`} className="castle-pulse"
              style={{ position: "relative", width: mobile ? 30 : 34, height: mobile ? 30 : 34, borderRadius: 10, border: `1px solid ${C.rose}30`, background: `${C.rose}10`, color: C.rose, cursor: "pointer", fontSize: mobile ? 12 : 14, display: "flex", alignItems: "center", justifyContent: "center", transition: T, fontFamily: "inherit" }}>
              âš ï¸<span style={{ position: "absolute", top: -4, right: -4, background: C.rose, color: "#fff", fontSize: 10, fontWeight: 700, minWidth: 16, height: 16, borderRadius: 8, display: "flex", alignItems: "center", justifyContent: "center", padding: "0 4px" }}>{overdue}</span>
            </button>
          ) : null; })()}
          {/* Calcifer companion + Cloud sync */}
          {user && API_URL && React.createElement(React.Fragment, null,
            !mobile && React.createElement(CalciferCompanion, { syncing, onShowChangelog: () => setChangelogOpen(true) }),
            React.createElement("button", {
              onClick: syncToCloud,
              title: syncing ? "å¡è¥¿æ³•æ­£åœ¨ç‡ƒç‡’åŒæ­¥ä¸­..." : `â˜ï¸ åŒæ­¥åˆ°é›²ç«¯\nå°‡æ¡ˆä»¶ã€ä»»å‹™ã€BD è³‡æ–™å‚™ä»½åˆ° Google Sheets\n${lastSyncTime ? `ä¸Šæ¬¡åŒæ­¥ï¼š${new Date(lastSyncTime).toLocaleString("zh-TW")}` : "å°šæœªåŒæ­¥é"}`,
              style: { position: "relative", width: mobile ? 30 : 34, height: mobile ? 30 : 34, borderRadius: 10, border: `1px solid ${syncing ? C.emerald : C.border}`, background: syncing ? `${C.emerald}15` : "transparent", color: syncing ? C.emerald : C.inkMuted, cursor: "pointer", fontSize: mobile ? 12 : 14, display: "flex", alignItems: "center", justifyContent: "center", transition: T, fontFamily: "inherit" },
            },
              syncing ? "â³" : "â˜ï¸",
              lastSyncTime && React.createElement("span", { style: { position: "absolute", bottom: -2, right: -2, width: 7, height: 7, borderRadius: "50%", background: C.emerald, border: `1.5px solid ${C.bg}` } })
            )
          )}
          {/* User avatar or login */}
          {user ? (
            <button onClick={handleLogout} title={`${user.name}\né»æ“Šç™»å‡º`}
              style={{ width: mobile ? 30 : 34, height: mobile ? 30 : 34, borderRadius: 10, overflow: "hidden", border: `2px solid ${C.accent}`, cursor: "pointer", padding: 0, background: C.accentSoft, display: "flex", alignItems: "center", justifyContent: "center" }}>
              {user.picture ? <img src={user.picture} alt="" style={{ width: "100%", height: "100%", objectFit: "cover" }} onError={(e) => { e.target.style.display = "none"; e.target.parentElement.innerHTML = '<span style="font-size:15px">ğŸ‘‘</span>'; }} referrerPolicy="no-referrer" /> : <span style={{ fontSize: 15 }}>ğŸ‘‘</span>}
            </button>
          ) : GOOGLE_CLIENT_ID ? (
            <div id="g_id_signin" style={{ borderRadius: 10, overflow: "hidden" }}></div>
          ) : (
            <div style={{ width: 34, height: 34, borderRadius: 10, background: C.accentSoft, display: "flex", alignItems: "center", justifyContent: "center", fontSize: 15 }}>ğŸ‘‘</div>
          )}
        </div>
      </div>

      {/* â”€â”€ Remove maxWidth for full-width layout â”€â”€ */}
      <div style={{ padding: mobile ? "20px 18px" : "28px 36px", flex: 1 }}>
        <MorningBrief deals={deals} tasks={tasks} leads={leads} />
        <StatsRow deals={deals} tasks={tasks} leads={leads} onHealthClick={() => { setTab("tasks"); setTaskFilter("overdue"); }} />

        {/* Tab bar */}
        <div style={{ display: "flex", flexDirection: mobile ? "column" : "row", justifyContent: "space-between", alignItems: mobile ? "stretch" : "center", gap: mobile ? 12 : 0, marginBottom: 20 }}>
          <div style={{ display: "flex", gap: 4, background: C.surface, borderRadius: 12, padding: 4, overflowX: "auto" }}>
            {TABS.map((t) => (
              <button key={t.id} onClick={() => { setTab(t.id); setExpandedDealId(null); setTaskSearch(""); setTaskFilter("all"); }}
                style={{ padding: mobile ? "7px 10px" : "9px 20px", borderRadius: 10, border: "none", cursor: "pointer", fontSize: mobile ? 12 : 14, fontWeight: 600, fontFamily: "inherit", background: tab === t.id ? C.card : "transparent", color: tab === t.id ? C.ink : C.inkMuted, whiteSpace: "nowrap", flex: mobile ? 1 : "none", transition: T }}>
                {t.label}
              </button>
            ))}
          </div>
          <div style={{ display: "flex", gap: 10 }}>
            {tab === "pipeline" && <Btn color={C.emerald} onClick={() => setModal("addDeal")} full={mobile}>+ æ–°å¢æ¡ˆä»¶</Btn>}
            {tab === "tasks" && <Btn color={C.accent} onClick={() => setModal("addTask")} full={mobile}>+ æ–°å¢ä»»å‹™</Btn>}
            {tab === "bd" && <Btn color={C.cyan} onClick={() => setModal("addLead")} full={mobile}>+ æ–°å¢ BD å°è±¡</Btn>}
            {tab === "docs" && <Btn color={C.gold} onClick={() => setModal("addDoc")} full={mobile}>+ æ–°å¢æ–‡ä»¶</Btn>}
            {tab === "roles" && <Btn color={C.violet} onClick={() => setModal("addRole")} full={mobile}>+ æ–°å¢è§’è‰²</Btn>}
          </div>
        </div>

        {/* Task sub-bar: search + filters */}
        {tab === "tasks" && (
          <div style={{ display: "flex", flexDirection: mobile ? "column" : "row", gap: 12, marginBottom: 20 }}>
            <SearchBar value={taskSearch} onChange={setTaskSearch} placeholder="æœå°‹ä»»å‹™..." />
            <FilterPills options={TASK_FILTERS} active={taskFilter} onSelect={setTaskFilter} />
          </div>
        )}

        {/* Content â€” animated tab transitions */}
        <div key={tab} className="castle-tab-content">
          {tab === "pipeline" && <PipelineView deals={deals} roles={activeRoles} onArchive={archiveDeal} onUpdate={updateDeal} onStageChange={changeStage} expandedId={expandedDealId} onExpand={setExpandedDealId} />}
          {tab === "tasks" && <TasksView tasks={tasks} deals={deals.filter((d) => !d.archived)} roles={activeRoles} onEdit={(t) => { setEditItem(t); setModal("editTask"); }} onArchive={archiveTask} onStatusChange={changeTaskStatus} search={taskSearch} filter={taskFilter} />}
          {tab === "bd" && <BDTrackerView leads={leads} roles={activeRoles} onEdit={(l) => { setEditItem(l); setModal("editLead"); }} onArchive={archiveLead} onConvert={convertLead} />}
          {tab === "analytics" && <AnalyticsView deals={deals} roles={roles} goals={goals} onGoalsChange={setGoals} />}
          {tab === "docs" && <DocumentsView userDocs={userDocs} onAddDoc={addUserDoc} onDeleteDoc={deleteUserDoc} showAddForm={modal === "addDoc"} onCloseForm={() => setModal(null)} />}
          {tab === "roles" && <RolesView roles={roles} onAdd={() => setModal("addRole")} onEdit={(r) => { setEditItem(r); setModal("editRole"); }} onArchive={archiveRole} />}
        </div>
      </div>

      {/* Modals */}
      {modal === "addDeal" && <Modal title="æ–°å¢æ¡ˆä»¶" onClose={() => setModal(null)}><DealForm roles={activeRoles} allDeals={deals} onSave={addDeal} onCancel={() => setModal(null)} /></Modal>}
      {modal === "editDeal" && editItem && <Modal title="ç·¨è¼¯æ¡ˆä»¶" onClose={() => { setModal(null); setEditItem(null); }}><DealForm deal={editItem} roles={activeRoles} allDeals={deals} onSave={updateDeal} onCancel={() => { setModal(null); setEditItem(null); }} /></Modal>}
      {modal === "addTask" && <Modal title="æ–°å¢ä»»å‹™" onClose={() => setModal(null)}><TaskForm deals={deals.filter((d) => !d.archived)} roles={activeRoles} onSave={addTask} onCancel={() => setModal(null)} /></Modal>}
      {modal === "editTask" && editItem && <Modal title="ç·¨è¼¯ä»»å‹™" onClose={() => { setModal(null); setEditItem(null); }}><TaskForm task={editItem} deals={deals.filter((d) => !d.archived)} roles={activeRoles} onSave={updateTask} onCancel={() => { setModal(null); setEditItem(null); }} /></Modal>}
      {modal === "addLead" && <Modal title="æ–°å¢ BD å°è±¡" onClose={() => setModal(null)}><LeadForm roles={activeRoles} onSave={addLead} onCancel={() => setModal(null)} /></Modal>}
      {modal === "editLead" && editItem && <Modal title="ç·¨è¼¯ BD å°è±¡" onClose={() => { setModal(null); setEditItem(null); }}><LeadForm lead={editItem} roles={activeRoles} onSave={updateLead} onCancel={() => { setModal(null); setEditItem(null); }} /></Modal>}
      {modal === "addRole" && <Modal title="æ–°å¢è§’è‰²" onClose={() => setModal(null)}><RoleForm onSave={addRole} onCancel={() => setModal(null)} /></Modal>}
      {modal === "editRole" && editItem && <Modal title="ç·¨è¼¯è§’è‰²" onClose={() => { setModal(null); setEditItem(null); }}><RoleForm role={editItem} onSave={updateRole} onCancel={() => { setModal(null); setEditItem(null); }} /></Modal>}

      {/* Confirm Modal */}
      {confirmAction && <ConfirmModal title={confirmAction.title} message={confirmAction.message} onConfirm={confirmAction.onConfirm} onCancel={() => setConfirmAction(null)} danger />}

      {/* Lost Reason Modal */}
      {lostReasonModal && <LostReasonModal dealName={lostReasonModal.dealName} onConfirm={confirmLostDeal} onCancel={() => setLostReasonModal(null)} />}

      {/* Version Changelog */}
      <ChangelogModal open={changelogOpen} onClose={() => setChangelogOpen(false)} />

      {/* Undo Toast */}
      {toast && <UndoToast message={toast.message} onUndo={toast.undo ? () => { toast.undo(); setToast(null); } : null} onDismiss={() => setToast(null)} />}

      {/* Command Palette */}
      <CommandPalette open={cmdOpen} onClose={() => setCmdOpen(false)} onAction={handleCommand} />

      {/* Activity Log Sidebar */}
      <ActivityLog log={activityLog} open={logOpen} onClose={() => setLogOpen(false)} />

      {/* ğŸ° Castle Parade â€” walks across footer */}
      <CastleParade />

      {/* Footer â€” pushed to bottom */}
      <div style={{ borderTop: `1px solid ${C.border}`, padding: mobile ? "14px 18px" : "18px 36px", textAlign: "center", marginTop: "auto", position: "relative", overflow: "hidden" }}>
        <div style={{ position: "absolute", top: 4, left: "50%", transform: "translateX(-50%)", opacity: 0.3 }}>
          <AmbientStars width={300} height={30} />
        </div>
        <span style={{ fontSize: 12, color: C.inkMuted, cursor: "pointer", transition: "color .2s", position: "relative", zIndex: 1 }} onClick={() => setChangelogOpen(true)} onMouseEnter={(e) => e.target.style.color = C.accent} onMouseLeave={(e) => e.target.style.color = C.inkMuted} title="é»æ“ŠæŸ¥çœ‹ç‰ˆæœ¬æ›´æ–°ç´€éŒ„">ğŸ° ç§»å‹•åŸå ¡æŒ‡æ®éƒ¨ v{VERSION} â€” è¦æ ¼å¤–å·¥ä½œå®¤ Beyond Spec</span>
      </div>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(React.createElement(CastleDashboard));
</script>
</body>
</html>
