<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ğŸ° ç§»å‹•åŸå ¡æ¥­å‹™æŒ‡æ® Dashboard</title>
<script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: #08080c; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans TC", sans-serif; }
  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: rgba(255,255,255,.15); border-radius: 3px; }
  ::selection { background: rgba(108,142,255,.3); }
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useRef, useEffect, useCallback } = React;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ° ç§»å‹•åŸå ¡æ¥­å‹™æŒ‡æ® Dashboard v5.0 â€” å®Œæ•´æ¥­å‹™å·¥ä½œç«™
// Beyond Spec â€” æ¥­å‹™æ¼æ–— + ä»»å‹™çœ‹æ¿ + BD Tracker + æ•¸æ“šåˆ†æ + æ–‡ä»¶è³‡æº + è§’è‰²ç®¡ç† + æ´»å‹•ç´€éŒ„ + æŒ‡ä»¤é¢æ¿
//
// v4.2 æ”¹ç‰ˆé‡é»ï¼š
// âœ… å­—é«”å…¨é¢æ”¾å¤§ â€” å·¥ä½œç›´è§€ä¸è²»çœ¼åŠ›
// âœ… UI ç²¾ç·»åŒ– â€” hover æ•ˆæœã€éæ¸¡å‹•ç•«ã€å¾®äº’å‹•
// âœ… å¡ç‰‡å±•é–‹æ¨¡å¼ â€” é»æ“Šå±•é–‹è©³æƒ…ï¼Œå…§å«ç·¨è¼¯ / ç‹€æ…‹åˆ‡æ›
// âœ… å…¨å¯¬ä½ˆå±€ â€” ç§»é™¤ maxWidth é™åˆ¶ï¼ŒBD æ¬„ä½ä¸å†æˆªæ–·
// âœ… ğŸ“ˆ æ•¸æ“šåˆ†æ â€” æœˆ/å­£/å¹´ç›®æ¨™é”æˆåº¦ + æ¡ˆä»¶é€Ÿåº¦ï¼ˆé€²ä»¶â†’ç°½ç´„å¤©æ•¸ï¼‰
// âœ… ğŸ“ æ–‡ä»¶è³‡æº â€” åˆç´„ç¯„æœ¬ã€ææ¡ˆæ¨¡æ¿ï¼Œå¯ä¸‹è¼‰/è¤‡è£½é€£çµ
// âœ… å…¨é é¢ RWD éŸ¿æ‡‰å¼
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Data Layer â€” localStorage + Google Sheets API (Route C)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const API_URL = "https://script.google.com/macros/s/AKfycbyzmgzpzVtlIQeKnDhBQocVRDpxGxlSZvBGLgTy4aEl8yL5A6lwV2-qfO2n8IM96GU4/exec";
const GOOGLE_CLIENT_ID = "870408555328-8vg2runp456id06aeen8vcplfbhl8c60.apps.googleusercontent.com";

// localStorage helper
const ls = {
  get: (key, fallback) => { try { const v = localStorage.getItem(`castle_${key}`); return v ? JSON.parse(v) : fallback; } catch { return fallback; } },
  set: (key, val) => { try { localStorage.setItem(`castle_${key}`, JSON.stringify(val)); } catch {} },
  getUser: () => ls.get("user", null),
  setUser: (u) => ls.set("user", u),
};

// API caller (fire-and-forget for writes, await for reads)
const api = {
  get: async (action, userId) => {
    if (!API_URL) return null;
    try {
      const res = await fetch(`${API_URL}?action=${action}&userId=${encodeURIComponent(userId)}`);
      const json = await res.json();
      return json.ok ? json.data : null;
    } catch { return null; }
  },
  post: async (action, userId, data) => {
    if (!API_URL) return null;
    try {
      const res = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ action, userId, data }),
      });
      const json = await res.json();
      return json.ok ? json.data : null;
    } catch { return null; }
  },
};

// Persist hook â€” saves to localStorage on every change, syncs to API
const usePersisted = (key, initial) => {
  const [val, setVal] = useState(() => ls.get(key, initial));
  useEffect(() => { ls.set(key, val); }, [val]);
  return [val, setVal];
};

// â”€â”€ Responsive Hook â”€â”€
const useWindowSize = () => {
  const [w, setW] = useState(typeof window !== "undefined" ? window.innerWidth : 1200);
  useEffect(() => {
    const h = () => setW(window.innerWidth);
    window.addEventListener("resize", h);
    return () => window.removeEventListener("resize", h);
  }, []);
  return { w, mobile: w < 640, tablet: w < 1024, desktop: w >= 1024 };
};

// â”€â”€ Colors â”€â”€
const C = {
  bg: "#08080c", surface: "#111118", card: "#16161f", cardHover: "#1c1c28",
  border: "rgba(255,255,255,.08)", borderHover: "rgba(255,255,255,.18)",
  ink: "#e8e8f0", inkSoft: "rgba(255,255,255,.65)", inkMuted: "rgba(255,255,255,.38)",
  accent: "#6C8EFF", accentSoft: "rgba(108,142,255,.12)",
  gold: "#F5A623", goldSoft: "rgba(245,166,35,.12)",
  emerald: "#34D399", emeraldSoft: "rgba(52,211,153,.12)",
  rose: "#F472B6", roseSoft: "rgba(244,114,182,.12)",
  violet: "#A78BFA", violetSoft: "rgba(167,139,250,.12)",
  cyan: "#22D3EE", cyanSoft: "rgba(34,211,238,.12)",
  orange: "#FB923C", orangeSoft: "rgba(251,146,60,.12)",
  glow: (c) => `0 0 20px ${c}30, 0 4px 16px rgba(0,0,0,.3)`,
};

// â”€â”€ Constants â”€â”€
const STAGES = [
  { id: "inquiry", label: "æ´½è©¢ä¸­", color: C.cyan, icon: "ğŸ“¥" },
  { id: "exploring", label: "æ¢ç´¢æœƒè­°", color: C.accent, icon: "ğŸ—“" },
  { id: "proposal", label: "ææ¡ˆä¸­", color: C.gold, icon: "ğŸ“‹" },
  { id: "negotiation", label: "è­°åƒ¹ä¸­", color: C.orange, icon: "ğŸ¤" },
  { id: "won", label: "å·²ç°½ç´„", color: C.emerald, icon: "ğŸ‰" },
  { id: "lost", label: "æœªæˆæ¡ˆ", color: C.rose, icon: "â€”" },
];

const TASK_STATUS = [
  { id: "todo", label: "å¾…è¾¦", color: C.cyan, icon: "ğŸ“‹" },
  { id: "doing", label: "é€²è¡Œä¸­", color: C.gold, icon: "ğŸ”¥" },
  { id: "done", label: "å·²å®Œæˆ", color: C.emerald, icon: "âœ…" },
];

const PRIORITY = [
  { id: "high", label: "é«˜", color: C.rose, icon: "ğŸ”´" },
  { id: "mid", label: "ä¸­", color: C.gold, icon: "ğŸŸ¡" },
  { id: "low", label: "ä½", color: C.inkMuted, icon: "âšª" },
];

const DEFAULT_ROLES = [
  { id: "howl", name: "éœçˆ¾", title: "CPO", emoji: "ğŸ§™", color: C.accent },
  { id: "calcifer", name: "å¡è¥¿æ³•", title: "CTO", emoji: "ğŸ”¥", color: C.orange },
  { id: "markl", name: "é¦¬é­¯å…‹", title: "COO", emoji: "ğŸŒ¿", color: C.emerald },
  { id: "sophie", name: "è˜‡è²", title: "CMO", emoji: "ğŸŒ¸", color: C.rose },
  { id: "turnip", name: "è•ªèé ­", title: "CDO", emoji: "ğŸ¥•", color: C.violet },
];

const TIERS = ["Tier 1", "Tier 2", "Tier 3"];

const BD_STATUS = [
  { id: "identified", label: "å·²é–å®š", color: C.inkSoft, icon: "ğŸ”" },
  { id: "warming", label: "æš–èº«ä¸­", color: C.cyan, icon: "ğŸ‘‹" },
  { id: "connected", label: "å·²é€£æ¥", color: C.accent, icon: "ğŸ”—" },
  { id: "chatting", label: "å°è©±ä¸­", color: C.gold, icon: "ğŸ’¬" },
  { id: "call_booked", label: "å·²ç´„è¨ª", color: C.emerald, icon: "ğŸ“" },
  { id: "converted", label: "å·²è½‰å…¥æ¼æ–—", color: C.violet, icon: "ğŸ¯" },
  { id: "dormant", label: "æš«ç·©", color: C.rose, icon: "ğŸ’¤" },
];
const BD_CHANNELS = ["LinkedIn", "AppWorks", "AAMA", "TTA", "Startup Island", "COSCUP / g0v", "æ´»å‹•èªè­˜", "æœ‹å‹æ¨è–¦", "å…¶ä»–"];

// â”€â”€ Document Templates â”€â”€
const DOC_TEMPLATES = [
  { id: "contract-tier1", name: "Tier 1 æœå‹™åˆç´„ï¼ˆç”¢å“å¥æª¢ï¼‰", category: "åˆç´„", icon: "ğŸ“", format: "DOCX", url: "/templates/contract-tier1.docx", desc: "å–®æ¬¡ç”¢å“å¥æª¢åˆç´„ç¯„æœ¬ï¼Œå«æœå‹™ç¯„åœã€äº¤ä»˜ç‰©ã€ä»˜æ¬¾æ¢ä»¶" },
  { id: "contract-tier2", name: "Tier 2 æœå‹™åˆç´„ï¼ˆSprintï¼‰", category: "åˆç´„", icon: "ğŸ“", format: "DOCX", url: "/templates/contract-tier2.docx", desc: "2~4 é€± Sprint åˆç´„ç¯„æœ¬ï¼Œå«é‡Œç¨‹ç¢‘ã€é©—æ”¶æ¨™æº–" },
  { id: "contract-tier3", name: "Tier 3 æœå‹™åˆç´„ï¼ˆé•·æœŸé¡§å•ï¼‰", category: "åˆç´„", icon: "ğŸ“", format: "DOCX", url: "/templates/contract-tier3.docx", desc: "æœˆè²»åˆ¶é¡§å•åˆç´„ï¼Œå« SLAã€è®Šæ›´æµç¨‹" },
  { id: "proposal-template", name: "ææ¡ˆç°¡å ±æ¨¡æ¿", category: "ææ¡ˆ", icon: "ğŸ“Š", format: "PPTX", url: "/templates/proposal-template.pptx", desc: "æ¨™æº–ææ¡ˆç°¡å ±ï¼Œå«å…¬å¸ä»‹ç´¹ã€æ–¹æ³•è«–ã€æ¡ˆä¾‹ã€å ±åƒ¹" },
  { id: "discovery-deck", name: "æ¢ç´¢æœƒè­°ç°¡å ±æ¨¡æ¿", category: "ææ¡ˆ", icon: "ğŸ—“", format: "PPTX", url: "/templates/discovery-deck.pptx", desc: "æ¢ç´¢æœƒè­°ç”¨ç°¡å ±ï¼Œå«ç”¢æ¥­ç ”ç©¶æ¡†æ¶ã€å•é¡Œæ¸…å–®" },
  { id: "health-check", name: "ç”¢å“å¥æª¢å ±å‘Šæ¨¡æ¿", category: "å ±å‘Š", icon: "ğŸ©º", format: "DOCX", url: "/templates/health-check-report.docx", desc: "ç”¢å“å¥æª¢æ¨™æº–å ±å‘Šæ ¼å¼ï¼Œå«è©•åˆ†çŸ©é™£ã€å»ºè­°æ¸…å–®" },
  { id: "nda", name: "NDA ä¿å¯†å”è­°", category: "åˆç´„", icon: "ğŸ”’", format: "PDF", url: "/templates/nda.pdf", desc: "é›™æ–¹ä¿å¯†å”è­°ç¯„æœ¬" },
  { id: "quotation", name: "å ±åƒ¹å–®æ¨¡æ¿", category: "ææ¡ˆ", icon: "ğŸ’°", format: "XLSX", url: "/templates/quotation.xlsx", desc: "æ¨™æº–å ±åƒ¹å–®ï¼Œå«é …ç›®ã€å·¥æ™‚ã€å–®åƒ¹ã€åˆè¨ˆ" },
  { id: "invoice", name: "è«‹æ¬¾å–®æ¨¡æ¿", category: "è²¡å‹™", icon: "ğŸ§¾", format: "XLSX", url: "/templates/invoice.xlsx", desc: "è«‹æ¬¾å–®ç¯„æœ¬ï¼Œå«åŒ¯æ¬¾è³‡è¨Šã€ç¨…å‹™æ¬„ä½" },
  { id: "case-study", name: "æ¡ˆä¾‹ç ”ç©¶æ¨¡æ¿", category: "è¡ŒéŠ·", icon: "ğŸ“–", format: "DOCX", url: "/templates/case-study.docx", desc: "å®¢æˆ¶æ¡ˆä¾‹æ’°å¯«æ¨¡æ¿ï¼Œå«æŒ‘æˆ°ã€æ–¹æ¡ˆã€æˆæœçµæ§‹" },
];

const DOC_CATEGORIES = ["å…¨éƒ¨", "åˆç´„", "ææ¡ˆ", "å ±å‘Š", "è²¡å‹™", "è¡ŒéŠ·"];

// â”€â”€ Demo Data â”€â”€
const INIT_DEALS = [
  { id: 1, name: "FitTrack å¥èº« App", company: "FitLife Inc.", contact: "é™³å°æ˜", email: "ming@fitlife.tw", stage: "exploring", value: 250000, tier: "Tier 2", notes: "æœ‰èˆˆè¶£åš 0â†’1 Sprintï¼Œä¸‹é€±ä¸‰æ¢ç´¢æœƒè­°", created: "2026-02-20", signedDate: null, role: "howl", archived: false },
  { id: 2, name: "å¯µç‰©ç¤¾ç¾¤å¹³å°", company: "PawPaw å¯µå¯µ", contact: "æ—å°èŠ±", email: "flower@pawpaw.tw", stage: "proposal", value: 120000, tier: "Tier 3", notes: "å·²é€ææ¡ˆï¼Œç­‰å¾…å›è¦†", created: "2026-02-15", signedDate: null, role: "sophie", archived: false },
  { id: 3, name: "é¤é£² POS ç³»çµ±å„ªåŒ–", company: "é£Ÿå…‰ç§‘æŠ€", contact: "ç‹å¤§æ˜", email: "wang@foodtime.tw", stage: "inquiry", value: 30000, tier: "Tier 1", notes: "å¾è¡¨å–®é€²ä¾†ï¼Œéœ€è¦ç”¢å“å¥æª¢", created: "2026-02-27", signedDate: null, role: "markl", archived: false },
  { id: 4, name: "ç·šä¸Šæ•™è‚²å¹³å° MVP", company: "å­¸å ‚ç§‘æŠ€", contact: "å¼µå°ç¾", email: "mei@xuetang.tw", stage: "negotiation", value: 250000, tier: "Tier 2", notes: "åƒ¹æ ¼å·²è«‡åˆ° 22 è¬ï¼Œæ¥è¿‘ç°½ç´„", created: "2026-02-10", signedDate: null, role: "howl", archived: false },
  { id: 5, name: "B2B SaaS Landing Page", company: "é›²ç«¯æ–¹æ¡ˆ", contact: "æå¤§å“¥", email: "li@cloudsol.tw", stage: "won", value: 30000, tier: "Tier 1", notes: "å·²å®Œæˆå¥æª¢å ±å‘Šï¼Œå®¢æˆ¶æ»¿æ„", created: "2026-01-28", signedDate: "2026-02-15", role: "turnip", archived: false },
];

const INIT_TASKS = [
  { id: 1, text: "å®Œæˆ FitTrack æ¢ç´¢æœƒè­°ç°¡å ±", role: "howl", dealId: 1, due: "2026-03-05", status: "doing", priority: "high", archived: false },
  { id: 2, text: "PawPaw ææ¡ˆå ±åƒ¹å–®ä¿®æ”¹", role: "sophie", dealId: 2, due: "2026-03-03", status: "todo", priority: "high", archived: false },
  { id: 3, text: "é£Ÿå…‰ç§‘æŠ€ç”¢å“å¥æª¢åˆæ­¥åˆ†æ", role: "turnip", dealId: 3, due: "2026-03-04", status: "todo", priority: "mid", archived: false },
  { id: 4, text: "å­¸å ‚ç§‘æŠ€åˆç´„è‰ç¨¿", role: "markl", dealId: 4, due: "2026-03-02", status: "doing", priority: "high", archived: false },
  { id: 5, text: "é›²ç«¯æ–¹æ¡ˆå¥æª¢å ±å‘Š QA", role: "markl", dealId: 5, due: "2026-02-28", status: "done", priority: "low", archived: false },
  { id: 6, text: "FitTrack æŠ€è¡“å¯è¡Œæ€§è©•ä¼°", role: "calcifer", dealId: 1, due: "2026-03-06", status: "todo", priority: "mid", archived: false },
  { id: 7, text: "LinkedIn æœ¬é€±è²¼æ–‡ï¼ˆæ¡ˆä¾‹åˆ†äº«ï¼‰", role: "sophie", dealId: null, due: "2026-03-01", status: "todo", priority: "low", archived: false },
];

const INIT_LEADS = [
  { id: 1, name: "é™³æŸç¿°", title: "Co-founder & CEO", company: "æ—…éŠæ–°å‰µ TripBuddy", channel: "LinkedIn", status: "warming", notes: "å·²æŒ‰è®š 3 ç¯‡è²¼æ–‡ï¼Œæº–å‚™ç™¼é€£æ¥", lastTouch: "2026-02-27", role: "sophie", archived: false },
  { id: 2, name: "æ—é›…å©·", title: "Product Manager", company: "é‡‘èç§‘æŠ€ FinFlow", channel: "AppWorks", status: "connected", notes: "AppWorks Demo Day èªè­˜ï¼Œå°ç”¢å“è¦æ ¼æœ‰èˆˆè¶£", lastTouch: "2026-02-25", role: "howl", archived: false },
  { id: 3, name: "å¼µå‡±æ–‡", title: "CTO", company: "å¥åº·ç§‘æŠ€ MedPlus", channel: "LinkedIn", status: "chatting", notes: "å·²åˆ†äº« PRD æ–‡ç« ï¼Œå›è¦†æœ‰èˆˆè¶£äº†è§£æ›´å¤š", lastTouch: "2026-02-26", role: "calcifer", archived: false },
  { id: 4, name: "ç‹æ€æ¶µ", title: "å‰µè¾¦äºº", company: "æ•™è‚²å¹³å° LearnWell", channel: "AAMA", status: "call_booked", notes: "3/5 ä¸‹åˆ 3 é» Discovery Call", lastTouch: "2026-02-28", role: "howl", archived: false },
  { id: 5, name: "åŠ‰å»ºå®", title: "ç‡Ÿé‹é•·", company: "ç‰©æµç§‘æŠ€ PackGo", channel: "æ´»å‹•èªè­˜", status: "identified", notes: "MOPCON è¬›è€…ï¼Œåšç‰©æµæ•¸ä½è½‰å‹", lastTouch: "2026-02-20", role: "markl", archived: false },
];

// â”€â”€ Helpers â”€â”€
const fmt = (n) => "NT$ " + n.toLocaleString();
const stageOf = (id) => STAGES.find((s) => s.id === id);
const today = () => new Date().toISOString().split("T")[0];
const timeAgo = (dateStr) => {
  const diff = Date.now() - new Date(dateStr).getTime();
  const mins = Math.floor(diff / 60000);
  if (mins < 1) return "å‰›å‰›";
  if (mins < 60) return `${mins} åˆ†é˜å‰`;
  const hours = Math.floor(mins / 60);
  if (hours < 24) return `${hours} å°æ™‚å‰`;
  const days = Math.floor(hours / 24);
  return `${days} å¤©å‰`;
};

// â”€â”€ CSV Export Utility â”€â”€
const exportCSV = (filename, headers, rows) => {
  const bom = "\uFEFF"; // UTF-8 BOM for Excel
  const csv = bom + [headers.join(","), ...rows.map((r) => r.map((v) => `"${String(v ?? "").replace(/"/g, '""')}"`).join(","))].join("\n");
  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename; a.click();
  URL.revokeObjectURL(url);
};

// â”€â”€ Transition helper â”€â”€
const T = "all .2s cubic-bezier(.4,0,.2,1)";
const T_SPRING = "all .35s cubic-bezier(.34,1.56,.64,1)";

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Reusable UI Components
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const Badge = ({ color, bg, children, small }) => (
  <span style={{ display: "inline-block", padding: small ? "3px 9px" : "4px 12px", borderRadius: 8, fontSize: small ? 11 : 13, fontWeight: 600, color, background: bg, whiteSpace: "nowrap", letterSpacing: ".02em" }}>{children}</span>
);

const RolePill = ({ roleId, roles }) => {
  const r = roles.find((x) => x.id === roleId);
  if (!r) return null;
  return <span style={{ display: "inline-flex", alignItems: "center", gap: 5, padding: "3px 10px", borderRadius: 8, fontSize: 13, fontWeight: 600, background: `${r.color}18`, color: r.color, whiteSpace: "nowrap" }}>{r.emoji} {r.name}</span>;
};

const PriorityDot = ({ priority }) => {
  const p = PRIORITY.find((x) => x.id === priority);
  if (!p) return null;
  return <span title={`å„ªå…ˆç´šï¼š${p.label}`} style={{ fontSize: 10 }}>{p.icon}</span>;
};

const Btn = ({ children, onClick, color = C.accent, outline, small, full, style: sx }) => {
  const [hov, setHov] = useState(false);
  return (
    <button onClick={onClick}
      onMouseEnter={() => setHov(true)} onMouseLeave={() => setHov(false)}
      style={{
        padding: small ? "6px 14px" : "9px 20px", borderRadius: 10,
        border: outline ? `1px solid ${color}40` : "none",
        background: outline ? (hov ? `${color}10` : "transparent") : (hov ? `${color}30` : `${color}20`),
        color, fontSize: small ? 13 : 14, fontWeight: 600, cursor: "pointer", fontFamily: "inherit",
        transition: T, width: full ? "100%" : "auto",
        transform: hov ? "translateY(-1px)" : "none",
        boxShadow: hov && !outline ? `0 4px 12px ${color}20` : "none",
        ...sx
      }}>{children}</button>
  );
};

const Field = ({ label, children }) => (
  <div style={{ marginBottom: 16 }}>
    <label style={{ display: "block", fontSize: 13, color: C.inkMuted, marginBottom: 6, letterSpacing: ".04em", fontWeight: 500 }}>{label}</label>
    {children}
  </div>
);

const inputStyle = { width: "100%", padding: "10px 14px", borderRadius: 10, border: `1px solid ${C.border}`, background: C.surface, color: C.ink, fontSize: 14, fontFamily: "inherit", boxSizing: "border-box", outline: "none", transition: T };
const selectStyle = { ...inputStyle, cursor: "pointer" };

// â”€â”€ Undo Toast â”€â”€
const UndoToast = ({ message, onUndo, onDismiss }) => {
  useEffect(() => { const t = setTimeout(onDismiss, 5000); return () => clearTimeout(t); }, []);
  return (
    <div style={{ position: "fixed", bottom: 28, left: "50%", transform: "translateX(-50%)", background: C.card, border: `1px solid ${C.borderHover}`, borderRadius: 14, padding: "14px 24px", display: "flex", alignItems: "center", gap: 16, zIndex: 2000, boxShadow: "0 12px 40px rgba(0,0,0,.6)", backdropFilter: "blur(12px)" }}>
      <span style={{ fontSize: 14, color: C.ink }}>{message}</span>
      <button onClick={onUndo} style={{ background: `${C.accent}20`, border: "none", color: C.accent, fontSize: 13, fontWeight: 700, borderRadius: 8, padding: "5px 14px", cursor: "pointer", fontFamily: "inherit", transition: T }}>å¾©åŸ</button>
    </div>
  );
};

// â”€â”€ Confirm Modal â”€â”€
const ConfirmModal = ({ title, message, onConfirm, onCancel, danger }) => {
  const { mobile } = useWindowSize();
  return (
    <div style={{ position: "fixed", inset: 0, background: "rgba(0,0,0,.7)", backdropFilter: "blur(6px)", display: "flex", alignItems: mobile ? "flex-end" : "center", justifyContent: "center", zIndex: 1100 }} onClick={onCancel}>
      <div onClick={(e) => e.stopPropagation()} style={{ background: C.card, border: `1px solid ${C.borderHover}`, borderRadius: mobile ? "20px 20px 0 0" : 18, padding: mobile ? "28px 24px" : 32, width: mobile ? "100%" : 420 }}>
        <h3 style={{ margin: "0 0 10px", fontSize: 18, fontWeight: 800, color: C.ink }}>{title}</h3>
        <p style={{ margin: "0 0 24px", fontSize: 14, color: C.inkSoft, lineHeight: 1.7 }}>{message}</p>
        <div style={{ display: "flex", gap: 12, justifyContent: "flex-end" }}>
          <Btn outline color={C.inkMuted} onClick={onCancel}>å–æ¶ˆ</Btn>
          <Btn color={danger ? C.rose : C.accent} onClick={onConfirm}>{danger ? "ç¢ºå®šåˆªé™¤" : "ç¢ºå®š"}</Btn>
        </div>
      </div>
    </div>
  );
};

// â”€â”€ Modal Overlay â”€â”€
const Modal = ({ title, onClose, children, wide }) => {
  const { mobile } = useWindowSize();
  return (
    <div style={{ position: "fixed", inset: 0, background: "rgba(0,0,0,.7)", backdropFilter: "blur(6px)", display: "flex", alignItems: mobile ? "flex-end" : "center", justifyContent: "center", zIndex: 1000 }} onClick={onClose}>
      <div onClick={(e) => e.stopPropagation()} style={{ background: C.card, border: `1px solid ${C.borderHover}`, borderRadius: mobile ? "20px 20px 0 0" : 18, padding: mobile ? "28px 24px" : 32, width: mobile ? "100%" : (wide ? 600 : 520), maxHeight: mobile ? "92vh" : "85vh", overflowY: "auto" }}>
        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 24 }}>
          <h3 style={{ margin: 0, fontSize: mobile ? 18 : 20, fontWeight: 800, color: C.ink }}>{title}</h3>
          <button onClick={onClose} style={{ background: `${C.inkMuted}15`, border: "none", color: C.inkMuted, cursor: "pointer", fontSize: 14, padding: "6px 10px", borderRadius: 8, transition: T, fontFamily: "inherit" }}>âœ•</button>
        </div>
        {children}
      </div>
    </div>
  );
};

// â”€â”€ Search Bar â”€â”€
const SearchBar = ({ value, onChange, placeholder }) => {
  const { mobile } = useWindowSize();
  const [focus, setFocus] = useState(false);
  return (
    <div style={{ position: "relative", flex: 1, maxWidth: mobile ? "100%" : 320 }}>
      <span style={{ position: "absolute", left: 12, top: "50%", transform: "translateY(-50%)", fontSize: 15, color: C.inkMuted }}>ğŸ”</span>
      <input value={value} onChange={(e) => onChange(e.target.value)} placeholder={placeholder || "æœå°‹..."}
        onFocus={() => setFocus(true)} onBlur={() => setFocus(false)}
        style={{ ...inputStyle, paddingLeft: 36, fontSize: 14, background: C.surface, borderColor: focus ? C.accent : C.border, boxShadow: focus ? `0 0 0 3px ${C.accent}15` : "none" }} />
    </div>
  );
};

// â”€â”€ Quick Filter Pills â”€â”€
const FilterPills = ({ options, active, onSelect }) => (
  <div style={{ display: "flex", gap: 6, overflowX: "auto", WebkitOverflowScrolling: "touch", paddingBottom: 2 }}>
    {options.map((o) => (
      <button key={o.id} onClick={() => onSelect(o.id)}
        style={{ padding: "5px 14px", borderRadius: 20, border: active === o.id ? `1.5px solid ${o.color || C.accent}` : `1px solid ${C.border}`, background: active === o.id ? `${o.color || C.accent}15` : "transparent", color: active === o.id ? (o.color || C.accent) : C.inkMuted, fontSize: 13, fontWeight: 600, cursor: "pointer", fontFamily: "inherit", whiteSpace: "nowrap", flexShrink: 0, transition: T }}>
        {o.label}
      </button>
    ))}
  </div>
);

// â”€â”€ Hoverable Card wrapper â”€â”€
const HoverCard = ({ children, onClick, selected, accentColor, style: sx, expanded }) => {
  const [hov, setHov] = useState(false);
  return (
    <div onClick={onClick}
      onMouseEnter={() => setHov(true)} onMouseLeave={() => setHov(false)}
      style={{
        background: hov ? C.cardHover : C.card,
        border: `1px solid ${selected ? (accentColor || C.ink) : (hov ? C.borderHover : C.border)}`,
        borderLeft: accentColor ? `3px solid ${accentColor}` : undefined,
        borderRadius: 12, padding: 16, cursor: onClick ? "pointer" : "default",
        transition: T,
        transform: hov && onClick && !expanded ? "translateY(-2px)" : "none",
        boxShadow: hov && onClick ? "0 8px 24px rgba(0,0,0,.25)" : "none",
        ...sx
      }}>
      {children}
    </div>
  );
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Detail Drawer â€” Slide-over panel (v5.2)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DetailDrawer = ({ open, onClose, title, icon, accentColor, children, actions, width }) => {
  const { mobile } = useWindowSize();
  const drawerW = mobile ? "100%" : (width || 480);

  useEffect(() => {
    if (!open) return;
    const h = (e) => { if (e.key === "Escape") onClose(); };
    window.addEventListener("keydown", h);
    return () => window.removeEventListener("keydown", h);
  }, [open]);

  if (!open) return null;

  return (
    <div style={{ position: "fixed", inset: 0, zIndex: 9000, display: "flex", justifyContent: "flex-end" }}>
      {/* Backdrop */}
      <div onClick={onClose} style={{
        position: "absolute", inset: 0, background: "rgba(0,0,0,.5)", backdropFilter: "blur(4px)",
        animation: "drawerFadeIn .2s ease"
      }} />
      {/* Panel */}
      <div style={{
        position: "relative", width: drawerW, maxWidth: "100%", height: "100%",
        background: C.bg, borderLeft: mobile ? "none" : `1px solid ${C.border}`,
        display: "flex", flexDirection: "column",
        boxShadow: "-20px 0 60px rgba(0,0,0,.3)",
        animation: "drawerSlideIn .28s cubic-bezier(.16,1,.3,1)"
      }}>
        {/* Header */}
        <div style={{
          padding: mobile ? "18px 20px" : "22px 28px", borderBottom: `1px solid ${C.border}`,
          display: "flex", justifyContent: "space-between", alignItems: "flex-start",
          background: accentColor ? `linear-gradient(135deg, ${accentColor}08, transparent)` : undefined
        }}>
          <div style={{ flex: 1, minWidth: 0 }}>
            <div style={{ display: "flex", alignItems: "center", gap: 10, marginBottom: 4 }}>
              {icon && <span style={{ fontSize: 20 }}>{icon}</span>}
              <div style={{ fontSize: 18, fontWeight: 800, color: C.ink, lineHeight: 1.3 }}>{title}</div>
            </div>
            {accentColor && <div style={{ width: 40, height: 3, borderRadius: 2, background: accentColor, marginTop: 8 }} />}
          </div>
          <button onClick={onClose} style={{
            width: 36, height: 36, borderRadius: 10, border: `1px solid ${C.border}`,
            background: C.surface, color: C.inkMuted, fontSize: 16, cursor: "pointer",
            display: "flex", alignItems: "center", justifyContent: "center",
            transition: T, fontFamily: "inherit", flexShrink: 0, marginLeft: 12
          }}
            onMouseEnter={(e) => { e.target.style.background = C.cardHover; e.target.style.color = C.ink; }}
            onMouseLeave={(e) => { e.target.style.background = C.surface; e.target.style.color = C.inkMuted; }}
          >âœ•</button>
        </div>
        {/* Content */}
        <div style={{
          flex: 1, overflowY: "auto", padding: mobile ? "20px 20px" : "24px 28px"
        }}>
          {children}
        </div>
        {/* Footer actions */}
        {actions && (
          <div style={{
            padding: mobile ? "16px 20px" : "18px 28px",
            borderTop: `1px solid ${C.border}`, background: `${C.surface}80`,
            display: "flex", gap: 10, flexWrap: "wrap"
          }}>
            {actions}
          </div>
        )}
      </div>
    </div>
  );
};

// Detail section helper
const DrawerSection = ({ label, children, style: sx }) => (
  <div style={{ marginBottom: 20, ...sx }}>
    <div style={{ fontSize: 11, fontWeight: 600, color: C.inkMuted, letterSpacing: ".08em", textTransform: "uppercase", marginBottom: 8 }}>{label}</div>
    {children}
  </div>
);
const DrawerField = ({ label, value, mono, color, children }) => (
  <div style={{ marginBottom: 12 }}>
    <div style={{ fontSize: 11, color: C.inkMuted, marginBottom: 3, fontWeight: 500 }}>{label}</div>
    {children || <div style={{ fontSize: 14, color: color || C.ink, fontWeight: 500, fontFamily: mono ? "'JetBrains Mono',monospace" : "inherit" }}>{value || "â€”"}</div>}
  </div>
);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Forms
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const DealForm = ({ deal, roles, onSave, onCancel }) => {
  const { mobile } = useWindowSize();
  const [f, setF] = useState(deal || { name: "", company: "", contact: "", email: "", stage: "inquiry", value: 30000, tier: "Tier 1", notes: "", role: roles[0]?.id || "howl", created: today(), signedDate: null, archived: false });
  const set = (k, v) => setF({ ...f, [k]: v });
  return (
    <div>
      <div style={{ display: "grid", gridTemplateColumns: mobile ? "1fr" : "1fr 1fr", gap: "0 18px" }}>
        <Field label="æ¡ˆä»¶åç¨± *"><input style={inputStyle} value={f.name} onChange={(e) => set("name", e.target.value)} placeholder="ä¾‹ï¼šFitTrack å¥èº« App" /></Field>
        <Field label="å…¬å¸ / åœ˜éšŠ *"><input style={inputStyle} value={f.company} onChange={(e) => set("company", e.target.value)} placeholder="ä¾‹ï¼šFitLife Inc." /></Field>
        <Field label="è¯ç¹«äºº"><input style={inputStyle} value={f.contact} onChange={(e) => set("contact", e.target.value)} /></Field>
        <Field label="Email"><input style={inputStyle} value={f.email} onChange={(e) => set("email", e.target.value)} /></Field>
        <Field label="éšæ®µ"><select style={selectStyle} value={f.stage} onChange={(e) => set("stage", e.target.value)}>{STAGES.map((s) => <option key={s.id} value={s.id}>{s.icon} {s.label}</option>)}</select></Field>
        <Field label="é‡‘é¡ (NT$)"><input style={inputStyle} type="number" step="10000" value={f.value} onChange={(e) => set("value", Number(e.target.value))} /></Field>
        <Field label="æ–¹æ¡ˆ"><select style={selectStyle} value={f.tier} onChange={(e) => set("tier", e.target.value)}>{TIERS.map((t) => <option key={t} value={t}>{t}</option>)}</select></Field>
        <Field label="è² è²¬è§’è‰²"><select style={selectStyle} value={f.role} onChange={(e) => set("role", e.target.value)}>{roles.map((r) => <option key={r.id} value={r.id}>{r.emoji} {r.name} ({r.title})</option>)}</select></Field>
      </div>
      <Field label="å‚™è¨»"><textarea style={{ ...inputStyle, minHeight: 80, resize: "vertical" }} value={f.notes} onChange={(e) => set("notes", e.target.value)} /></Field>
      <div style={{ display: "flex", gap: 12, justifyContent: "flex-end", marginTop: 10 }}>
        <Btn outline color={C.inkMuted} onClick={onCancel}>å–æ¶ˆ</Btn>
        <Btn color={C.emerald} onClick={() => { if (f.name && f.company) onSave(f); }}>{deal ? "å„²å­˜" : "æ–°å¢"}</Btn>
      </div>
    </div>
  );
};

const TaskForm = ({ task, deals, roles, onSave, onCancel }) => {
  const { mobile } = useWindowSize();
  const [f, setF] = useState(task || { text: "", role: roles[0]?.id || "howl", dealId: null, due: today(), status: "todo", priority: "mid", archived: false });
  const set = (k, v) => setF({ ...f, [k]: v });
  return (
    <div>
      <Field label="ä»»å‹™å…§å®¹ *"><input style={inputStyle} value={f.text} onChange={(e) => set("text", e.target.value)} placeholder="ä¾‹ï¼šå®Œæˆæ¢ç´¢æœƒè­°ç°¡å ±" /></Field>
      <div style={{ display: "grid", gridTemplateColumns: mobile ? "1fr" : "1fr 1fr", gap: "0 18px" }}>
        <Field label="è² è²¬è§’è‰²"><select style={selectStyle} value={f.role} onChange={(e) => set("role", e.target.value)}>{roles.map((r) => <option key={r.id} value={r.id}>{r.emoji} {r.name}</option>)}</select></Field>
        <Field label="æˆªæ­¢æ—¥æœŸ"><input style={inputStyle} type="date" value={f.due} onChange={(e) => set("due", e.target.value)} /></Field>
        <Field label="ç‹€æ…‹"><select style={selectStyle} value={f.status} onChange={(e) => set("status", e.target.value)}>{TASK_STATUS.map((s) => <option key={s.id} value={s.id}>{s.icon} {s.label}</option>)}</select></Field>
        <Field label="å„ªå…ˆç´š"><select style={selectStyle} value={f.priority} onChange={(e) => set("priority", e.target.value)}>{PRIORITY.map((p) => <option key={p.id} value={p.id}>{p.icon} {p.label}</option>)}</select></Field>
      </div>
      <Field label="é—œè¯æ¡ˆä»¶">
        <select style={selectStyle} value={f.dealId || ""} onChange={(e) => set("dealId", e.target.value ? Number(e.target.value) : null)}>
          <option value="">â€” ä¸é—œè¯ â€”</option>
          {deals.map((d) => <option key={d.id} value={d.id}>{d.name}</option>)}
        </select>
      </Field>
      <div style={{ display: "flex", gap: 12, justifyContent: "flex-end", marginTop: 10 }}>
        <Btn outline color={C.inkMuted} onClick={onCancel}>å–æ¶ˆ</Btn>
        <Btn color={C.emerald} onClick={() => { if (f.text) onSave(f); }}>{task ? "å„²å­˜" : "æ–°å¢"}</Btn>
      </div>
    </div>
  );
};

const LeadForm = ({ lead, roles, onSave, onCancel }) => {
  const { mobile } = useWindowSize();
  const [f, setF] = useState(lead || { name: "", title: "", company: "", channel: "LinkedIn", status: "identified", notes: "", lastTouch: today(), role: roles[0]?.id || "sophie", archived: false });
  const set = (k, v) => setF({ ...f, [k]: v });
  return (
    <div>
      <div style={{ display: "grid", gridTemplateColumns: mobile ? "1fr" : "1fr 1fr", gap: "0 18px" }}>
        <Field label="å§“å *"><input style={inputStyle} value={f.name} onChange={(e) => set("name", e.target.value)} /></Field>
        <Field label="è·ç¨±"><input style={inputStyle} value={f.title} onChange={(e) => set("title", e.target.value)} /></Field>
        <Field label="å…¬å¸ *"><input style={inputStyle} value={f.company} onChange={(e) => set("company", e.target.value)} /></Field>
        <Field label="ç®¡é“"><select style={selectStyle} value={f.channel} onChange={(e) => set("channel", e.target.value)}>{BD_CHANNELS.map((c) => <option key={c} value={c}>{c}</option>)}</select></Field>
        <Field label="ç‹€æ…‹"><select style={selectStyle} value={f.status} onChange={(e) => set("status", e.target.value)}>{BD_STATUS.map((s) => <option key={s.id} value={s.id}>{s.icon} {s.label}</option>)}</select></Field>
        <Field label="è² è²¬è§’è‰²"><select style={selectStyle} value={f.role} onChange={(e) => set("role", e.target.value)}>{roles.map((r) => <option key={r.id} value={r.id}>{r.emoji} {r.name}</option>)}</select></Field>
      </div>
      <Field label="å‚™è¨»"><textarea style={{ ...inputStyle, minHeight: 80, resize: "vertical" }} value={f.notes} onChange={(e) => set("notes", e.target.value)} /></Field>
      <div style={{ display: "flex", gap: 12, justifyContent: "flex-end", marginTop: 10 }}>
        <Btn outline color={C.inkMuted} onClick={onCancel}>å–æ¶ˆ</Btn>
        <Btn color={C.emerald} onClick={() => { if (f.name && f.company) onSave(f); }}>{lead ? "å„²å­˜" : "æ–°å¢"}</Btn>
      </div>
    </div>
  );
};

// â”€â”€ Role Form â”€â”€
const EMOJI_OPTIONS = ["ğŸ§™","ğŸ”¥","ğŸŒ¿","ğŸŒ¸","ğŸ¥•","âš¡","ğŸ¯","ğŸ¦Š","ğŸ»","ğŸ¨","ğŸ“","ğŸ›¡ï¸","ğŸ’","ğŸŒŠ","ğŸ”ï¸","ğŸ¦…"];
const COLOR_OPTIONS = [C.accent, C.orange, C.emerald, C.rose, C.violet, C.cyan, C.gold, "#FF6B6B", "#4ECDC4", "#45B7D1"];

const RoleForm = ({ role, onSave, onCancel }) => {
  const { mobile } = useWindowSize();
  const [f, setF] = useState(role || { name: "", title: "", emoji: "âš¡", color: C.cyan });
  const set = (k, v) => setF({ ...f, [k]: v });
  return (
    <div>
      <div style={{ display: "grid", gridTemplateColumns: mobile ? "1fr" : "1fr 1fr", gap: "0 18px" }}>
        <Field label="è§’è‰²åç¨± *"><input style={inputStyle} value={f.name} onChange={(e) => set("name", e.target.value)} placeholder="ä¾‹ï¼šåŠ©ç†" /></Field>
        <Field label="è·ç¨±"><input style={inputStyle} value={f.title} onChange={(e) => set("title", e.target.value)} placeholder="ä¾‹ï¼šPM" /></Field>
      </div>
      <Field label="åœ–ç¤º">
        <div style={{ display: "flex", gap: 8, flexWrap: "wrap" }}>
          {EMOJI_OPTIONS.map((e) => (
            <button key={e} onClick={() => set("emoji", e)}
              style={{ width: 40, height: 40, borderRadius: 10, border: f.emoji === e ? `2px solid ${C.accent}` : `1px solid ${C.border}`, background: f.emoji === e ? C.accentSoft : "transparent", fontSize: 20, cursor: "pointer", display: "flex", alignItems: "center", justifyContent: "center", transition: T }}>{e}</button>
          ))}
        </div>
      </Field>
      <Field label="é¡è‰²">
        <div style={{ display: "flex", gap: 8, flexWrap: "wrap" }}>
          {COLOR_OPTIONS.map((c) => (
            <button key={c} onClick={() => set("color", c)}
              style={{ width: 36, height: 36, borderRadius: 10, border: f.color === c ? "2px solid white" : "2px solid transparent", background: c, cursor: "pointer", transition: T }} />
          ))}
        </div>
      </Field>
      <div style={{ marginTop: 18, padding: 16, background: C.surface, borderRadius: 12 }}>
        <div style={{ fontSize: 13, color: C.inkMuted, marginBottom: 8 }}>é è¦½</div>
        <span style={{ display: "inline-flex", alignItems: "center", gap: 8, padding: "6px 14px", borderRadius: 10, background: `${f.color}18`, color: f.color, fontSize: 15, fontWeight: 600 }}>{f.emoji} {f.name || "æœªå‘½å"} <span style={{ fontSize: 12, opacity: .6 }}>({f.title || "ç„¡è·ç¨±"})</span></span>
      </div>
      <div style={{ display: "flex", gap: 12, justifyContent: "flex-end", marginTop: 18 }}>
        <Btn outline color={C.inkMuted} onClick={onCancel}>å–æ¶ˆ</Btn>
        <Btn color={C.emerald} onClick={() => { if (f.name) onSave(f); }}>{role ? "å„²å­˜" : "æ–°å¢è§’è‰²"}</Btn>
      </div>
    </div>
  );
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// View Components
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€ Stats Row (North Star Metrics) â”€â”€
const StatsRow = ({ deals, tasks, leads, onHealthClick }) => {
  const { mobile } = useWindowSize();
  const active = deals.filter((d) => !d.archived && !["won", "lost"].includes(d.stage));
  const won = deals.filter((d) => !d.archived && d.stage === "won");
  const all = deals.filter((d) => !d.archived);
  const stageWeights = { inquiry: 0.1, exploring: 0.25, proposal: 0.5, negotiation: 0.75, won: 1, lost: 0 };
  const weightedPipeline = active.reduce((s, d) => s + d.value * (stageWeights[d.stage] || 0.1), 0);

  const wonTotal = won.reduce((s, d) => s + d.value, 0);
  const lost = deals.filter((d) => !d.archived && d.stage === "lost");
  const closed = won.length + lost.length;
  const winRate = closed > 0 ? Math.round((won.length / closed) * 100) : 0;
  const wonWithDates = won.filter(d => d.signedDate && d.created);
  const avgCycle = wonWithDates.length > 0 ? Math.round(wonWithDates.reduce((s, d) => s + (new Date(d.signedDate) - new Date(d.created)) / 86400000, 0) / wonWithDates.length) : null;

  const stats = [
    { label: "ğŸ‰ å·²ç°½ç´„ç‡Ÿæ”¶", value: fmt(wonTotal), color: C.emerald, sub: `${won.length} ä»¶æˆäº¤ Â· åŒ—æ¥µæ˜ŸæŒ‡æ¨™ â­` },
    { label: "ğŸ† è´å–®ç‡", value: `${winRate}%`, color: winRate >= 50 ? C.emerald : winRate >= 30 ? C.gold : C.rose, sub: closed > 0 ? `å·²çµæ¡ˆ ${closed} æ¡ˆï¼ˆè´ ${won.length} / è¼¸ ${lost.length}ï¼‰` : "å°šç„¡å·²çµæ¡ˆæ¡ˆä»¶" },
    { label: "ğŸ“Š åŠ æ¬Šç®¡ç·šå€¼", value: fmt(Math.round(weightedPipeline)), color: C.gold, sub: `${active.length} é€²è¡Œä¸­ Â· é ä¼°è½‰æ›æ”¶å…¥` },
    { label: "â± æˆäº¤é€±æœŸ", value: avgCycle !== null ? `${avgCycle} å¤©` : "â€”", color: avgCycle !== null ? (avgCycle <= 14 ? C.emerald : avgCycle <= 30 ? C.gold : C.orange) : C.inkMuted, sub: avgCycle !== null ? `æ´½è©¢â†’ç°½ç´„å¹³å‡ ${avgCycle} å¤©` : "å°šç„¡æˆäº¤æ•¸æ“š" },
  ];
  return (
    <div style={{ display: "grid", gridTemplateColumns: mobile ? "1fr 1fr" : "repeat(4,1fr)", gap: mobile ? 10 : 16, marginBottom: mobile ? 20 : 28, position: "relative" }}>
      {stats.map((s, i) => (
        <HoverCard key={i}
          style={{ padding: mobile ? "14px 16px" : "20px 24px" }}>
          <div style={{ fontSize: 12, color: C.inkMuted, marginBottom: 6, fontWeight: 500, letterSpacing: ".04em" }}>{s.label}</div>
          <div style={{ fontSize: mobile ? 22 : 28, fontWeight: 800, color: s.color, fontFamily: "'JetBrains Mono',monospace" }}>{s.value}</div>
          {s.sub && <div style={{ fontSize: 11, color: C.inkMuted, marginTop: 4 }}>{s.sub}</div>}
        </HoverCard>
      ))}
    </div>
  );
};

// â”€â”€ Pipeline (Deals) with Detail Drawer â”€â”€
const PipelineView = ({ deals, roles, onArchive, onUpdate, onStageChange, expandedId, onExpand }) => {
  const { mobile, tablet } = useWindowSize();
  const [editing, setEditing] = useState(false);
  const [draft, setDraft] = useState(null);
  const active = deals.filter((d) => !d.archived);
  const selectedDeal = active.find((d) => d.id === expandedId);
  const displayStage = editing && draft ? draft.stage : selectedDeal?.stage;
  const selectedStage = displayStage ? STAGES.find((s) => s.id === displayStage) : null;

  useEffect(() => { setEditing(false); setDraft(null); }, [expandedId]);
  const startEdit = () => { setDraft({...selectedDeal}); setEditing(true); };
  const cancelEdit = () => { setDraft(null); setEditing(false); };
  const saveEdit = () => { if (draft && draft.name && draft.company) { onUpdate(draft); setEditing(false); setDraft(null); } };
  const setD = (k, v) => setDraft(prev => ({...prev, [k]: v}));

  const DealCard = ({ d, stage }) => {
    const isSelected = expandedId === d.id;
    return (
      <div style={{ marginBottom: 8 }}>
        <HoverCard onClick={() => onExpand(isSelected ? null : d.id)} selected={isSelected} accentColor={stage.color}>
          <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start" }}>
            <div style={{ fontSize: 14, fontWeight: 700, color: C.ink, lineHeight: 1.4, flex: 1 }}>{d.name}</div>
            <span style={{ fontSize: 13, color: C.inkMuted, opacity: .6 }}>â†’</span>
          </div>
          <div style={{ fontSize: 12, color: C.inkMuted, margin: "6px 0 8px" }}>{d.company}</div>
          <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
            <Badge color={C.gold} bg={C.goldSoft} small>{fmt(d.value)}</Badge>
            <RolePill roleId={d.role} roles={roles} />
          </div>
        </HoverCard>
      </div>
    );
  };

  // Deal Detail Drawer â€” inline editable (v5.3)
  const dealDrawer = selectedDeal && selectedStage && (
    <DetailDrawer open={!!selectedDeal} onClose={() => { cancelEdit(); onExpand(null); }}
      title={editing ? "ç·¨è¼¯æ¡ˆä»¶" : selectedDeal.name}
      icon={editing ? "âœï¸" : selectedStage.icon}
      accentColor={selectedStage.color}
      actions={editing ? <>
        <Btn small color={C.emerald} onClick={saveEdit}>ğŸ’¾ å„²å­˜è®Šæ›´</Btn>
        <Btn small outline color={C.inkMuted} onClick={cancelEdit}>å–æ¶ˆ</Btn>
      </> : <>
        <Btn small color={C.accent} onClick={startEdit}>âœï¸ ç·¨è¼¯</Btn>
        <Btn small outline color={C.rose} onClick={() => { onArchive(selectedDeal.id); onExpand(null); }}>ğŸ“¦ å°å­˜</Btn>
      </>}
    >
      {/* Stage quick-switch â€” always visible */}
      <div style={{ marginBottom: 20 }}>
        <div style={{ fontSize: 11, fontWeight: 600, color: C.inkMuted, letterSpacing: ".08em", textTransform: "uppercase", marginBottom: 8 }}>éšæ®µ</div>
        <div style={{ display: "flex", gap: 6, flexWrap: "wrap" }}>
          {STAGES.map((s) => {
            const current = editing && draft ? draft.stage : selectedDeal.stage;
            return (
              <button key={s.id} onClick={() => {
                if (editing) setD("stage", s.id);
                else onStageChange(selectedDeal.id, s.id);
              }}
                style={{ padding: "6px 14px", borderRadius: 9, border: current === s.id ? `1.5px solid ${s.color}` : `1px solid ${C.border}`, background: current === s.id ? `${s.color}20` : "transparent", color: current === s.id ? s.color : C.inkMuted, fontSize: 12, fontWeight: 600, cursor: "pointer", fontFamily: "inherit", whiteSpace: "nowrap", transition: T }}>
                {s.icon} {s.label}
              </button>
            );
          })}
        </div>
      </div>

      {editing && draft ? (
        <>
          <DrawerSection label="æ¡ˆä»¶è³‡è¨Š">
            <Field label="æ¡ˆä»¶åç¨±"><input style={inputStyle} value={draft.name} onChange={(e) => setD("name", e.target.value)} /></Field>
            <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: "0 14px" }}>
              <Field label="é‡‘é¡ (NT$)"><input style={inputStyle} type="number" step="10000" value={draft.value} onChange={(e) => setD("value", Number(e.target.value))} /></Field>
              <Field label="æ–¹æ¡ˆ"><select style={selectStyle} value={draft.tier} onChange={(e) => setD("tier", e.target.value)}>{TIERS.map((t) => <option key={t} value={t}>{t}</option>)}</select></Field>
            </div>
            <Field label="è² è²¬è§’è‰²"><select style={selectStyle} value={draft.role} onChange={(e) => setD("role", e.target.value)}>{roles.map((r) => <option key={r.id} value={r.id}>{r.emoji} {r.name} ({r.title})</option>)}</select></Field>
          </DrawerSection>
          <DrawerSection label="å®¢æˆ¶è³‡è¨Š">
            <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: "0 14px" }}>
              <Field label="å…¬å¸"><input style={inputStyle} value={draft.company} onChange={(e) => setD("company", e.target.value)} /></Field>
              <Field label="è¯ç¹«äºº"><input style={inputStyle} value={draft.contact} onChange={(e) => setD("contact", e.target.value)} /></Field>
            </div>
            <Field label="Email"><input style={inputStyle} type="email" value={draft.email} onChange={(e) => setD("email", e.target.value)} /></Field>
          </DrawerSection>
          <DrawerSection label="å‚™è¨»">
            <textarea style={{ ...inputStyle, minHeight: 100, resize: "vertical" }} value={draft.notes} onChange={(e) => setD("notes", e.target.value)} placeholder="æ¡ˆä»¶å‚™å¿˜éŒ„..." />
          </DrawerSection>
        </>
      ) : (
        <>
          {/* View mode */}
          <div style={{ display: "flex", alignItems: "center", gap: 10, marginBottom: 20 }}>
            <Badge color={C.gold} bg={C.goldSoft}>{fmt(selectedDeal.value)}</Badge>
            <Badge color={C.accent} bg={C.accentSoft}>{selectedDeal.tier}</Badge>
          </div>
          <DrawerSection label="å®¢æˆ¶è³‡è¨Š">
            <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 4 }}>
              <DrawerField label="å…¬å¸" value={selectedDeal.company} />
              <DrawerField label="è¯ç¹«äºº" value={selectedDeal.contact} />
              <DrawerField label="Email" value={selectedDeal.email} />
              <DrawerField label="å»ºç«‹æ—¥æœŸ" value={selectedDeal.created} mono />
            </div>
          </DrawerSection>
          {selectedDeal.signedDate && (
            <DrawerSection label="ç°½ç´„è³‡è¨Š">
              <DrawerField label="ç°½ç´„æ—¥æœŸ" value={selectedDeal.signedDate} mono color={C.emerald} />
            </DrawerSection>
          )}
          <DrawerSection label="è² è²¬äºº">
            <RolePill roleId={selectedDeal.role} roles={roles} />
          </DrawerSection>
          {selectedDeal.notes && (
            <DrawerSection label="å‚™è¨»">
              <div style={{ background: C.surface, borderRadius: 10, padding: 14, fontSize: 14, color: C.inkSoft, lineHeight: 1.8, border: `1px solid ${C.border}` }}>{selectedDeal.notes}</div>
            </DrawerSection>
          )}
        </>
      )}
    </DetailDrawer>
  );

  if (mobile) {
    return (
      <>
        <div style={{ display: "flex", flexDirection: "column", gap: 16 }}>
          {STAGES.map((stage) => {
            const sd = active.filter((d) => d.stage === stage.id);
            if (sd.length === 0) return null;
            return (
              <div key={stage.id}>
                <div style={{ display: "flex", alignItems: "center", gap: 8, marginBottom: 10 }}>
                  <span style={{ fontSize: 14, fontWeight: 700, color: stage.color }}>{stage.icon} {stage.label}</span>
                  <span style={{ fontSize: 12, color: C.inkMuted, background: C.surface, padding: "1px 8px", borderRadius: 10 }}>{sd.length}</span>
                </div>
                {sd.map((d) => <DealCard key={d.id} d={d} stage={stage} />)}
              </div>
            );
          })}
        </div>
        {dealDrawer}
      </>
    );
  }

  return (
    <>
      <div style={{ overflowX: "auto", paddingBottom: 8 }}>
        <div style={{ display: "grid", gridTemplateColumns: `repeat(${STAGES.length}, minmax(200px, 1fr))`, gap: 12, minWidth: tablet ? STAGES.length * 210 : "auto" }}>
          {STAGES.map((stage) => {
            const sd = active.filter((d) => d.stage === stage.id);
            return (
              <div key={stage.id}>
                <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 10 }}>
                  <span style={{ fontSize: 13, fontWeight: 700, color: stage.color }}>{stage.icon} {stage.label}</span>
                  <span style={{ fontSize: 12, color: C.inkMuted, background: C.surface, padding: "1px 8px", borderRadius: 10 }}>{sd.length}</span>
                </div>
                <div style={{ height: 3, background: `${stage.color}15`, borderRadius: 2, marginBottom: 10 }}>
                  <div style={{ height: "100%", width: sd.length ? "100%" : 0, background: stage.color, borderRadius: 2, transition: "width .4s ease" }} />
                </div>
                <div style={{ display: "flex", flexDirection: "column", gap: 4 }}>
                  {sd.map((d) => <DealCard key={d.id} d={d} stage={stage} />)}
                  {sd.length === 0 && <div style={{ padding: 24, textAlign: "center", color: C.inkMuted, fontSize: 12, border: `1px dashed ${C.border}`, borderRadius: 10 }}>æš«ç„¡æ¡ˆä»¶</div>}
                </div>
              </div>
            );
          })}
        </div>
      </div>
      {dealDrawer}
    </>
  );
};

// â”€â”€ Tasks View (v5.2: Detail Drawer) â”€â”€
const TasksView = ({ tasks, deals, roles, onEdit, onArchive, onStatusChange, search, filter }) => {
  const { mobile, tablet } = useWindowSize();
  const [selectedId, setSelectedId] = useState(null);

  let visible = tasks.filter((t) => !t.archived);
  if (search) { const q = search.toLowerCase(); visible = visible.filter((t) => t.text.toLowerCase().includes(q)); }
  if (filter === "overdue") visible = visible.filter((t) => t.status !== "done" && t.due < today());
  else if (filter === "high") visible = visible.filter((t) => t.priority === "high");
  else if (filter && filter !== "all") visible = visible.filter((t) => t.role === filter);

  const selectedTask = visible.find((t) => t.id === selectedId) || tasks.find((t) => t.id === selectedId);

  const TaskCard = ({ t }) => {
    const dl = deals.find((d) => d.id === t.dealId);
    const isOverdue = t.status !== "done" && t.due < today();
    const isSelected = selectedId === t.id;
    const st = TASK_STATUS.find((s) => s.id === t.status);

    return (
      <div style={{ marginBottom: 6 }}>
        <HoverCard onClick={() => setSelectedId(isSelected ? null : t.id)} selected={isSelected}>
          <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start", gap: 10 }}>
            <div style={{ display: "flex", alignItems: "flex-start", gap: 8, flex: 1 }}>
              <PriorityDot priority={t.priority} />
              <span style={{ fontSize: 14, color: C.ink, lineHeight: 1.5, flex: 1 }}>{t.text}</span>
            </div>
            <span style={{ fontSize: 13, color: C.inkMuted, opacity: .6 }}>â†’</span>
          </div>
          <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", flexWrap: "wrap", gap: 6, marginTop: 8 }}>
            <RolePill roleId={t.role} roles={roles} />
            <span style={{ fontSize: 11, color: isOverdue ? C.rose : C.inkMuted, fontWeight: isOverdue ? 700 : 400, fontFamily: "monospace" }}>{isOverdue ? "âš ï¸ " : ""}{t.due}</span>
          </div>
        </HoverCard>
      </div>
    );
  };

  // Task Detail Drawer
  const taskDrawer = selectedTask && (() => {
    const dl = deals.find((d) => d.id === selectedTask.dealId);
    const st = TASK_STATUS.find((s) => s.id === selectedTask.status);
    const pri = PRIORITY.find((p) => p.id === selectedTask.priority);
    const isOverdue = selectedTask.status !== "done" && selectedTask.due < today();
    return (
      <DetailDrawer open={!!selectedTask} onClose={() => setSelectedId(null)}
        title={selectedTask.text} icon={pri?.icon || "ğŸ“‹"} accentColor={st?.color}
        actions={<>
          <Btn small color={C.accent} onClick={() => onEdit(selectedTask)}>âœï¸ ç·¨è¼¯ä»»å‹™</Btn>
          <Btn small outline color={C.rose} onClick={() => { onArchive(selectedTask.id); setSelectedId(null); }}>ğŸ“¦ å°å­˜</Btn>
        </>}
      >
        {/* Status badge row */}
        <div style={{ display: "flex", alignItems: "center", gap: 10, marginBottom: 20, flexWrap: "wrap" }}>
          <Badge color={st?.color} bg={`${st?.color}18`}>{st?.icon} {st?.label}</Badge>
          <Badge color={pri?.color || C.inkMuted} bg={`${(pri?.color || C.inkMuted)}18`}>{pri?.icon} {pri?.label}</Badge>
          {isOverdue && <Badge color={C.rose} bg={`${C.rose}18`}>âš ï¸ é€¾æœŸ</Badge>}
        </div>
        {/* Status quick-switch */}
        <DrawerSection label="è®Šæ›´ç‹€æ…‹">
          <div style={{ display: "flex", gap: 8, flexWrap: "wrap" }}>
            {TASK_STATUS.map((s) => (
              <button key={s.id} onClick={() => onStatusChange(selectedTask.id, s.id)}
                style={{ padding: "8px 16px", borderRadius: 10, border: selectedTask.status === s.id ? `2px solid ${s.color}` : `1px solid ${C.border}`, background: selectedTask.status === s.id ? `${s.color}15` : C.surface, color: selectedTask.status === s.id ? s.color : C.inkMuted, fontSize: 13, fontWeight: 600, cursor: "pointer", fontFamily: "inherit", transition: T }}>
                {s.icon} {s.label}
              </button>
            ))}
          </div>
        </DrawerSection>
        <DrawerSection label="è©³ç´°è³‡è¨Š">
          <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 4 }}>
            <DrawerField label="åˆ°æœŸæ—¥" value={selectedTask.due} mono color={isOverdue ? C.rose : undefined} />
            <DrawerField label="è² è²¬äºº"><RolePill roleId={selectedTask.role} roles={roles} /></DrawerField>
          </div>
        </DrawerSection>
        {dl && (
          <DrawerSection label="é—œè¯æ¡ˆä»¶">
            <div style={{ background: C.surface, borderRadius: 10, padding: 14, border: `1px solid ${C.border}`, display: "flex", alignItems: "center", gap: 10 }}>
              <span style={{ fontSize: 16 }}>ğŸ“</span>
              <div>
                <div style={{ fontSize: 14, fontWeight: 600, color: C.ink }}>{dl.name}</div>
                <div style={{ fontSize: 12, color: C.inkMuted }}>{dl.company} Â· {fmt(dl.value)}</div>
              </div>
            </div>
          </DrawerSection>
        )}
      </DetailDrawer>
    );
  })();

  if (mobile) {
    return (
      <>
      <div style={{ display: "flex", flexDirection: "column", gap: 20 }}>
        {TASK_STATUS.map((st) => {
          const items = visible.filter((t) => t.status === st.id);
          return (
            <div key={st.id}>
              <div style={{ display: "flex", alignItems: "center", gap: 8, marginBottom: 10, paddingBottom: 10, borderBottom: `1px solid ${C.border}` }}>
                <span style={{ fontSize: 15, fontWeight: 700, color: st.color }}>{st.icon} {st.label}</span>
                <span style={{ fontSize: 12, color: C.inkMuted, background: C.surface, padding: "1px 8px", borderRadius: 10 }}>{items.length}</span>
              </div>
              <div style={{ display: "flex", flexDirection: "column", gap: 4 }}>
                {items.map((t) => <TaskCard key={t.id} t={t} />)}
                {items.length === 0 && <div style={{ padding: 16, textAlign: "center", color: C.inkMuted, fontSize: 13 }}>æš«ç„¡ä»»å‹™</div>}
              </div>
            </div>
          );
        })}
      </div>
      {taskDrawer}
      </>
    );
  }

  return (
    <>
    <div style={{ display: "grid", gridTemplateColumns: tablet ? "1fr 1fr" : "repeat(3,1fr)", gap: 16 }}>
      {TASK_STATUS.map((st) => {
        const items = visible.filter((t) => t.status === st.id);
        return (
          <div key={st.id}>
            <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 12 }}>
              <span style={{ fontSize: 14, fontWeight: 700, color: st.color }}>{st.icon} {st.label}</span>
              <span style={{ fontSize: 12, color: C.inkMuted, background: C.surface, padding: "1px 8px", borderRadius: 10 }}>{items.length}</span>
            </div>
            <div style={{ height: 3, background: `${st.color}15`, borderRadius: 2, marginBottom: 12 }}>
              <div style={{ height: "100%", width: items.length ? "100%" : 0, background: st.color, borderRadius: 2, transition: "width .4s ease" }} />
            </div>
            <div style={{ display: "flex", flexDirection: "column", gap: 4 }}>
              {items.map((t) => <TaskCard key={t.id} t={t} />)}
              {items.length === 0 && <div style={{ padding: 24, textAlign: "center", color: C.inkMuted, fontSize: 13, border: `1px dashed ${C.border}`, borderRadius: 10 }}>æš«ç„¡ä»»å‹™</div>}
            </div>
          </div>
        );
      })}
    </div>
    {taskDrawer}
    </>
  );
};

// â”€â”€ BD Tracker View (v5.2: Detail Drawer) â”€â”€
const BDTrackerView = ({ leads, roles, onEdit, onArchive, onConvert }) => {
  const { mobile, tablet } = useWindowSize();
  const [selectedId, setSelectedId] = useState(null);
  const active = leads.filter((l) => !l.archived);

  const total = active.length;
  const inProgress = active.filter((l) => !["converted", "dormant"].includes(l.status)).length;
  const booked = active.filter((l) => l.status === "call_booked").length;
  const converted = active.filter((l) => l.status === "converted").length;

  const selectedLead = active.find((l) => l.id === selectedId);
  const selectedStatus = selectedLead ? BD_STATUS.find((s) => s.id === selectedLead.status) : null;

  const LeadCard = ({ lead, status }) => {
    const isSelected = selectedId === lead.id;
    return (
      <div style={{ marginBottom: 6 }}>
        <HoverCard onClick={() => setSelectedId(isSelected ? null : lead.id)} accentColor={status.color} selected={isSelected}>
          <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start" }}>
            <div style={{ fontSize: 14, fontWeight: 700, color: C.ink }}>{lead.name}</div>
            <span style={{ fontSize: 13, color: C.inkMuted, opacity: .6 }}>â†’</span>
          </div>
          <div style={{ fontSize: 12, color: C.inkMuted, marginTop: 2 }}>{lead.title}</div>
          <div style={{ fontSize: 13, color: C.inkSoft, margin: "4px 0 8px" }}>{lead.company}</div>
          <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
            <span style={{ fontSize: 11, color: C.inkMuted, background: C.surface, padding: "2px 8px", borderRadius: 6 }}>{lead.channel}</span>
            <RolePill roleId={lead.role} roles={roles} />
          </div>
        </HoverCard>
      </div>
    );
  };

  // Lead Detail Drawer
  const leadDrawer = selectedLead && selectedStatus && (
    <DetailDrawer open={!!selectedLead} onClose={() => setSelectedId(null)}
      title={selectedLead.name} icon="ğŸ¯" accentColor={selectedStatus.color}
      actions={<>
        <Btn small color={C.accent} onClick={() => onEdit(selectedLead)}>âœï¸ ç·¨è¼¯</Btn>
        {selectedLead.status === "call_booked" && <Btn small color={C.emerald} onClick={() => { onConvert(selectedLead); setSelectedId(null); }}>ğŸ¯ è½‰å…¥æ¼æ–—</Btn>}
        <Btn small outline color={C.rose} onClick={() => { onArchive(selectedLead.id); setSelectedId(null); }}>ğŸ“¦ å°å­˜</Btn>
      </>}
    >
      <div style={{ display: "flex", alignItems: "center", gap: 10, marginBottom: 20, flexWrap: "wrap" }}>
        <Badge color={selectedStatus.color} bg={`${selectedStatus.color}18`}>{selectedStatus.icon} {selectedStatus.label}</Badge>
        <span style={{ fontSize: 12, color: C.inkMuted, fontFamily: "monospace" }}>æœ€å¾Œäº’å‹• {selectedLead.lastTouch}</span>
      </div>
      <DrawerSection label="è¯ç¹«äººè³‡è¨Š">
        <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 4 }}>
          <DrawerField label="å§“å" value={selectedLead.name} />
          <DrawerField label="è·ç¨±" value={selectedLead.title} />
          <DrawerField label="å…¬å¸" value={selectedLead.company} />
          <DrawerField label="ä¾†æºç®¡é“" value={selectedLead.channel} />
        </div>
      </DrawerSection>
      <DrawerSection label="è² è²¬äºº">
        <RolePill roleId={selectedLead.role} roles={roles} />
      </DrawerSection>
      {selectedLead.notes && (
        <DrawerSection label="å‚™è¨»èˆ‡äº’å‹•ç´€éŒ„">
          <div style={{ background: C.surface, borderRadius: 10, padding: 14, fontSize: 14, color: C.inkSoft, lineHeight: 1.8, border: `1px solid ${C.border}` }}>{selectedLead.notes}</div>
        </DrawerSection>
      )}
    </DetailDrawer>
  );

  return (
    <>
    <div>
      <div style={{ display: "grid", gridTemplateColumns: mobile ? "1fr 1fr" : "repeat(4,1fr)", gap: mobile ? 10 : 16, marginBottom: 24 }}>
        {[
          { label: "ç¸½è¿½è¹¤", value: total, color: C.accent },
          { label: "é€²è¡Œä¸­", value: inProgress, color: C.cyan },
          { label: "å·²ç´„è¨ª", value: booked, color: C.emerald },
          { label: "å·²è½‰å…¥", value: converted, color: C.violet },
        ].map((s, i) => (
          <HoverCard key={i} style={{ padding: mobile ? "12px 14px" : "18px 22px" }}>
            <div style={{ fontSize: 12, color: C.inkMuted, marginBottom: 6, fontWeight: 500 }}>{s.label}</div>
            <div style={{ fontSize: mobile ? 22 : 26, fontWeight: 800, color: s.color, fontFamily: "'JetBrains Mono',monospace" }}>{s.value}</div>
          </HoverCard>
        ))}
      </div>

      {mobile ? (
        <div style={{ display: "flex", flexDirection: "column", gap: 16 }}>
          {BD_STATUS.map((st) => {
            const sl = active.filter((l) => l.status === st.id);
            if (!sl.length) return null;
            return (
              <div key={st.id}>
                <div style={{ display: "flex", alignItems: "center", gap: 8, marginBottom: 10 }}>
                  <span style={{ fontSize: 14, fontWeight: 700, color: st.color }}>{st.icon} {st.label}</span>
                  <span style={{ fontSize: 12, color: C.inkMuted, background: C.surface, padding: "1px 8px", borderRadius: 10 }}>{sl.length}</span>
                </div>
                <div style={{ display: "flex", flexDirection: "column", gap: 4 }}>{sl.map((l) => <LeadCard key={l.id} lead={l} status={st} />)}</div>
              </div>
            );
          })}
        </div>
      ) : (
        <div style={{ overflowX: "auto", paddingBottom: 12 }}>
          <div style={{ display: "grid", gridTemplateColumns: `repeat(${BD_STATUS.length}, minmax(180px, 1fr))`, gap: 12, minWidth: BD_STATUS.length * 190 }}>
            {BD_STATUS.map((st) => {
              const sl = active.filter((l) => l.status === st.id);
              return (
                <div key={st.id}>
                  <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 10 }}>
                    <span style={{ fontSize: 13, fontWeight: 700, color: st.color }}>{st.icon} {st.label}</span>
                    <span style={{ fontSize: 12, color: C.inkMuted, background: C.surface, padding: "1px 8px", borderRadius: 10 }}>{sl.length}</span>
                  </div>
                  <div style={{ height: 3, background: `${st.color}15`, borderRadius: 2, marginBottom: 10 }}>
                    <div style={{ height: "100%", width: sl.length ? "100%" : 0, background: st.color, borderRadius: 2, transition: "width .4s ease" }} />
                  </div>
                  <div style={{ display: "flex", flexDirection: "column", gap: 4 }}>
                    {sl.map((l) => <LeadCard key={l.id} lead={l} status={st} />)}
                    {!sl.length && <div style={{ padding: 24, textAlign: "center", color: C.inkMuted, fontSize: 13, border: `1px dashed ${C.border}`, borderRadius: 10 }}>æš«ç„¡</div>}
                  </div>
                </div>
              );
            })}
          </div>
        </div>
      )}
    </div>
    {leadDrawer}
    </>
  );
};

// â”€â”€ Analytics View â”€â”€
const AnalyticsView = ({ deals, roles, goals: savedGoals, onGoalsChange }) => {
  const { mobile } = useWindowSize();
  const [period, setPeriod] = useState("month"); // month | quarter | year
  const [selectedRole, setSelectedRole] = useState("all");
  const [showGoalEditor, setShowGoalEditor] = useState(false);
  const [goalDraft, setGoalDraft] = useState(null);
  const activeRoles = roles.filter((r) => !r.archived);

  const now = new Date();
  const currentYear = now.getFullYear();
  const currentMonth = now.getMonth();
  const currentQuarter = Math.floor(currentMonth / 3);

  // Filter deals by period
  const inPeriod = (dateStr) => {
    if (!dateStr) return false;
    const d = new Date(dateStr);
    if (period === "month") return d.getFullYear() === currentYear && d.getMonth() === currentMonth;
    if (period === "quarter") return d.getFullYear() === currentYear && Math.floor(d.getMonth() / 3) === currentQuarter;
    return d.getFullYear() === currentYear;
  };

  const allDeals = deals.filter((d) => !d.archived);
  const periodDeals = allDeals.filter((d) => inPeriod(d.created));
  const periodWon = allDeals.filter((d) => d.stage === "won" && inPeriod(d.signedDate || d.created));
  const filtered = selectedRole === "all" ? periodDeals : periodDeals.filter((d) => d.role === selectedRole);
  const filteredWon = selectedRole === "all" ? periodWon : periodWon.filter((d) => d.role === selectedRole);

  // Goals â€” user-configurable, persisted to localStorage
  const defaultGoals = { month: { deals: 5, revenue: 300000 }, quarter: { deals: 12, revenue: 800000 }, year: { deals: 40, revenue: 3000000 } };
  const goals = savedGoals || defaultGoals;
  const goal = goals[period];
  const wonRevenue = filteredWon.reduce((s, d) => s + d.value, 0);
  const pipelineValue = filtered.filter((d) => !["won", "lost"].includes(d.stage)).reduce((s, d) => s + d.value, 0);

  const pctDeals = goal.deals > 0 ? Math.round((filteredWon.length / goal.deals) * 100) : 0;
  const pctRevenue = goal.revenue > 0 ? Math.round((wonRevenue / goal.revenue) * 100) : 0;

  // Deal Velocity â€” days from created to signedDate for won deals
  const velocityDeals = allDeals.filter((d) => d.stage === "won" && d.signedDate && d.created);
  const velocities = velocityDeals.map((d) => {
    const start = new Date(d.created);
    const end = new Date(d.signedDate);
    return Math.max(1, Math.round((end - start) / (1000 * 60 * 60 * 24)));
  });
  const avgVelocity = velocities.length > 0 ? Math.round(velocities.reduce((a, b) => a + b, 0) / velocities.length) : 0;

  // Role performance
  const rolePerf = activeRoles.map((r) => {
    const rd = allDeals.filter((d) => d.role === r.id);
    const rWon = rd.filter((d) => d.stage === "won" && inPeriod(d.signedDate || d.created));
    const rActive = rd.filter((d) => !d.archived && !["won", "lost"].includes(d.stage) && inPeriod(d.created));
    const rv = rd.filter((d) => d.stage === "won" && d.signedDate && d.created);
    const rVelocities = rv.map((d) => Math.max(1, Math.round((new Date(d.signedDate) - new Date(d.created)) / 86400000)));
    const rAvgV = rVelocities.length > 0 ? Math.round(rVelocities.reduce((a, b) => a + b, 0) / rVelocities.length) : 0;
    return { ...r, wonCount: rWon.length, wonRevenue: rWon.reduce((s, d) => s + d.value, 0), activeCount: rActive.length, avgVelocity: rAvgV, totalDeals: rd.filter((d) => inPeriod(d.created)).length };
  });

  const periodLabels = { month: "æœ¬æœˆ", quarter: "æœ¬å­£", year: "æœ¬å¹´" };

  const ProgressBar = ({ value, max, color }) => {
    const pct = max > 0 ? Math.min(100, Math.round((value / max) * 100)) : 0;
    return (
      <div style={{ position: "relative", height: 10, background: C.surface, borderRadius: 6, overflow: "hidden" }}>
        <div style={{ height: "100%", width: `${pct}%`, background: color, borderRadius: 6, transition: "width .6s cubic-bezier(.4,0,.2,1)" }} />
      </div>
    );
  };

  return (
    <div>
      {/* Period selector + role filter + goal settings */}
      <div style={{ display: "flex", flexDirection: mobile ? "column" : "row", gap: 12, marginBottom: 24, alignItems: mobile ? "stretch" : "center" }}>
        <div style={{ display: "flex", gap: 4, background: C.surface, borderRadius: 10, padding: 4 }}>
          {["month", "quarter", "year"].map((p) => (
            <button key={p} onClick={() => setPeriod(p)}
              style={{ padding: "7px 18px", borderRadius: 8, border: "none", cursor: "pointer", fontSize: 14, fontWeight: 600, fontFamily: "inherit", background: period === p ? C.card : "transparent", color: period === p ? C.ink : C.inkMuted, transition: T }}>
              {periodLabels[p]}
            </button>
          ))}
        </div>
        <div style={{ display: "flex", gap: 6, flexWrap: "wrap", flex: 1 }}>
          <button onClick={() => setSelectedRole("all")}
            style={{ padding: "5px 14px", borderRadius: 20, border: selectedRole === "all" ? `1.5px solid ${C.accent}` : `1px solid ${C.border}`, background: selectedRole === "all" ? `${C.accent}15` : "transparent", color: selectedRole === "all" ? C.accent : C.inkMuted, fontSize: 13, fontWeight: 600, cursor: "pointer", fontFamily: "inherit", transition: T }}>å…¨å“¡</button>
          {activeRoles.map((r) => (
            <button key={r.id} onClick={() => setSelectedRole(r.id)}
              style={{ padding: "5px 14px", borderRadius: 20, border: selectedRole === r.id ? `1.5px solid ${r.color}` : `1px solid ${C.border}`, background: selectedRole === r.id ? `${r.color}15` : "transparent", color: selectedRole === r.id ? r.color : C.inkMuted, fontSize: 13, fontWeight: 600, cursor: "pointer", fontFamily: "inherit", transition: T }}>
              {r.emoji} {r.name}
            </button>
          ))}
        </div>
        <button onClick={() => { setGoalDraft(JSON.parse(JSON.stringify(goals))); setShowGoalEditor(!showGoalEditor); }}
          style={{ padding: "7px 14px", borderRadius: 10, border: `1px solid ${showGoalEditor ? C.accent : C.border}`, background: showGoalEditor ? `${C.accent}15` : "transparent", color: showGoalEditor ? C.accent : C.inkMuted, fontSize: 13, fontWeight: 600, cursor: "pointer", fontFamily: "inherit", transition: T, whiteSpace: "nowrap", display: "flex", alignItems: "center", gap: 6 }}>
          âš™ï¸ ç›®æ¨™è¨­å®š
        </button>
      </div>

      {/* Goal Editor Panel */}
      {showGoalEditor && goalDraft && (
        <div style={{ background: C.card, border: `1px solid ${C.borderHover}`, borderRadius: 14, padding: mobile ? 20 : 24, marginBottom: 24, animation: "drawerFadeIn .2s ease" }}>
          <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 18 }}>
            <div style={{ fontSize: 16, fontWeight: 800, color: C.ink }}>ğŸ¯ èª¿æ•´æ¥­ç¸¾ç›®æ¨™</div>
            <button onClick={() => setShowGoalEditor(false)} style={{ background: `${C.inkMuted}15`, border: "none", color: C.inkMuted, fontSize: 14, padding: "4px 10px", borderRadius: 8, cursor: "pointer", fontFamily: "inherit" }}>âœ•</button>
          </div>
          <div style={{ display: "grid", gridTemplateColumns: mobile ? "1fr" : "1fr 1fr 1fr", gap: 16 }}>
            {[{ key: "month", label: "æœˆç›®æ¨™" }, { key: "quarter", label: "å­£ç›®æ¨™" }, { key: "year", label: "å¹´ç›®æ¨™" }].map(({ key, label }) => (
              <div key={key} style={{ background: C.surface, borderRadius: 12, padding: 16, border: `1px solid ${C.border}` }}>
                <div style={{ fontSize: 13, fontWeight: 700, color: C.gold, marginBottom: 12 }}>{label}</div>
                <div style={{ marginBottom: 10 }}>
                  <label style={{ display: "block", fontSize: 12, color: C.inkMuted, marginBottom: 4 }}>ç°½ç´„ä»¶æ•¸</label>
                  <input type="number" min="0" step="1" value={goalDraft[key].deals}
                    onChange={(e) => setGoalDraft({ ...goalDraft, [key]: { ...goalDraft[key], deals: Math.max(0, Number(e.target.value)) } })}
                    style={{ ...inputStyle, padding: "8px 12px", fontSize: 15, fontWeight: 700, fontFamily: "'JetBrains Mono',monospace" }} />
                </div>
                <div>
                  <label style={{ display: "block", fontSize: 12, color: C.inkMuted, marginBottom: 4 }}>ç‡Ÿæ”¶ç›®æ¨™ (NT$)</label>
                  <input type="number" min="0" step="10000" value={goalDraft[key].revenue}
                    onChange={(e) => setGoalDraft({ ...goalDraft, [key]: { ...goalDraft[key], revenue: Math.max(0, Number(e.target.value)) } })}
                    style={{ ...inputStyle, padding: "8px 12px", fontSize: 15, fontWeight: 700, fontFamily: "'JetBrains Mono',monospace" }} />
                </div>
              </div>
            ))}
          </div>
          <div style={{ display: "flex", gap: 10, justifyContent: "flex-end", marginTop: 18 }}>
            <Btn outline color={C.inkMuted} small onClick={() => setShowGoalEditor(false)}>å–æ¶ˆ</Btn>
            <Btn color={C.emerald} small onClick={() => { onGoalsChange(goalDraft); setShowGoalEditor(false); }}>å„²å­˜ç›®æ¨™</Btn>
          </div>
        </div>
      )}

      {/* Goal Progress */}
      <div style={{ display: "grid", gridTemplateColumns: mobile ? "1fr" : "1fr 1fr", gap: 16, marginBottom: 24 }}>
        <HoverCard style={{ padding: 24 }}>
          <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 12 }}>
            <div style={{ fontSize: 14, fontWeight: 700, color: C.ink }}>ğŸ¯ {periodLabels[period]}ç°½ç´„ç›®æ¨™</div>
            <span style={{ fontSize: 22, fontWeight: 800, color: pctDeals >= 100 ? C.emerald : C.gold, fontFamily: "monospace" }}>{pctDeals}%</span>
          </div>
          <ProgressBar value={filteredWon.length} max={goal.deals} color={pctDeals >= 100 ? C.emerald : C.accent} />
          <div style={{ display: "flex", justifyContent: "space-between", marginTop: 8, fontSize: 12, color: C.inkMuted }}>
            <span>å·²ç°½ç´„ {filteredWon.length} ä»¶</span><span>ç›®æ¨™ {goal.deals} ä»¶</span>
          </div>
        </HoverCard>
        <HoverCard style={{ padding: 24 }}>
          <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 12 }}>
            <div style={{ fontSize: 14, fontWeight: 700, color: C.ink }}>ğŸ’° {periodLabels[period]}ç‡Ÿæ”¶ç›®æ¨™</div>
            <span style={{ fontSize: 22, fontWeight: 800, color: pctRevenue >= 100 ? C.emerald : C.gold, fontFamily: "monospace" }}>{pctRevenue}%</span>
          </div>
          <ProgressBar value={wonRevenue} max={goal.revenue} color={pctRevenue >= 100 ? C.emerald : C.gold} />
          <div style={{ display: "flex", justifyContent: "space-between", marginTop: 8, fontSize: 12, color: C.inkMuted }}>
            <span>å·²ç°½ç´„ {fmt(wonRevenue)}</span><span>ç›®æ¨™ {fmt(goal.revenue)}</span>
          </div>
        </HoverCard>
      </div>

      {/* Key Metrics */}
      <div style={{ display: "grid", gridTemplateColumns: mobile ? "1fr 1fr" : "repeat(4,1fr)", gap: 12, marginBottom: 24 }}>
        {[
          { label: `${periodLabels[period]}é€²ä»¶`, value: filtered.length, color: C.accent },
          { label: "ç®¡ç·šç¸½å€¼", value: fmt(pipelineValue), color: C.gold },
          { label: "å¹³å‡ç°½ç´„é€Ÿåº¦", value: avgVelocity > 0 ? `${avgVelocity} å¤©` : "â€”", color: C.cyan },
          { label: "ç°½ç´„ç‡", value: filtered.length > 0 ? `${Math.round((filteredWon.length / filtered.length) * 100)}%` : "â€”", color: C.emerald },
        ].map((s, i) => (
          <HoverCard key={i} style={{ padding: mobile ? "14px 16px" : "18px 22px" }}>
            <div style={{ fontSize: 12, color: C.inkMuted, marginBottom: 6, fontWeight: 500 }}>{s.label}</div>
            <div style={{ fontSize: mobile ? 20 : 24, fontWeight: 800, color: s.color, fontFamily: "'JetBrains Mono',monospace" }}>{s.value}</div>
          </HoverCard>
        ))}
      </div>

      {/* Deal Velocity Table */}
      <div style={{ marginBottom: 24 }}>
        <h3 style={{ fontSize: 16, fontWeight: 800, color: C.ink, marginBottom: 14 }}>âš¡ æ¡ˆä»¶é€Ÿåº¦åˆ†æ</h3>
        {velocityDeals.length === 0 ? (
          <div style={{ padding: 24, textAlign: "center", color: C.inkMuted, fontSize: 14, background: C.surface, borderRadius: 12 }}>å°šç„¡å·²ç°½ç´„æ¡ˆä»¶è³‡æ–™</div>
        ) : (
          <div style={{ overflowX: "auto" }}>
            <table style={{ width: "100%", borderCollapse: "separate", borderSpacing: "0 4px" }}>
              <thead>
                <tr>{["æ¡ˆä»¶", "å…¬å¸", "é€²ä»¶æ—¥", "ç°½ç´„æ—¥", "å¤©æ•¸", "é‡‘é¡", "è©•ç´š"].map((h) => <th key={h} style={{ padding: "10px 14px", textAlign: "left", fontSize: 12, fontWeight: 600, color: C.inkMuted, borderBottom: `1px solid ${C.border}` }}>{h}</th>)}</tr>
              </thead>
              <tbody>
                {velocityDeals.map((d) => {
                  const days = Math.max(1, Math.round((new Date(d.signedDate) - new Date(d.created)) / 86400000));
                  const speed = days <= 14 ? { label: "ğŸš€ å¿«é€Ÿ", color: C.emerald } : days <= 30 ? { label: "âœ… æ­£å¸¸", color: C.accent } : { label: "ğŸ¢ åæ…¢", color: C.orange };
                  return (
                    <tr key={d.id}>
                      <td style={{ padding: "10px 14px", fontSize: 14, fontWeight: 600, color: C.ink, background: C.card, borderRadius: "8px 0 0 8px" }}>{d.name}</td>
                      <td style={{ padding: "10px 14px", fontSize: 13, color: C.inkSoft, background: C.card }}>{d.company}</td>
                      <td style={{ padding: "10px 14px", fontSize: 12, color: C.inkMuted, fontFamily: "monospace", background: C.card }}>{d.created}</td>
                      <td style={{ padding: "10px 14px", fontSize: 12, color: C.inkMuted, fontFamily: "monospace", background: C.card }}>{d.signedDate}</td>
                      <td style={{ padding: "10px 14px", fontSize: 14, fontWeight: 700, color: speed.color, fontFamily: "monospace", background: C.card }}>{days}</td>
                      <td style={{ padding: "10px 14px", fontSize: 13, color: C.gold, fontFamily: "monospace", background: C.card }}>{fmt(d.value)}</td>
                      <td style={{ padding: "10px 14px", background: C.card, borderRadius: "0 8px 8px 0" }}><Badge color={speed.color} bg={`${speed.color}15`} small>{speed.label}</Badge></td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>
        )}
      </div>

      {/* Role Performance */}
      <div>
        <h3 style={{ fontSize: 16, fontWeight: 800, color: C.ink, marginBottom: 14 }}>ğŸ‘¥ {periodLabels[period]}è§’è‰²æ¥­ç¸¾æ’è¡Œ</h3>
        <div style={{ display: "grid", gridTemplateColumns: mobile ? "1fr" : "repeat(auto-fill, minmax(280px, 1fr))", gap: 12 }}>
          {rolePerf.sort((a, b) => b.wonRevenue - a.wonRevenue).map((r) => (
            <HoverCard key={r.id} style={{ padding: 20, borderTop: `3px solid ${r.color}` }}>
              <div style={{ display: "flex", alignItems: "center", gap: 10, marginBottom: 14 }}>
                <span style={{ fontSize: 26 }}>{r.emoji}</span>
                <div>
                  <div style={{ fontSize: 16, fontWeight: 800, color: r.color }}>{r.name}</div>
                  <div style={{ fontSize: 12, color: C.inkMuted }}>{r.title}</div>
                </div>
              </div>
              <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 10 }}>
                <div style={{ background: C.surface, borderRadius: 8, padding: "8px 12px" }}>
                  <div style={{ fontSize: 10, color: C.inkMuted }}>é€²ä»¶</div>
                  <div style={{ fontSize: 18, fontWeight: 700, color: C.accent, fontFamily: "monospace" }}>{r.totalDeals}</div>
                </div>
                <div style={{ background: C.surface, borderRadius: 8, padding: "8px 12px" }}>
                  <div style={{ fontSize: 10, color: C.inkMuted }}>ç°½ç´„</div>
                  <div style={{ fontSize: 18, fontWeight: 700, color: C.emerald, fontFamily: "monospace" }}>{r.wonCount}</div>
                </div>
                <div style={{ background: C.surface, borderRadius: 8, padding: "8px 12px" }}>
                  <div style={{ fontSize: 10, color: C.inkMuted }}>ç°½ç´„é‡‘é¡</div>
                  <div style={{ fontSize: 14, fontWeight: 700, color: C.gold, fontFamily: "monospace" }}>{fmt(r.wonRevenue)}</div>
                </div>
                <div style={{ background: C.surface, borderRadius: 8, padding: "8px 12px" }}>
                  <div style={{ fontSize: 10, color: C.inkMuted }}>å¹³å‡é€Ÿåº¦</div>
                  <div style={{ fontSize: 14, fontWeight: 700, color: C.cyan, fontFamily: "monospace" }}>{r.avgVelocity > 0 ? `${r.avgVelocity} å¤©` : "â€”"}</div>
                </div>
              </div>
            </HoverCard>
          ))}
        </div>
      </div>
    </div>
  );
};

// â”€â”€ Documents / Templates View â”€â”€
const DocumentsView = () => {
  const { mobile } = useWindowSize();
  const [catFilter, setCatFilter] = useState("å…¨éƒ¨");
  const [copied, setCopied] = useState(null);

  const filtered = catFilter === "å…¨éƒ¨" ? DOC_TEMPLATES : DOC_TEMPLATES.filter((d) => d.category === catFilter);

  const copyLink = (url) => {
    const fullUrl = window.location.origin + url;
    navigator.clipboard?.writeText(fullUrl).then(() => {
      setCopied(url);
      setTimeout(() => setCopied(null), 2000);
    });
  };

  const formatColors = { DOCX: C.accent, PPTX: C.orange, PDF: C.rose, XLSX: C.emerald };

  return (
    <div>
      <div style={{ fontSize: 15, color: C.inkSoft, marginBottom: 20, lineHeight: 1.7 }}>æ¥­å‹™ææ¡ˆã€åˆç´„ç¯„æœ¬èˆ‡æ–‡ä»¶è³‡æºã€‚é»æ“Šä¸‹è¼‰æˆ–è¤‡è£½é€£çµåˆ†äº«çµ¦å®¢æˆ¶ã€‚</div>

      {/* Category filter */}
      <div style={{ display: "flex", gap: 6, marginBottom: 20, flexWrap: "wrap" }}>
        {DOC_CATEGORIES.map((cat) => (
          <button key={cat} onClick={() => setCatFilter(cat)}
            style={{ padding: "6px 16px", borderRadius: 20, border: catFilter === cat ? `1.5px solid ${C.accent}` : `1px solid ${C.border}`, background: catFilter === cat ? `${C.accent}15` : "transparent", color: catFilter === cat ? C.accent : C.inkMuted, fontSize: 13, fontWeight: 600, cursor: "pointer", fontFamily: "inherit", transition: T }}>
            {cat}
          </button>
        ))}
      </div>

      <div style={{ display: "grid", gridTemplateColumns: mobile ? "1fr" : "repeat(auto-fill, minmax(340px, 1fr))", gap: 12 }}>
        {filtered.map((doc) => (
          <HoverCard key={doc.id} style={{ padding: 20 }}>
            <div style={{ display: "flex", gap: 14, alignItems: "flex-start" }}>
              <span style={{ fontSize: 28, flexShrink: 0 }}>{doc.icon}</span>
              <div style={{ flex: 1, minWidth: 0 }}>
                <div style={{ display: "flex", alignItems: "center", gap: 8, marginBottom: 4 }}>
                  <div style={{ fontSize: 15, fontWeight: 700, color: C.ink }}>{doc.name}</div>
                  <Badge color={formatColors[doc.format] || C.inkMuted} bg={`${formatColors[doc.format] || C.inkMuted}15`} small>{doc.format}</Badge>
                </div>
                <div style={{ fontSize: 13, color: C.inkSoft, lineHeight: 1.6, marginBottom: 12 }}>{doc.desc}</div>
                <div style={{ display: "flex", gap: 8 }}>
                  <Btn small color={C.accent} onClick={() => window.open(doc.url, "_blank")}>â¬‡ ä¸‹è¼‰</Btn>
                  <Btn small outline color={copied === doc.url ? C.emerald : C.inkMuted} onClick={() => copyLink(doc.url)}>
                    {copied === doc.url ? "âœ… å·²è¤‡è£½" : "ğŸ”— è¤‡è£½é€£çµ"}
                  </Btn>
                </div>
              </div>
            </div>
          </HoverCard>
        ))}
      </div>
    </div>
  );
};

// â”€â”€ Roles Management View â”€â”€
const RolesView = ({ roles, onAdd, onEdit, onArchive }) => {
  const { mobile } = useWindowSize();
  return (
    <div>
      <div style={{ fontSize: 15, color: C.inkSoft, marginBottom: 20, lineHeight: 1.7 }}>ç®¡ç†åŸå ¡è§’è‰²ã€‚æ–°å¢è‡ªè¨‚è§’è‰²ã€ä¿®æ”¹åç¨±èˆ‡åœ–ç¤ºï¼Œæˆ–å°å­˜ä¸å†ä½¿ç”¨çš„è§’è‰²ã€‚</div>
      <div style={{ display: "grid", gridTemplateColumns: mobile ? "1fr" : "repeat(3,1fr)", gap: 14 }}>
        {roles.filter((r) => !r.archived).map((r) => (
          <HoverCard key={r.id} style={{ padding: 24, borderTop: `3px solid ${r.color}` }}>
            <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start" }}>
              <div style={{ display: "flex", alignItems: "center", gap: 12 }}>
                <span style={{ fontSize: 32 }}>{r.emoji}</span>
                <div>
                  <div style={{ fontSize: 18, fontWeight: 800, color: r.color }}>{r.name}</div>
                  <div style={{ fontSize: 13, color: C.inkMuted }}>{r.title}</div>
                </div>
              </div>
              <div style={{ display: "flex", gap: 6 }}>
                <Btn small color={C.accent} onClick={() => onEdit(r)}>ç·¨è¼¯</Btn>
                <Btn small outline color={C.rose} onClick={() => onArchive(r.id)}>å°å­˜</Btn>
              </div>
            </div>
          </HoverCard>
        ))}
        {/* Add new role card */}
        <button onClick={onAdd} style={{ background: "transparent", border: `2px dashed ${C.border}`, borderRadius: 12, padding: 24, cursor: "pointer", display: "flex", flexDirection: "column", alignItems: "center", justifyContent: "center", gap: 10, minHeight: 110, transition: T }}>
          <span style={{ fontSize: 28, color: C.inkMuted }}>+</span>
          <span style={{ fontSize: 14, color: C.inkMuted, fontFamily: "inherit" }}>æ–°å¢è§’è‰²</span>
        </button>
      </div>
    </div>
  );
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Main App
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ Command Palette (Cmd+K) â”€â”€
const CommandPalette = ({ open, onClose, onAction }) => {
  const [q, setQ] = useState("");
  const inputRef = useRef(null);
  const { mobile } = useWindowSize();

  useEffect(() => { if (open && inputRef.current) setTimeout(() => inputRef.current.focus(), 50); }, [open]);

  const commands = [
    { id: "addDeal", label: "æ–°å¢æ¡ˆä»¶", icon: "ğŸ“Š", shortcut: "D" },
    { id: "addTask", label: "æ–°å¢ä»»å‹™", icon: "ğŸ“‹", shortcut: "T" },
    { id: "addLead", label: "æ–°å¢ BD å°è±¡", icon: "ğŸ¯", shortcut: "B" },
    { id: "addRole", label: "æ–°å¢è§’è‰²", icon: "ğŸ‘¥", shortcut: "R" },
    { id: "goToPipeline", label: "å‰å¾€æ¥­å‹™æ¼æ–—", icon: "ğŸ“Š", shortcut: "1" },
    { id: "goToTasks", label: "å‰å¾€ä»»å‹™çœ‹æ¿", icon: "ğŸ“‹", shortcut: "2" },
    { id: "goToBD", label: "å‰å¾€ BD é–‹ç™¼", icon: "ğŸ¯", shortcut: "3" },
    { id: "goToAnalytics", label: "å‰å¾€æ•¸æ“šåˆ†æ", icon: "ğŸ“ˆ", shortcut: "4" },
    { id: "goToDocs", label: "å‰å¾€æ–‡ä»¶è³‡æº", icon: "ğŸ“", shortcut: "5" },
    { id: "goToRoles", label: "å‰å¾€è§’è‰²ç®¡ç†", icon: "ğŸ‘¥", shortcut: "6" },
    { id: "exportDeals", label: "åŒ¯å‡ºæ¡ˆä»¶ CSV", icon: "â¬‡", shortcut: null },
    { id: "exportTasks", label: "åŒ¯å‡ºä»»å‹™ CSV", icon: "â¬‡", shortcut: null },
    { id: "exportLeads", label: "åŒ¯å‡º BD å°è±¡ CSV", icon: "â¬‡", shortcut: null },
  ];

  const filtered = q ? commands.filter((c) => c.label.toLowerCase().includes(q.toLowerCase())) : commands;

  if (!open) return null;
  return (
    <div style={{ position: "fixed", inset: 0, background: "rgba(0,0,0,.6)", backdropFilter: "blur(8px)", display: "flex", alignItems: "flex-start", justifyContent: "center", paddingTop: mobile ? 60 : 120, zIndex: 1200 }} onClick={onClose}>
      <div onClick={(e) => e.stopPropagation()} style={{ background: C.card, border: `1px solid ${C.borderHover}`, borderRadius: 16, width: mobile ? "92%" : 480, overflow: "hidden", boxShadow: "0 20px 60px rgba(0,0,0,.5)" }}>
        <div style={{ padding: "16px 18px", borderBottom: `1px solid ${C.border}`, display: "flex", alignItems: "center", gap: 10 }}>
          <span style={{ color: C.inkMuted, fontSize: 16 }}>ğŸ”</span>
          <input ref={inputRef} value={q} onChange={(e) => setQ(e.target.value)} placeholder="è¼¸å…¥æŒ‡ä»¤... (æ–°å¢ã€å‰å¾€ã€åŒ¯å‡º)"
            onKeyDown={(e) => { if (e.key === "Escape") onClose(); if (e.key === "Enter" && filtered.length > 0) { onAction(filtered[0].id); onClose(); } }}
            style={{ flex: 1, background: "transparent", border: "none", color: C.ink, fontSize: 15, outline: "none", fontFamily: "inherit" }} />
          <span style={{ fontSize: 11, color: C.inkMuted, background: C.surface, padding: "2px 8px", borderRadius: 6 }}>ESC</span>
        </div>
        <div style={{ maxHeight: 320, overflowY: "auto", padding: "6px 0" }}>
          {filtered.map((cmd) => (
            <button key={cmd.id} onClick={() => { onAction(cmd.id); onClose(); }}
              style={{ display: "flex", alignItems: "center", gap: 12, width: "100%", padding: "10px 18px", border: "none", background: "transparent", color: C.ink, fontSize: 14, cursor: "pointer", fontFamily: "inherit", transition: T, textAlign: "left" }}
              onMouseEnter={(e) => e.currentTarget.style.background = C.surface}
              onMouseLeave={(e) => e.currentTarget.style.background = "transparent"}>
              <span style={{ fontSize: 16 }}>{cmd.icon}</span>
              <span style={{ flex: 1 }}>{cmd.label}</span>
              {cmd.shortcut && <span style={{ fontSize: 11, color: C.inkMuted, background: C.surface, padding: "2px 8px", borderRadius: 6, fontFamily: "monospace" }}>{cmd.shortcut}</span>}
            </button>
          ))}
          {filtered.length === 0 && <div style={{ padding: 20, textAlign: "center", color: C.inkMuted, fontSize: 13 }}>æ‰¾ä¸åˆ°æŒ‡ä»¤</div>}
        </div>
      </div>
    </div>
  );
};

// â”€â”€ Activity Log Sidebar â”€â”€
const ActivityLog = ({ log, open, onClose }) => {
  const { mobile } = useWindowSize();
  if (!open) return null;
  return (
    <div style={{ position: "fixed", inset: 0, zIndex: 1050, display: "flex", justifyContent: "flex-end" }} onClick={onClose}>
      <div onClick={(e) => e.stopPropagation()}
        style={{ width: mobile ? "100%" : 380, height: "100%", background: C.card, borderLeft: `1px solid ${C.borderHover}`, padding: "24px 20px", overflowY: "auto", boxShadow: "-8px 0 30px rgba(0,0,0,.3)" }}>
        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 20 }}>
          <h3 style={{ margin: 0, fontSize: 18, fontWeight: 800, color: C.ink }}>ğŸ“œ æ´»å‹•ç´€éŒ„</h3>
          <button onClick={onClose} style={{ background: `${C.inkMuted}15`, border: "none", color: C.inkMuted, cursor: "pointer", fontSize: 14, padding: "6px 10px", borderRadius: 8, fontFamily: "inherit" }}>âœ•</button>
        </div>
        {log.length === 0 ? (
          <div style={{ textAlign: "center", color: C.inkMuted, fontSize: 14, paddingTop: 40 }}>å°šç„¡æ´»å‹•ç´€éŒ„</div>
        ) : (
          <div style={{ display: "flex", flexDirection: "column", gap: 4 }}>
            {log.map((entry, i) => (
              <div key={i} style={{ padding: "12px 14px", background: i === 0 ? `${C.accent}08` : "transparent", borderRadius: 10, borderLeft: `3px solid ${entry.color || C.accent}`, transition: T }}>
                <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 4 }}>
                  <span style={{ fontSize: 13, fontWeight: 600, color: C.ink }}>{entry.icon} {entry.action}</span>
                  <span style={{ fontSize: 11, color: C.inkMuted }}>{timeAgo(entry.time)}</span>
                </div>
                <div style={{ fontSize: 12, color: C.inkSoft }}>{entry.detail}</div>
              </div>
            ))}
          </div>
        )}
      </div>
    </div>
  );
};

function CastleDashboard() {
  const { mobile } = useWindowSize();
  const [user, setUser] = useState(() => ls.getUser());
  const [tab, setTab] = useState("pipeline");
  const [deals, setDeals] = usePersisted("deals", INIT_DEALS);
  const [tasks, setTasks] = usePersisted("tasks", INIT_TASKS);
  const [leads, setLeads] = usePersisted("leads", INIT_LEADS);
  const [roles, setRoles] = usePersisted("roles", DEFAULT_ROLES);
  const [modal, setModal] = useState(null);
  const [editItem, setEditItem] = useState(null);
  const [toast, setToast] = useState(null);
  const [confirmAction, setConfirmAction] = useState(null);
  const [taskSearch, setTaskSearch] = useState("");
  const [taskFilter, setTaskFilter] = useState("all");
  const [expandedDealId, setExpandedDealId] = useState(null);
  const [cmdOpen, setCmdOpen] = useState(false);
  const [logOpen, setLogOpen] = useState(false);
  const [activityLog, setActivityLog] = usePersisted("log", []);
  const [goals, setGoals] = usePersisted("goals", { month: { deals: 5, revenue: 300000 }, quarter: { deals: 12, revenue: 800000 }, year: { deals: 40, revenue: 3000000 } });
  const [syncing, setSyncing] = useState(false);

  const nDeal = useRef(Math.max(...(deals.length ? deals : INIT_DEALS).map((d) => d.id)) + 1);
  const nTask = useRef(Math.max(...(tasks.length ? tasks : INIT_TASKS).map((t) => t.id)) + 1);
  const nLead = useRef(Math.max(...(leads.length ? leads : INIT_LEADS).map((l) => l.id)) + 1);
  const nRole = useRef(100);

  // â”€â”€ Google Login Handler â”€â”€
  const handleGoogleLogin = useCallback(async (credential) => {
    // Decode JWT from Google Sign-In
    const payload = JSON.parse(atob(credential.split(".")[1]));
    const u = { email: payload.email, name: payload.name, picture: payload.picture };
    setUser(u);
    ls.setUser(u);
    // Notify API
    api.post("login", u.email, u);
    // Try to load cloud data
    const cloud = await api.get("getAll", u.email);
    if (cloud && (cloud.deals?.length || cloud.tasks?.length || cloud.leads?.length)) {
      if (cloud.deals?.length) setDeals(cloud.deals);
      if (cloud.tasks?.length) setTasks(cloud.tasks);
      if (cloud.leads?.length) setLeads(cloud.leads);
    }
  }, []);

  const handleLogout = () => {
    setUser(null);
    ls.setUser(null);
  };

  // â”€â”€ Cloud Sync (manual) â”€â”€
  const syncToCloud = useCallback(async () => {
    if (!user || !API_URL) return;
    setSyncing(true);
    await api.post("syncAll", user.email, { deals, tasks, leads });
    setSyncing(false);
  }, [user, deals, tasks, leads]);

  // â”€â”€ Activity Logger â”€â”€
  const addLog = useCallback((icon, action, detail, color) => {
    setActivityLog((prev) => [{ icon, action, detail, color, time: new Date().toISOString() }, ...prev].slice(0, 50));
  }, []);

  // â”€â”€ Google Sign-In Initialization â”€â”€
  useEffect(() => {
    if (!GOOGLE_CLIENT_ID || typeof google === "undefined") return;
    try {
      google.accounts.id.initialize({
        client_id: GOOGLE_CLIENT_ID,
        callback: (response) => handleGoogleLogin(response.credential),
        auto_select: true,
      });
      // Render sign-in button if not logged in
      if (!user) {
        const el = document.getElementById("g_id_signin");
        if (el) google.accounts.id.renderButton(el, { theme: "filled_black", size: "medium", shape: "pill", text: "signin_with" });
        google.accounts.id.prompt(); // One Tap
      }
    } catch (e) { console.warn("Google Sign-In init error:", e); }
  }, [user, handleGoogleLogin]);

  // â”€â”€ Keyboard Shortcuts â”€â”€
  useEffect(() => {
    const handler = (e) => {
      if ((e.metaKey || e.ctrlKey) && e.key === "k") { e.preventDefault(); setCmdOpen(true); }
    };
    window.addEventListener("keydown", handler);
    return () => window.removeEventListener("keydown", handler);
  }, []);

  // â”€â”€ Archive with Undo + Activity Log â”€â”€
  const archiveDeal = (id) => {
    const d = deals.find((x) => x.id === id);
    setDeals((p) => p.map((d) => d.id === id ? { ...d, archived: true } : d));
    setExpandedDealId(null);
    addLog("ğŸ“¦", "å°å­˜æ¡ˆä»¶", d?.name || "", C.rose);
    setToast({ message: "æ¡ˆä»¶å·²å°å­˜", undo: () => setDeals((p) => p.map((d) => d.id === id ? { ...d, archived: false } : d)) });
  };
  const archiveTask = (id) => {
    const t = tasks.find((x) => x.id === id);
    setTasks((p) => p.map((t) => t.id === id ? { ...t, archived: true } : t));
    addLog("ğŸ“¦", "å°å­˜ä»»å‹™", t?.text || "", C.rose);
    setToast({ message: "ä»»å‹™å·²å°å­˜", undo: () => setTasks((p) => p.map((t) => t.id === id ? { ...t, archived: false } : t)) });
  };
  const archiveLead = (id) => {
    const l = leads.find((x) => x.id === id);
    setLeads((p) => p.map((l) => l.id === id ? { ...l, archived: true } : l));
    addLog("ğŸ“¦", "å°å­˜ BD å°è±¡", l?.name || "", C.rose);
    setToast({ message: "BD å°è±¡å·²å°å­˜", undo: () => setLeads((p) => p.map((l) => l.id === id ? { ...l, archived: false } : l)) });
  };
  const archiveRole = (id) => {
    setConfirmAction({
      title: "å°å­˜è§’è‰²", message: "å°å­˜å¾Œæ­¤è§’è‰²ä¸æœƒå‡ºç¾åœ¨é¸é …ä¸­ï¼Œä½†å·²æŒ‡æ´¾çš„ä»»å‹™ä¸å—å½±éŸ¿ã€‚ç¢ºå®šå—ï¼Ÿ",
      onConfirm: () => {
        setRoles((p) => p.map((r) => r.id === id ? { ...r, archived: true } : r));
        setToast({ message: "è§’è‰²å·²å°å­˜", undo: () => setRoles((p) => p.map((r) => r.id === id ? { ...r, archived: false } : r)) });
        setConfirmAction(null);
      }
    });
  };

  // â”€â”€ CRUD + Activity Log â”€â”€
  const addDeal = (d) => { setDeals([...deals, { ...d, id: nDeal.current++ }]); setModal(null); addLog("ğŸ“Š", "æ–°å¢æ¡ˆä»¶", d.name, C.emerald); };
  const updateDeal = (d) => { setDeals(deals.map((x) => x.id === d.id ? d : x)); setModal(null); setEditItem(null); addLog("âœï¸", "ç·¨è¼¯æ¡ˆä»¶", d.name, C.accent); };
  const changeStage = (id, stage) => {
    const d = deals.find((x) => x.id === id);
    const st = STAGES.find((s) => s.id === stage);
    setDeals(deals.map((d) => d.id === id ? { ...d, stage, signedDate: stage === "won" ? (d.signedDate || today()) : d.signedDate } : d));
    addLog(st?.icon || "ğŸ”„", "åˆ‡æ›éšæ®µ", `${d?.name} â†’ ${st?.label}`, st?.color || C.accent);
  };

  const addTask = (t) => { setTasks([...tasks, { ...t, id: nTask.current++ }]); setModal(null); addLog("ğŸ“‹", "æ–°å¢ä»»å‹™", t.text, C.cyan); };
  const updateTask = (t) => { setTasks(tasks.map((x) => x.id === t.id ? t : x)); setModal(null); setEditItem(null); addLog("âœï¸", "ç·¨è¼¯ä»»å‹™", t.text, C.accent); };
  const changeTaskStatus = (id, status) => {
    const t = tasks.find((x) => x.id === id);
    const st = TASK_STATUS.find((s) => s.id === status);
    setTasks(tasks.map((t) => t.id === id ? { ...t, status } : t));
    addLog(st?.icon || "ğŸ”„", "æ›´æ–°ä»»å‹™ç‹€æ…‹", `${t?.text} â†’ ${st?.label}`, st?.color || C.accent);
  };

  const addLead = (l) => { setLeads([...leads, { ...l, id: nLead.current++ }]); setModal(null); addLog("ğŸ¯", "æ–°å¢ BD å°è±¡", `${l.name} (${l.company})`, C.cyan); };
  const updateLead = (l) => { setLeads(leads.map((x) => x.id === l.id ? l : x)); setModal(null); setEditItem(null); addLog("âœï¸", "ç·¨è¼¯ BD å°è±¡", l.name, C.accent); };
  const convertLead = (lead) => {
    const nd = { id: nDeal.current++, name: `${lead.company} å°ˆæ¡ˆ`, company: lead.company, contact: lead.name, email: "", stage: "inquiry", value: 30000, tier: "Tier 1", notes: `å¾ BD è½‰å…¥ (${lead.channel})\n${lead.notes}`, created: today(), role: lead.role, archived: false };
    setDeals([...deals, nd]);
    setLeads(leads.map((l) => l.id === lead.id ? { ...l, status: "converted" } : l));
    addLog("ğŸ¯", "BD è½‰å…¥æ¼æ–—", `${lead.name} â†’ ${lead.company} å°ˆæ¡ˆ`, C.violet);
  };

  const addRole = (r) => { setRoles([...roles, { ...r, id: `role_${nRole.current++}`, archived: false }]); setModal(null); addLog("ğŸ‘¥", "æ–°å¢è§’è‰²", r.name, C.violet); };
  const updateRole = (r) => { setRoles(roles.map((x) => x.id === r.id ? r : x)); setModal(null); setEditItem(null); addLog("âœï¸", "ç·¨è¼¯è§’è‰²", r.name, C.accent); };

  // â”€â”€ CSV Export â”€â”€
  const doExportDeals = () => {
    const headers = ["æ¡ˆä»¶åç¨±", "å…¬å¸", "è¯ç¹«äºº", "Email", "éšæ®µ", "é‡‘é¡", "æ–¹æ¡ˆ", "å»ºç«‹æ—¥æœŸ", "ç°½ç´„æ—¥æœŸ", "å‚™è¨»"];
    const rows = deals.filter((d) => !d.archived).map((d) => [d.name, d.company, d.contact, d.email, stageOf(d.stage)?.label || d.stage, d.value, d.tier, d.created, d.signedDate || "", d.notes]);
    exportCSV("beyond-spec-deals.csv", headers, rows);
    addLog("â¬‡", "åŒ¯å‡ºæ¡ˆä»¶ CSV", `${rows.length} ç­†`, C.gold);
  };
  const doExportTasks = () => {
    const headers = ["ä»»å‹™", "ç‹€æ…‹", "å„ªå…ˆç´š", "è² è²¬è§’è‰²", "æˆªæ­¢æ—¥æœŸ"];
    const rows = tasks.filter((t) => !t.archived).map((t) => [t.text, TASK_STATUS.find((s) => s.id === t.status)?.label || t.status, PRIORITY.find((p) => p.id === t.priority)?.label || t.priority, roles.find((r) => r.id === t.role)?.name || t.role, t.due]);
    exportCSV("beyond-spec-tasks.csv", headers, rows);
    addLog("â¬‡", "åŒ¯å‡ºä»»å‹™ CSV", `${rows.length} ç­†`, C.gold);
  };
  const doExportLeads = () => {
    const headers = ["å§“å", "è·ç¨±", "å…¬å¸", "ç®¡é“", "ç‹€æ…‹", "å‚™è¨»", "æœ€å¾Œäº’å‹•"];
    const rows = leads.filter((l) => !l.archived).map((l) => [l.name, l.title, l.company, l.channel, BD_STATUS.find((s) => s.id === l.status)?.label || l.status, l.notes, l.lastTouch]);
    exportCSV("beyond-spec-bd-leads.csv", headers, rows);
    addLog("â¬‡", "åŒ¯å‡º BD å°è±¡ CSV", `${rows.length} ç­†`, C.gold);
  };

  // â”€â”€ Command Palette Actions â”€â”€
  const handleCommand = (cmdId) => {
    const goMap = { goToPipeline: "pipeline", goToTasks: "tasks", goToBD: "bd", goToAnalytics: "analytics", goToDocs: "docs", goToRoles: "roles" };
    if (goMap[cmdId]) { setTab(goMap[cmdId]); return; }
    if (cmdId === "addDeal") setModal("addDeal");
    else if (cmdId === "addTask") setModal("addTask");
    else if (cmdId === "addLead") setModal("addLead");
    else if (cmdId === "addRole") setModal("addRole");
    else if (cmdId === "exportDeals") doExportDeals();
    else if (cmdId === "exportTasks") doExportTasks();
    else if (cmdId === "exportLeads") doExportLeads();
  };

  const activeRoles = roles.filter((r) => !r.archived);
  const now = new Date().toLocaleDateString("zh-TW", { year: "numeric", month: "long", day: "numeric", weekday: mobile ? undefined : "long" });

  const TABS = [
    { id: "pipeline", label: mobile ? "ğŸ“Š æ¼æ–—" : "ğŸ“Š æ¥­å‹™æ¼æ–—" },
    { id: "tasks", label: mobile ? "ğŸ“‹ ä»»å‹™" : "ğŸ“‹ ä»»å‹™çœ‹æ¿" },
    { id: "bd", label: mobile ? "ğŸ¯ BD" : "ğŸ¯ BD é–‹ç™¼" },
    { id: "analytics", label: mobile ? "ğŸ“ˆ åˆ†æ" : "ğŸ“ˆ æ•¸æ“šåˆ†æ" },
    { id: "docs", label: mobile ? "ğŸ“ æ–‡ä»¶" : "ğŸ“ æ–‡ä»¶è³‡æº" },
    { id: "roles", label: mobile ? "ğŸ‘¥ è§’è‰²" : "ğŸ‘¥ è§’è‰²ç®¡ç†" },
  ];

  const TASK_FILTERS = [
    { id: "all", label: "å…¨éƒ¨", color: C.accent },
    { id: "high", label: "ğŸ”´ é«˜å„ªå…ˆ", color: C.rose },
    { id: "overdue", label: "âš ï¸ é€¾æœŸ", color: C.orange },
    ...activeRoles.map((r) => ({ id: r.id, label: `${r.emoji} ${r.name}`, color: r.color })),
  ];

  return (
    <div style={{ minHeight: "100vh", display: "flex", flexDirection: "column", background: C.bg, color: C.ink, fontFamily: "'Noto Sans TC',-apple-system,sans-serif", fontSize: 15 }}>
      <style>{`@keyframes fadeSlideIn{from{opacity:0;transform:translateY(-8px)}to{opacity:1;transform:translateY(0)}}@keyframes drawerSlideIn{from{transform:translateX(100%)}to{transform:translateX(0)}}@keyframes drawerFadeIn{from{opacity:0}to{opacity:1}}*{scrollbar-width:thin;scrollbar-color:rgba(255,255,255,.12) transparent}::-webkit-scrollbar{width:5px;height:5px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:rgba(255,255,255,.12);border-radius:99px}::-webkit-scrollbar-thumb:hover{background:rgba(255,255,255,.25)}`}</style>
      {/* Header */}
      <div style={{ borderBottom: `1px solid ${C.border}`, padding: mobile ? "14px 18px" : "16px 36px", display: "flex", justifyContent: "space-between", alignItems: "center", background: `${C.surface}80`, backdropFilter: "blur(12px)", position: "sticky", top: 0, zIndex: 100 }}>
        <div style={{ display: "flex", alignItems: "center", gap: mobile ? 12 : 16 }}>
          <span style={{ fontSize: mobile ? 22 : 26 }}>ğŸ°</span>
          <div>
            <div style={{ fontSize: mobile ? 15 : 18, fontWeight: 800, letterSpacing: ".02em" }}>ç§»å‹•åŸå ¡æŒ‡æ®éƒ¨</div>
            {!mobile && <div style={{ fontSize: 12, color: C.inkMuted, marginTop: 2 }}>Beyond Spec æ¥­å‹™ç®¡ç†ç³»çµ±</div>}
          </div>
        </div>
        <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
          {!mobile && <span style={{ fontSize: 13, color: C.inkMuted }}>{now}</span>}
          {/* Cmd+K button */}
          <button onClick={() => setCmdOpen(true)} title="æŒ‡ä»¤é¢æ¿ (âŒ˜K)"
            style={{ display: "flex", alignItems: "center", gap: 6, padding: "5px 12px", borderRadius: 10, border: `1px solid ${C.border}`, background: "transparent", color: C.inkMuted, fontSize: 12, cursor: "pointer", fontFamily: "inherit", transition: T }}>
            ğŸ” {!mobile && "æŒ‡ä»¤"} <span style={{ fontSize: 10, background: C.surface, padding: "1px 5px", borderRadius: 4, fontFamily: "monospace" }}>âŒ˜K</span>
          </button>
          {/* Export button */}
          {(tab === "pipeline" || tab === "tasks" || tab === "bd") && (
            <button onClick={() => { if (tab === "pipeline") doExportDeals(); else if (tab === "tasks") doExportTasks(); else doExportLeads(); }}
              title="åŒ¯å‡º CSV"
              style={{ width: 34, height: 34, borderRadius: 10, border: `1px solid ${C.border}`, background: "transparent", color: C.inkMuted, cursor: "pointer", fontSize: 14, display: "flex", alignItems: "center", justifyContent: "center", transition: T }}>â¬‡</button>
          )}
          {/* Activity log button */}
          <button onClick={() => setLogOpen(true)} title="æ´»å‹•ç´€éŒ„"
            style={{ position: "relative", width: 34, height: 34, borderRadius: 10, border: `1px solid ${C.border}`, background: "transparent", color: C.inkMuted, cursor: "pointer", fontSize: 14, display: "flex", alignItems: "center", justifyContent: "center", transition: T }}>
            ğŸ“œ
            {activityLog.length > 0 && <span style={{ position: "absolute", top: -2, right: -2, width: 8, height: 8, borderRadius: "50%", background: C.accent }} />}
          </button>
          {/* Overdue badge */}
          {(() => { const overdue = tasks.filter((t) => !t.archived && t.status !== "done" && t.due < today()).length; return overdue > 0 ? (
            <button onClick={() => { setTab("tasks"); setTaskFilter("overdue"); }} title={`${overdue} å€‹é€¾æœŸä»»å‹™`}
              style={{ position: "relative", width: 34, height: 34, borderRadius: 10, border: `1px solid ${C.rose}30`, background: `${C.rose}10`, color: C.rose, cursor: "pointer", fontSize: 14, display: "flex", alignItems: "center", justifyContent: "center", transition: T, fontFamily: "inherit" }}>
              âš ï¸<span style={{ position: "absolute", top: -4, right: -4, background: C.rose, color: "#fff", fontSize: 10, fontWeight: 700, minWidth: 16, height: 16, borderRadius: 8, display: "flex", alignItems: "center", justifyContent: "center", padding: "0 4px" }}>{overdue}</span>
            </button>
          ) : null; })()}
          {/* Cloud sync button */}
          {user && API_URL && (
            <button onClick={syncToCloud} title={syncing ? "åŒæ­¥ä¸­..." : "åŒæ­¥åˆ°é›²ç«¯"}
              style={{ width: 34, height: 34, borderRadius: 10, border: `1px solid ${C.border}`, background: syncing ? `${C.emerald}15` : "transparent", color: syncing ? C.emerald : C.inkMuted, cursor: "pointer", fontSize: 14, display: "flex", alignItems: "center", justifyContent: "center", transition: T, fontFamily: "inherit" }}>
              {syncing ? "â³" : "â˜ï¸"}
            </button>
          )}
          {/* User avatar or login */}
          {user ? (
            <button onClick={handleLogout} title={`${user.name}\né»æ“Šç™»å‡º`}
              style={{ width: 34, height: 34, borderRadius: 10, overflow: "hidden", border: `2px solid ${C.accent}`, cursor: "pointer", padding: 0 }}>
              {user.picture ? <img src={user.picture} alt="" style={{ width: "100%", height: "100%", objectFit: "cover" }} /> : <span style={{ fontSize: 15 }}>ğŸ‘‘</span>}
            </button>
          ) : GOOGLE_CLIENT_ID ? (
            <div id="g_id_signin" style={{ borderRadius: 10, overflow: "hidden" }}></div>
          ) : (
            <div style={{ width: 34, height: 34, borderRadius: 10, background: C.accentSoft, display: "flex", alignItems: "center", justifyContent: "center", fontSize: 15 }}>ğŸ‘‘</div>
          )}
        </div>
      </div>

      {/* â”€â”€ Remove maxWidth for full-width layout â”€â”€ */}
      <div style={{ padding: mobile ? "20px 18px" : "28px 36px", flex: 1 }}>
        <StatsRow deals={deals} tasks={tasks} leads={leads} onHealthClick={() => { setTab("tasks"); setTaskFilter("overdue"); }} />

        {/* Tab bar */}
        <div style={{ display: "flex", flexDirection: mobile ? "column" : "row", justifyContent: "space-between", alignItems: mobile ? "stretch" : "center", gap: mobile ? 12 : 0, marginBottom: 20 }}>
          <div style={{ display: "flex", gap: 4, background: C.surface, borderRadius: 12, padding: 4, overflowX: "auto" }}>
            {TABS.map((t) => (
              <button key={t.id} onClick={() => { setTab(t.id); setExpandedDealId(null); setTaskSearch(""); setTaskFilter("all"); }}
                style={{ padding: mobile ? "8px 14px" : "9px 20px", borderRadius: 10, border: "none", cursor: "pointer", fontSize: 14, fontWeight: 600, fontFamily: "inherit", background: tab === t.id ? C.card : "transparent", color: tab === t.id ? C.ink : C.inkMuted, whiteSpace: "nowrap", flex: mobile ? 1 : "none", transition: T }}>
                {t.label}
              </button>
            ))}
          </div>
          <div style={{ display: "flex", gap: 10 }}>
            {tab === "pipeline" && <Btn color={C.emerald} onClick={() => setModal("addDeal")} full={mobile}>+ æ–°å¢æ¡ˆä»¶</Btn>}
            {tab === "tasks" && <Btn color={C.accent} onClick={() => setModal("addTask")} full={mobile}>+ æ–°å¢ä»»å‹™</Btn>}
            {tab === "bd" && <Btn color={C.cyan} onClick={() => setModal("addLead")} full={mobile}>+ æ–°å¢ BD å°è±¡</Btn>}
            {tab === "docs" && <Btn color={C.gold} onClick={() => window.open("/templates/", "_blank")} full={mobile}>ğŸ“‚ é–‹å•Ÿæ–‡ä»¶åº«</Btn>}
            {tab === "roles" && <Btn color={C.violet} onClick={() => setModal("addRole")} full={mobile}>+ æ–°å¢è§’è‰²</Btn>}
          </div>
        </div>

        {/* Task sub-bar: search + filters */}
        {tab === "tasks" && (
          <div style={{ display: "flex", flexDirection: mobile ? "column" : "row", gap: 12, marginBottom: 20 }}>
            <SearchBar value={taskSearch} onChange={setTaskSearch} placeholder="æœå°‹ä»»å‹™..." />
            <FilterPills options={TASK_FILTERS} active={taskFilter} onSelect={setTaskFilter} />
          </div>
        )}

        {/* Content */}
        {tab === "pipeline" && <PipelineView deals={deals} roles={activeRoles} onArchive={archiveDeal} onUpdate={updateDeal} onStageChange={changeStage} expandedId={expandedDealId} onExpand={setExpandedDealId} />}
        {tab === "tasks" && <TasksView tasks={tasks} deals={deals.filter((d) => !d.archived)} roles={activeRoles} onEdit={(t) => { setEditItem(t); setModal("editTask"); }} onArchive={archiveTask} onStatusChange={changeTaskStatus} search={taskSearch} filter={taskFilter} />}
        {tab === "bd" && <BDTrackerView leads={leads} roles={activeRoles} onEdit={(l) => { setEditItem(l); setModal("editLead"); }} onArchive={archiveLead} onConvert={convertLead} />}
        {tab === "analytics" && <AnalyticsView deals={deals} roles={roles} goals={goals} onGoalsChange={setGoals} />}
        {tab === "docs" && <DocumentsView />}
        {tab === "roles" && <RolesView roles={roles} onAdd={() => setModal("addRole")} onEdit={(r) => { setEditItem(r); setModal("editRole"); }} onArchive={archiveRole} />}
      </div>

      {/* Modals */}
      {modal === "addDeal" && <Modal title="æ–°å¢æ¡ˆä»¶" onClose={() => setModal(null)}><DealForm roles={activeRoles} onSave={addDeal} onCancel={() => setModal(null)} /></Modal>}
      {modal === "editDeal" && editItem && <Modal title="ç·¨è¼¯æ¡ˆä»¶" onClose={() => { setModal(null); setEditItem(null); }}><DealForm deal={editItem} roles={activeRoles} onSave={updateDeal} onCancel={() => { setModal(null); setEditItem(null); }} /></Modal>}
      {modal === "addTask" && <Modal title="æ–°å¢ä»»å‹™" onClose={() => setModal(null)}><TaskForm deals={deals.filter((d) => !d.archived)} roles={activeRoles} onSave={addTask} onCancel={() => setModal(null)} /></Modal>}
      {modal === "editTask" && editItem && <Modal title="ç·¨è¼¯ä»»å‹™" onClose={() => { setModal(null); setEditItem(null); }}><TaskForm task={editItem} deals={deals.filter((d) => !d.archived)} roles={activeRoles} onSave={updateTask} onCancel={() => { setModal(null); setEditItem(null); }} /></Modal>}
      {modal === "addLead" && <Modal title="æ–°å¢ BD å°è±¡" onClose={() => setModal(null)}><LeadForm roles={activeRoles} onSave={addLead} onCancel={() => setModal(null)} /></Modal>}
      {modal === "editLead" && editItem && <Modal title="ç·¨è¼¯ BD å°è±¡" onClose={() => { setModal(null); setEditItem(null); }}><LeadForm lead={editItem} roles={activeRoles} onSave={updateLead} onCancel={() => { setModal(null); setEditItem(null); }} /></Modal>}
      {modal === "addRole" && <Modal title="æ–°å¢è§’è‰²" onClose={() => setModal(null)}><RoleForm onSave={addRole} onCancel={() => setModal(null)} /></Modal>}
      {modal === "editRole" && editItem && <Modal title="ç·¨è¼¯è§’è‰²" onClose={() => { setModal(null); setEditItem(null); }}><RoleForm role={editItem} onSave={updateRole} onCancel={() => { setModal(null); setEditItem(null); }} /></Modal>}

      {/* Confirm Modal */}
      {confirmAction && <ConfirmModal title={confirmAction.title} message={confirmAction.message} onConfirm={confirmAction.onConfirm} onCancel={() => setConfirmAction(null)} danger />}

      {/* Undo Toast */}
      {toast && <UndoToast message={toast.message} onUndo={() => { toast.undo(); setToast(null); }} onDismiss={() => setToast(null)} />}

      {/* Command Palette */}
      <CommandPalette open={cmdOpen} onClose={() => setCmdOpen(false)} onAction={handleCommand} />

      {/* Activity Log Sidebar */}
      <ActivityLog log={activityLog} open={logOpen} onClose={() => setLogOpen(false)} />

      {/* Footer â€” pushed to bottom */}
      <div style={{ borderTop: `1px solid ${C.border}`, padding: mobile ? "14px 18px" : "18px 36px", textAlign: "center", marginTop: "auto" }}>
        <span style={{ fontSize: 12, color: C.inkMuted }}>ğŸ° ç§»å‹•åŸå ¡æŒ‡æ®éƒ¨ v5.4 â€” è¦æ ¼å¤–å·¥ä½œå®¤ Beyond Spec</span>
      </div>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<CastleDashboard />);
</script>
</body>
</html>
